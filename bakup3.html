<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory Book - Complete Accounting</title>

    <!-- Premium Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Firebase SDK -->
    <script>
        (function () {
            function safeDefine(name, fn) {
                if (typeof window[name] !== 'function') {
                    window[name] = fn;
                }
            }
            safeDefine('switchMainTab', function (tabId, btn) {
                try {
                    document.querySelectorAll('.tab-content').forEach(function (el) { el.classList.remove('active'); });
                    var el = document.getElementById(tabId);
                    if (el) el.classList.add('active');
                    document.querySelectorAll('.sidebar .menu-item').forEach(function (mi) { mi.classList.remove('active'); });
                    if (btn && btn.classList) btn.classList.add('active');
                    try { localStorage.setItem('activeMainTab', tabId); } catch (e) { }

                    // Trigger render functions for specific tabs
                    if (tabId === 'production-entry' && typeof renderProductionEntryTab === 'function') {
                        renderProductionEntryTab();
                    } else if (tabId === 'packing' && typeof renderPackingTab === 'function') {
                        renderPackingTab();
                    } else if (tabId === 'inventory' && typeof renderInventoryTab === 'function') {
                        renderInventoryTab();
                    } else if (tabId === 'size-control' && typeof renderSizeControlTab === 'function') {
                        renderSizeControlTab();
                    }
                } catch (e) { alert('Error: ' + e); }
            });
            safeDefine('switchSalesSubtab', function (subId, btn) {
                try {
                    document.querySelectorAll('#sales .subtab-content').forEach(function (el) { el.classList.remove('active'); });
                    var el = document.getElementById(subId);
                    if (el) el.classList.add('active');
                    document.querySelectorAll('#sales .subtab-btn').forEach(function (b) { b.classList.remove('active'); });
                    if (btn && btn.classList) btn.classList.add('active');
                    try { localStorage.setItem('activeSalesSubtab', subId); } catch (e) { }
                } catch (e) { alert('Error: ' + e); }
            });
            safeDefine('switchPurchaseSubtab', function (subId, btn) {
                try {
                    document.querySelectorAll('#purchase .subtab-content').forEach(function (el) { el.classList.remove('active'); });
                    var el = document.getElementById(subId);
                    if (el) el.classList.add('active');
                    document.querySelectorAll('#purchase .subtab-btn').forEach(function (b) { b.classList.remove('active'); });
                    if (btn && btn.classList) btn.classList.add('active');
                    try { localStorage.setItem('activePurchaseSubtab', subId); } catch (e) { }
                } catch (e) { alert('Error: ' + e); }
            });
        })();
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* === PREMIUM CORE STYLES === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #d4af37 0%, #f4e5a1 50%, #d4af37 100%);
            --secondary-gradient: linear-gradient(135deg, #8b0000 0%, #dc143c 50%, #ff4500 100%);
            --accent-gradient: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #2d2d2d 100%);
            --dark-gradient: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            --gold-gradient: linear-gradient(135deg, #c9a227 0%, #ffd700 25%, #ffed4e 50%, #ffd700 75%, #c9a227 100%);
            --crimson-gradient: linear-gradient(135deg, #660000 0%, #b22222 50%, #dc143c 100%);
            --platinum-gradient: linear-gradient(135deg, #e5e4e2 0%, #ffffff 50%, #e5e4e2 100%);
            --surface-white: #ffffff;
            --surface-glass: rgba(255, 255, 255, 0.95);
            --surface-dark: #0f0f0f;
            --text-primary: #0a0a0a;
            --text-secondary: #4a4a4a;
            --text-light: #8a8a8a;
            --text-gold: #d4af37;
            --text-crimson: #dc143c;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.25);
            --shadow-gold: 0 8px 32px rgba(212, 175, 55, 0.4);
            --shadow-crimson: 0 8px 32px rgba(220, 20, 60, 0.4);
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 24px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
            color: var(--text-primary);
            line-height: 1.7;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 20%, rgba(212, 175, 55, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(220, 20, 60, 0.12) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.08) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(212, 175, 55, 0.03) 2px, rgba(212, 175, 55, 0.03) 4px);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Premium Sidebar */
        .sidebar {
            width: 280px;
            background: var(--dark-gradient);
            color: #ffffff;
            padding: 32px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl), inset 0 0 80px rgba(212, 175, 55, 0.1);
            position: relative;
            backdrop-filter: blur(10px);
            border-right: 3px solid rgba(212, 175, 55, 0.3);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                linear-gradient(180deg, rgba(212, 175, 55, 0.15) 0%, transparent 50%),
                linear-gradient(0deg, rgba(220, 20, 60, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .sidebar h1 {
            font-size: 26px;
            margin-bottom: 40px;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            padding-bottom: 16px;
            letter-spacing: 1.5px;
            font-weight: 900;
            position: relative;
            z-index: 1;
            border-bottom: 3px solid;
            border-image: var(--gold-gradient) 1;
            text-transform: uppercase;
            text-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
            animation: shimmerGold 3s infinite;
        }

        @keyframes shimmerGold {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.3);
            }
        }

        .sidebar button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 16px 20px;
            margin: 6px 0;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid transparent;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            text-align: left;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        .sidebar button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.2) 0%, rgba(255, 215, 0, 0.3) 100%);
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }

        .sidebar button:hover {
            color: #ffd700;
            transform: translateX(8px);
            border-color: rgba(212, 175, 55, 0.5);
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }

        .sidebar button:hover::before {
            width: 100%;
        }

        .sidebar button.active {
            background: var(--gold-gradient);
            color: #000000;
            font-weight: 900;
            box-shadow: var(--shadow-gold);
            border-color: rgba(212, 175, 55, 0.6);
            transform: translateX(4px);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .sidebar button.active::before {
            width: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(212, 175, 55, 0.2) 100%);
        }

        /* Premium Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(245, 245, 245, 0.98) 100%);
            position: relative;
            box-shadow: inset 0 0 100px rgba(212, 175, 55, 0.08);
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Premium Typography */
        h2 {
            font-size: 36px;
            margin-bottom: 32px;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
            letter-spacing: 1px;
            position: relative;
            display: inline-block;
            text-transform: uppercase;
            text-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
            animation: shimmerGold 3s infinite;
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 80px;
            height: 5px;
            background: var(--gold-gradient);
            border-radius: 3px;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.5);
        }

        h3 {
            font-size: 22px;
            margin: 32px 0 16px 0;
            background: var(--crimson-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            padding-left: 16px;
            border-left: 5px solid;
            border-image: var(--crimson-gradient) 1;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* Premium Form Elements */
        input,
        select,
        textarea {
            padding: 14px 16px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: var(--border-radius-md);
            font-size: 15px;
            margin: 6px 0;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--surface-white);
            color: var(--text-primary);
            font-weight: 600;
            box-shadow: var(--shadow-sm), inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #d4af37;
            outline: none;
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.2), var(--shadow-gold);
            transform: translateY(-2px);
            background: linear-gradient(135deg, #ffffff 0%, #fffef8 100%);
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--text-light);
            font-weight: 500;
            font-style: italic;
        }

        /* Premium Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        button {
            padding: 16px 32px;
            background: var(--gold-gradient);
            color: #000000;
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 15px;
            font-weight: 900;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-gold);
            position: relative;
            overflow: hidden;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            transition: left 0.6s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(212, 175, 55, 0.6);
            border-color: rgba(255, 215, 0, 0.8);
        }

        button:active {
            transform: translateY(-1px) scale(1);
            box-shadow: var(--shadow-gold);
        }

        button.danger {
            background: var(--crimson-gradient);
            color: white;
            border-color: rgba(220, 20, 60, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        button.danger:hover {
            box-shadow: var(--shadow-crimson);
            border-color: rgba(220, 20, 60, 0.8);
        }

        button.success {
            background: linear-gradient(135deg, #0f7c0f 0%, #15a515 50%, #0f7c0f 100%);
            color: white;
            border-color: rgba(21, 165, 21, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        button.success:hover {
            box-shadow: 0 12px 40px rgba(21, 165, 21, 0.5);
            border-color: rgba(21, 165, 21, 0.8);
        }

        /* Premium Subtabs */
        .subtabs {
            display: flex;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            border-radius: var(--border-radius-lg);
            padding: 10px;
            margin-bottom: 32px;
            gap: 10px;
            box-shadow: var(--shadow-xl);
            border: 3px solid rgba(212, 175, 55, 0.4);
        }

        .subtab-btn {
            padding: 14px 28px;
            background: transparent;
            border: 2px solid rgba(212, 175, 55, 0.2);
            cursor: pointer;
            color: rgba(212, 175, 55, 0.7);
            font-weight: 800;
            border-radius: var(--border-radius-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            position: relative;
            letter-spacing: 1.2px;
            text-transform: uppercase;
        }

        .subtab-btn:hover {
            color: #ffd700;
            background: rgba(212, 175, 55, 0.15);
            transform: translateY(-2px);
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .subtab-btn.active {
            background: var(--gold-gradient);
            color: #000000;
            box-shadow: var(--shadow-gold);
            border-color: rgba(255, 215, 0, 0.6);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }

        .subtab-content {
            display: none;
            padding-top: 24px;
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .subtab-content.active {
            display: block;
        }

        /* Premium Tables & Grids */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 24px 0;
            background: var(--surface-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 3px solid rgba(212, 175, 55, 0.3);
        }

        table th {
            background: var(--dark-gradient);
            color: #ffd700;
            padding: 20px 24px;
            text-align: left;
            font-weight: 900;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-bottom: 4px solid;
            border-image: var(--gold-gradient) 1;
            text-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
        }

        table td {
            padding: 18px 24px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.15);
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .line-items-table {
            overflow: visible;
            /* Allow size dropdowns to render outside the table */
            position: relative;
            z-index: 2;
            /* Keep dropdowns above nearby buttons */
        }

        .line-items-table tbody,
        .line-items-table tr {
            overflow: visible;
            position: relative;
        }

        .line-items-table .autocomplete-dropdown {
            z-index: 10000;
            /* Layer above table backgrounds and action buttons */
            pointer-events: auto;
        }

        .line-items-table td {
            position: relative;
            /* Ensure positioned stacking roots for dropdown */
            overflow: visible;
        }

        .line-items-table .autocomplete-wrapper {
            position: relative;
            z-index: 5;
        }

        table tr:last-child td {
            border-bottom: none;
        }

        table tr:hover {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.08) 0%, rgba(220, 20, 60, 0.05) 100%);
            transform: scale(1.005);
            box-shadow: inset 0 0 20px rgba(212, 175, 55, 0.1);
        }

        table tbody tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid transparent;
        }

        table tbody tr:hover {
            border-left-color: rgba(212, 175, 55, 0.5);
        }

        /* Premium Utility Layout */
        .form-row {
            display: flex;
            gap: 24px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 220px;
        }

        .form-group label {
            display: block;
            font-weight: 700;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: 0.2px;
        }

        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
        }

        .totals-box {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            padding: 40px;
            border-radius: var(--border-radius-lg);
            margin: 32px 0;
            display: flex;
            justify-content: flex-end;
            gap: 60px;
            box-shadow: var(--shadow-xl), inset 0 0 100px rgba(212, 175, 55, 0.15);
            border: 4px solid;
            border-image: var(--gold-gradient) 1;
            position: relative;
            overflow: hidden;
        }

        .totals-box::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 8px;
            height: 100%;
            background: var(--crimson-gradient);
            box-shadow: 0 0 20px rgba(220, 20, 60, 0.6);
        }

        .total-item {
            text-align: right;
            padding: 16px 20px;
            border-radius: var(--border-radius-md);
            transition: all 0.3s ease;
            border: 2px solid rgba(212, 175, 55, 0.2);
        }

        .total-item:hover {
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-4px) scale(1.05);
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
        }

        .total-item label {
            font-size: 11px;
            color: rgba(212, 175, 55, 0.8);
            text-transform: uppercase;
            display: block;
            font-weight: 800;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .total-item .amount {
            font-size: 32px;
            font-weight: 900;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
            animation: shimmerGold 3s infinite;
        }

        /* Premium Autocomplete */
        .autocomplete-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface-white);
            border: 3px solid #d4af37;
            border-top: none;
            border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: var(--shadow-gold);
            display: none;
            margin-top: -2px;
        }

        .autocomplete-dropdown.active {
            display: block;
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .autocomplete-item {
            padding: 14px 16px;
            cursor: pointer;
            border-bottom: 2px solid rgba(212, 175, 55, 0.15);
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text-primary);
        }

        .autocomplete-item:hover {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.15) 0%, rgba(220, 20, 60, 0.08) 100%);
            color: #d4af37;
            padding-left: 24px;
            border-left: 4px solid #d4af37;
            font-weight: 700;
        }

        /* === PREMIUM DASHBOARD & REPORT STYLES === */
        .godfather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 28px;
            margin-bottom: 32px;
        }

        .godfather-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(250, 250, 250, 0.98) 100%);
            padding: 32px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            border: 3px solid rgba(212, 175, 55, 0.4);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .godfather-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(220, 20, 60, 0.08) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .godfather-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: var(--shadow-gold);
            border-color: #ffd700;
        }

        .godfather-card:hover::before {
            opacity: 1;
        }

        .godfather-card h4 {
            margin: 0 0 20px 0;
            color: rgba(212, 175, 55, 0.9);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2.5px;
            font-weight: 900;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 3px rgba(212, 175, 55, 0.2);
        }

        .godfather-card .metric {
            font-size: 42px;
            font-weight: 900;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
            letter-spacing: -1.5px;
            text-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
            animation: shimmerGold 3s infinite;
        }

        .godfather-card .sub-metric {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 700;
            position: relative;
            z-index: 1;
            letter-spacing: 0.5px;
        }

        .godfather-card.critical {
            border-left: 8px solid #dc143c;
            box-shadow: var(--shadow-crimson);
        }

        .godfather-card.critical .metric {
            background: var(--crimson-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .godfather-card.warning {
            border-left: 8px solid #ff8c00;
            box-shadow: 0 8px 32px rgba(255, 140, 0, 0.4);
        }

        .godfather-card.warning .metric {
            background: linear-gradient(135deg, #ff8c00 0%, #ffa500 50%, #ff8c00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .godfather-card.success {
            border-left: 8px solid #228b22;
            box-shadow: 0 8px 32px rgba(34, 139, 34, 0.4);
        }

        .godfather-card.success .metric {
            background: linear-gradient(135deg, #228b22 0%, #32cd32 50%, #228b22 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .action-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .action-badge:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .badge-critical {
            background: var(--crimson-gradient);
            color: white;
            border: 2px solid rgba(220, 20, 60, 0.6);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .badge-warning {
            background: linear-gradient(135deg, #ff8c00 0%, #ffa500 100%);
            color: white;
            border: 2px solid rgba(255, 140, 0, 0.6);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .badge-ok {
            background: linear-gradient(135deg, #228b22 0%, #32cd32 100%);
            color: white;
            border: 2px solid rgba(34, 139, 34, 0.6);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .chart-container {
            background: var(--surface-white);
            padding: 36px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            margin-bottom: 32px;
            border: 3px solid rgba(212, 175, 55, 0.3);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gold-gradient);
        }

        .chart-container:hover {
            box-shadow: var(--shadow-gold);
            transform: translateY(-6px);
            border-color: rgba(212, 175, 55, 0.6);
        }

        .insight-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .insight-grid {
                grid-template-columns: 1fr;
            }
        }

        .list-widget {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .list-widget li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.3s ease;
        }

        .list-widget li:hover {
            padding-left: 12px;
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.05) 0%, transparent 100%);
        }

        .list-widget .label {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 15px;
        }

        .list-widget .value {
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 16px;
        }

        /* Highlight classes for search results (kept from original app) */
        .highlight-row {
            background-color: #fff8c6;
        }

        .highlight-cell {
            background-color: #fff8c6;
        }

        /* Premium Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface-white);
            margin: auto;
            padding: 40px;
            border-radius: var(--border-radius-xl);
            width: 90%;
            max-width: 850px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 2px solid rgba(255, 255, 255, 0.2);
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-close {
            float: right;
            font-size: 32px;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.3s ease;
            line-height: 1;
            font-weight: 300;
        }

        .modal-close:hover {
            color: #ef4444;
            transform: rotate(90deg);
        }

        /* Premium Connection Status */
        .connection-status {
            position: fixed;
            top: 24px;
            right: 32px;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 900;
            z-index: 2000;
            color: #000000;
            box-shadow: var(--shadow-gold);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(212, 175, 55, 0.6);
            letter-spacing: 1.5px;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .connection-status:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.8);
        }

        .connection-status.connected {
            background: var(--gold-gradient);
            animation: pulseGold 2s infinite;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .connection-status.disconnected {
            background: var(--crimson-gradient);
            color: white;
            border-color: rgba(220, 20, 60, 0.6);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .pending-badge {
            position: fixed;
            top: 76px;
            right: 32px;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.95);
            color: #0f172a;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0, 0, 0, 0.06);
            z-index: 2000;
            display: none;
        }

        .perf-toggle {
            position: fixed;
            top: 120px;
            right: 32px;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 800;
            background: rgba(0, 0, 0, 0.75);
            color: #f6f6f6;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: var(--shadow-md);
            z-index: 2000;
            letter-spacing: 0.5px;
        }

        body.performance-mode,
        body.performance-mode * {
            animation: none !important;
            transition: none !important;
        }

        body.performance-mode::before,
        body.performance-mode::after {
            display: none;
        }

        body.performance-mode .sidebar h1,
        body.performance-mode h2,
        body.performance-mode h3 {
            text-shadow: none !important;
        }

        body.performance-mode .sidebar,
        body.performance-mode .main-content,
        body.performance-mode table,
        body.performance-mode button,
        body.performance-mode .card,
        body.performance-mode .insight-card {
            box-shadow: none !important;
        }

        body.performance-mode .subtab-btn,
        body.performance-mode .tab-button,
        body.performance-mode .prod-action-btn {
            transform: none !important;
        }

        /* Toast Notifications */
        #toast {
            position: fixed;
            bottom: 28px;
            right: 28px;
            min-width: 260px;
            max-width: 420px;
            background: var(--surface-white);
            color: #111827;
            padding: 14px 16px;
            border-radius: 14px;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.06);
            z-index: 2400;
            display: none;
            opacity: 0;
            transition: opacity 0.25s ease, transform 0.25s ease;
            transform: translateY(12px);
            font-weight: 600;
            letter-spacing: 0.2px;
        }

        #toast.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        #toast.success {
            border-color: rgba(16, 185, 129, 0.25);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.02));
        }

        #toast.error {
            border-color: rgba(239, 68, 68, 0.25);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.03));
        }

        #toast.warning {
            border-color: rgba(234, 179, 8, 0.25);
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(234, 179, 8, 0.03));
        }

        #toast.info {
            border-color: rgba(59, 130, 246, 0.25);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.02));
        }

        @keyframes pulseGold {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            }

            50% {
                box-shadow: 0 0 40px rgba(212, 175, 55, 0.9);
            }
        }

        /* Premium Scrollbar */
        ::-webkit-scrollbar {
            width: 14px;
            height: 14px;
        }

        ::-webkit-scrollbar-track {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gold-gradient);
            border-radius: 10px;
            border: 2px solid #0a0a0a;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #ffd700 0%, #c9a227 50%, #ffd700 100%);
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.6);
        }

        /* Section Titles */
        .section-title {
            font-size: 18px;
            font-weight: 800;
            color: var(--text-primary);
            margin: 24px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid;
            border-image: var(--primary-gradient) 1;
            letter-spacing: 0.3px;
        }

        /* Premium Report Filters */
        .report-filters {
            background: var(--surface-white);
            padding: 24px;
            border-radius: var(--border-radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: flex-end;
            border: 2px solid #f3f4f6;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .dashboard-card {
            background: var(--surface-white);
            padding: 28px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            border: 2px solid #f3f4f6;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
            border-color: #667eea;
        }

        .dashboard-card h4 {
            font-size: 14px;
            font-weight: 800;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 20px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 900;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 12px 0;
            letter-spacing: -1px;
        }

        /* Currency Formatting */
        .currency {
            font-variant-numeric: tabular-nums;
        }

        /* Bulk Actions */
        .bulk-actions {
            background: var(--surface-white);
            padding: 16px 20px;
            border-radius: var(--border-radius-md);
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 12px;
            border: 2px solid #f3f4f6;
        }

        .bulk-actions label {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 14px;
        }

        /* Invoice Search */
        .invoice-search {
            margin-bottom: 20px;
        }

        .invoice-search input {
            box-shadow: var(--shadow-md);
        }

        /* Premium Checkbox & Radio */
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        /* Loading Animation */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        .loading {
            animation: shimmer 2s infinite;
            background: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
            background-size: 1000px 100%;
        }

        /* Tooltip Enhancement */
        [title] {
            position: relative;
            cursor: help;
        }

        /* Focus Visible for Accessibility */
        *:focus-visible {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        /* Line Items Table Enhancement */
        .line-items-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            background: var(--surface-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            overflow: visible;
            /* Keep dropdowns visible */
            border: 2px solid #f3f4f6;
            position: relative;
            z-index: 2;
        }

        .line-items-table th {
            background: var(--dark-gradient);
            color: white;
            padding: 16px 12px;
            text-align: left;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .line-items-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .line-items-table input,
        .line-items-table select {
            margin: 0;
            font-size: 14px;
        }

        .line-items-table tbody tr:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 100%);
        }

        /* Enhanced Category Filter */
        #categoryTotalsSummary {
            background: var(--surface-white);
            padding: 20px;
            border-radius: var(--border-radius-lg);
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
            border: 2px solid #f3f4f6;
            font-weight: 600;
        }

        /* Premium floating effect */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* Glassmorphism effect for special cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Print */
        @media print {

            .sidebar,
            .no-print,
            .report-filters,
            .connection-status {
                display: none !important;
            }

            .main-content {
                margin: 0;
                padding: 0;
            }

            body::before {
                display: none;
            }
        }

        /* ============================================
   MOBILE RESPONSIVE DESIGN - FULLY OPTIMIZED
   ============================================ */

        /* Hamburger Menu Button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--gold-gradient);
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: 12px;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 24px;
            box-shadow: var(--shadow-gold);
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle:active {
            transform: scale(0.95);
        }

        /* Mobile Overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            backdrop-filter: blur(4px);
        }

        .mobile-overlay.active {
            display: block;
        }

        /* Tablet Responsive - 1024px and below */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: relative;
                padding: 20px;
            }

            .main-content {
                margin-left: 0;
                padding: 30px;
            }

            .godfather-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }

            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }

            table {
                font-size: 14px;
            }
        }

        /* Mobile Responsive - 768px and below */
        @media (max-width: 768px) {
            body {
                font-size: 15px;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .container {
                flex-direction: row;
            }

            .mobile-menu-toggle.open {
                left: calc(280px + 25px);
            }

            /* Sidebar Mobile Styles */
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                width: 280px;
                height: 100vh;
                overflow-y: auto;
                z-index: 1000;
                transition: left 0.3s ease;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
                padding: 80px 20px 20px 20px;
            }

            .sidebar.active {
                left: 0;
            }

            .sidebar h1 {
                font-size: 24px;
                margin-bottom: 30px;
                text-align: center;
            }

            .sidebar button {
                font-size: 15px;
                padding: 14px 20px;
                margin-bottom: 12px;
            }

            /* Main Content Mobile */
            .main-content {
                margin-left: 0;
                padding: 80px 15px 20px 15px;
                width: 100%;
            }

            /* Typography Mobile */
            h2 {
                font-size: 22px;
                margin-bottom: 20px;
            }

            h3 {
                font-size: 18px;
                margin-bottom: 15px;
            }

            /* Dashboard Grid Mobile */
            .godfather-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .godfather-card {
                padding: 20px;
            }

            .metric-label {
                font-size: 11px;
                letter-spacing: 1.5px;
            }

            .metric-value {
                font-size: 28px;
                margin: 10px 0;
            }

            .metric-change {
                font-size: 12px;
            }

            /* Forms Mobile */
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            input,
            select,
            textarea,
            .autocomplete-input {
                font-size: 16px !important;
                /* Prevents zoom on iOS */
                padding: 14px;
                border-radius: 10px;
            }

            .packing-layout {
                grid-template-columns: 1fr;
            }

            label {
                font-size: 13px;
                margin-bottom: 6px;
            }

            /* Buttons Mobile */
            .btn,
            button {
                font-size: 14px;
                padding: 14px 24px;
                border-radius: 10px;
                letter-spacing: 1px;
                width: 100%;
                margin-bottom: 10px;
            }

            .btn-small {
                padding: 8px 14px;
                font-size: 11px;
                width: auto;
                display: inline-block;
                margin: 2px;
            }

            /* Action Buttons Group */
            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 20px;
            }

            /* Tables Mobile - Card Style */
            table {
                display: block;
            }

            /* Machine Grid Styles */
            .machine-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 16px;
                margin-bottom: 24px;
            }

            .machine-card {
                background: var(--surface-white);
                border: 1px solid rgba(212, 175, 55, 0.3);
                border-radius: var(--border-radius-lg);
                padding: 16px;
                transition: all 0.3s ease;
                box-shadow: var(--shadow-sm);
            }

            .machine-card:hover {
                box-shadow: var(--shadow-gold);
                transform: translateY(-2px);
                border-color: rgba(212, 175, 55, 0.6);
            }

            .machine-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                padding-bottom: 8px;
            }

            .machine-name {
                font-size: 16px;
                font-weight: 800;
                color: var(--text-primary);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .machine-status {
                display: flex;
                gap: 12px;
                margin-bottom: 16px;
                background: rgba(0, 0, 0, 0.02);
                padding: 8px;
                border-radius: var(--border-radius-sm);
            }

            .status-radio {
                display: flex;
                align-items: center;
                gap: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
            }

            .status-radio input[type="radio"] {
                margin: 0;
                cursor: pointer;
                width: 16px;
                height: 16px;
            }

            .status-radio.running {
                color: #228b22;
            }

            .status-radio.idle {
                color: #ff8c00;
            }

            .status-radio.maintenance {
                color: #dc143c;
            }

            .size-selector {
                margin-bottom: 16px;
            }

            .size-selector label {
                display: block;
                font-size: 12px;
                font-weight: 700;
                margin-bottom: 4px;
                color: var(--text-secondary);
                text-transform: uppercase;
            }

            .production-input {
                display: flex;
                gap: 8px;
                align-items: flex-end;
            }

            .production-input input {
                flex: 1;
            }

            .reset-btn {
                background: var(--crimson-gradient);
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: var(--border-radius-sm);
                cursor: pointer;
                font-size: 12px;
                white-space: nowrap;
                font-weight: 700;
                text-transform: uppercase;
            }

            .reset-btn:hover {
                box-shadow: var(--shadow-crimson);
            }

            table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                font-size: 13px;
                border-radius: 12px;
            }

            table thead {
                display: none;
                /* Hide headers on mobile */
            }

            table tbody {
                display: block;
            }

            table tr {
                display: block;
                margin-bottom: 15px;
                background: var(--surface-white);
                border: 2px solid rgba(212, 175, 55, 0.3);
                border-radius: 12px;
                padding: 15px;
                box-shadow: var(--shadow-md);
            }

            table td {
                display: block;
                text-align: right;
                padding: 8px 0;
                border: none;
                position: relative;
                padding-left: 50%;
            }

            table td::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 45%;
                padding-left: 10px;
                font-weight: 700;
                text-align: left;
                color: var(--text-secondary);
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            table td:last-child {
                border-bottom: none;
                padding-top: 15px;
                text-align: center;
                padding-left: 0;
            }

            table td:last-child::before {
                display: none;
            }

            /* Totals Box Mobile */
            .totals-box {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
            }

            .totals-box .total-item {
                padding: 12px 0;
            }

            .totals-box .total-label {
                font-size: 13px;
            }

            .totals-box .total-value {
                font-size: 20px;
            }

            /* Modal Mobile */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 20px auto;
                padding: 25px;
                max-height: 90vh;
                overflow-y: auto;
                border-radius: 16px;
            }

            .modal h3 {
                font-size: 20px;
                margin-bottom: 20px;
            }

            /* Invoice Items Mobile */
            #invoiceItems {
                display: block;
                overflow-x: auto;
            }

            .invoice-item-row {
                display: block;
                margin-bottom: 20px;
                padding: 15px;
                background: #f9fafb;
                border-radius: 12px;
                border: 2px solid rgba(212, 175, 55, 0.2);
            }

            .invoice-item-row input,
            .invoice-item-row select {
                margin-bottom: 10px;
                width: 100%;
            }

            /* Chart Container Mobile */
            .chart-container {
                padding: 20px;
                margin-bottom: 20px;
            }

            .chart-container h3 {
                font-size: 16px;
            }

            /* Report Filters Mobile */
            .report-filters {
                flex-direction: column;
                gap: 12px;
                margin-bottom: 20px;
            }

            .report-filters input,
            .report-filters select,
            .report-filters button {
                width: 100%;
            }

            /* Tab Content Mobile */
            .sub-tabs {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-bottom: 20px;
            }

            .sub-tab-button {
                flex: 1 1 calc(50% - 8px);
                min-width: 140px;
                padding: 12px 16px;
                font-size: 13px;
            }

            /* Autocomplete Dropdown Mobile */
            .autocomplete-dropdown {
                max-height: 200px;
                font-size: 14px;
            }

            .autocomplete-item {
                padding: 12px;
            }

            /* Connection Status Mobile */
            .connection-status {
                top: 10px;
                right: 10px;
                font-size: 11px;
                padding: 6px 12px;
                border-radius: 20px;
            }

            /* Toast Notifications Mobile */
            #toast {
                bottom: 20px;
                right: 20px;
                left: 20px;
                text-align: center;
                font-size: 13px;
                padding: 15px;
                border-radius: 10px;
            }

            /* List Widget Mobile */
            .list-widget li {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 12px 0;
            }

            .list-widget .label {
                font-size: 14px;
            }

            .list-widget .value {
                font-size: 18px;
                align-self: flex-end;
            }

            /* Insight Grid Mobile */
            .insight-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            /* Scroll Hint for Tables */
            table::-webkit-scrollbar {
                height: 8px;
            }

            table::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }

            table::-webkit-scrollbar-thumb {
                background: var(--gold-gradient);
                border-radius: 10px;
            }
        }

        /* Extra Small Mobile - 480px and below */
        @media (max-width: 480px) {
            .main-content {
                padding: 70px 10px 15px 10px;
            }

            h2 {
                font-size: 20px;
            }

            .godfather-card {
                padding: 15px;
            }

            .metric-value {
                font-size: 24px;
            }

            input,
            select,
            textarea {
                font-size: 16px;
                padding: 12px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 13px;
            }

            .modal-content {
                padding: 20px;
            }

            .sidebar {
                width: 260px;
            }

            .sub-tab-button {
                flex: 1 1 100%;
                min-width: 100%;
            }

            table {
                font-size: 12px;
            }

            table td {
                padding: 6px 0;
                font-size: 13px;
            }
        }

        /* Landscape Mobile Optimization */
        @media (max-width: 900px) and (orientation: landscape) {
            .sidebar {
                width: 240px;
            }

            .main-content {
                padding: 60px 20px 20px 20px;
            }

            .godfather-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                max-height: 80vh;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {

            /* Increase touch targets */
            button,
            .btn,
            .tab-button,
            .sub-tab-button {
                min-height: 44px;
                min-width: 44px;
            }

            .autocomplete-item {
                min-height: 44px;
                padding: 12px 16px;
            }

            /* Remove hover effects on touch devices */
            *:hover {
                transition: none !important;
            }

            /* Prevent text selection on buttons */
            button,
            .btn {
                -webkit-user-select: none;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
        }
        .dark-surface {
            background: radial-gradient(circle at top, rgba(12, 28, 63, 0.85), rgba(5, 11, 24, 0.95));
            border-radius: 28px;
            padding: 32px;
            color: #f5f8ff;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .dark-surface h1,
        .dark-surface h2 {
            color: #f6fbff;
            -webkit-text-fill-color: #f6fbff;
            text-shadow: 0 4px 18px rgba(0, 0, 0, 0.5);
            margin-bottom: 8px;
        }

        .dark-surface h3,
        .dark-surface h4 {
            color: #f6fbff;
        }

        .dark-surface p {
            color: rgba(245, 248, 255, 0.75);
        }

        .machine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
        }

        .packing-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .machine-card {
            background: rgba(8, 18, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 18px;
            color: #f0f4ff;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.45);
        }

        .machine-card .machine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .machine-card .machine-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .machine-status-badge {
            background: rgba(79, 209, 197, 0.15);
            color: #4fd1c5;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
        }

        .machine-card select,
        .machine-card input {
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f0f4ff;
            border-radius: 10px;
            padding: 8px 10px;
            margin-bottom: 10px;
        }

        .machine-status {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }

        .machine-status label {
            flex: 1;
            border-radius: 10px;
            padding: 6px 0;
            text-align: center;
            background: rgba(255, 255, 255, 0.06);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
        }

        .group-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .group-btn {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.04);
            color: #dce5ff;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .group-btn.active,
        .group-btn:hover {
            background: linear-gradient(135deg, #4fd1c5, #5a8dee);
            color: #021026;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
        }

        .inventory-stage-card {
            background: rgba(8, 18, 42, 0.92);
            border-radius: 22px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.45);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .inventory-stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inventory-stage-title {
            font-size: 1.05rem;
            letter-spacing: 0.5px;
            color: #f6fbff;
            margin-bottom: 4px;
        }

        .inventory-stage-meta {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .inventory-size-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 260px;
            overflow-y: auto;
        }

        .inventory-size-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .inventory-size-row--empty {
            justify-content: center;
            font-style: italic;
            color: rgba(255, 255, 255, 0.5);
        }

        .inventory-size-name {
            font-weight: 600;
            color: #f8f9ff;
        }

        .inventory-size-count {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .inventory-qty-actions {
            display: flex;
            gap: 6px;
        }

        .inventory-qty-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            line-height: 1;
            padding: 0;
        }

        .inventory-qty-btn--add {
            background: #2ecc71;
        }

        .inventory-qty-btn--remove {
            background: #e74c3c;
        }

        .inventory-stage-add h4 {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 6px;
        }

        .inventory-stage-add-form {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .inventory-stage-add select,
        .inventory-stage-add input {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #f5f8ff;
            padding: 8px 10px;
        }

        .inventory-stage-add button {
            background: linear-gradient(135deg, #4fd1c5, #5a8dee);
            color: #031224;
            border: none;
            border-radius: 10px;
            padding: 9px 16px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 6px 18px rgba(79, 209, 197, 0.35);
        }

        @media (max-width: 768px) {
            .dark-surface {
                padding: 20px;
            }

            .machine-grid,
            .inventory-grid {
                grid-template-columns: 1fr;
            }

            .inventory-stage-add-form {
                flex-direction: column;
                align-items: stretch;
            }

            .inventory-stage-add button {
                width: 100%;
            }
        }

        .inventory-toolbar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
        }

        .inventory-search {
            position: relative;
            width: min(320px, 100%);
        }

        .inventory-search input {
            width: 100%;
            padding: 10px 40px 10px 14px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #f6fbff;
        }

        .inventory-search input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .inventory-search button {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 16px;
        }

        .inventory-search-info {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            background: rgba(79, 209, 197, 0.1);
            color: #9fe5f1;
            display: none;
        }

        .prod-action-btn {
            border: none;
            border-radius: 12px;
            padding: 6px 14px;
            background: linear-gradient(135deg, #4fd1c5, #5a8dee);
            color: #011022;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(79, 209, 197, 0.25);
            margin-top: 18px;
        }

        .prod-action-btn.secondary {
            background: rgba(255, 255, 255, 0.08);
            color: #f6fbff;
            box-shadow: none;
        }

        .prod-action-btn.ghost {
            background: rgba(255, 255, 255, 0.04);
            color: #f6fbff;
            box-shadow: none;
        }
    </style>

</head>

<body>
    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileMenu()"></button>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

    <div class="connection-status disconnected" id="connectionStatus"> Offline</div>
    <div class="pending-badge" id="pendingSyncBadge" aria-live="polite" title="Pending changes waiting for sync"></div>
    <button class="perf-toggle" id="perfToggle" type="button" onclick="togglePerformanceMode()" title="Reduce animations and heavy effects"> Performance</button>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <h1> Factory Book</h1>
            <button class="tab-button active" data-tab="sales" onclick="switchMainTab('sales', this)"> Sales</button>
            <button class="tab-button" data-tab="purchase" onclick="switchMainTab('purchase', this)">
                Purchase</button>
            <button class="tab-button" data-tab="reports" onclick="switchMainTab('reports', this)"> Reports</button>
            <button class="tab-button" data-tab="ledger" onclick="switchMainTab('ledger', this)"> Ledger</button>
            <button class="tab-button" data-tab="size-control"
                onclick="switchMainTab('size-control', this); renderMachinesTable();"> Machine
                Size Control</button>
            <button class="tab-button" data-tab="dashboard" onclick="switchMainTab('dashboard', this)"> Dashboard</button>
            <button class="tab-button" data-tab="production-entry" onclick="switchMainTab('production-entry', this)">
                Production Entry</button>
            <button class="tab-button" data-tab="packing" onclick="switchMainTab('packing', this)"> Packing</button>
            <button class="tab-button" data-tab="masters" onclick="switchMainTab('masters', this)"> Masters</button>
            <button class="tab-button" data-tab="inventory" onclick="switchMainTab('inventory', this)">
                Inventory</button>
            <button class="tab-button" data-tab="backup" onclick="switchMainTab('backup', this)"> Backup</button>
        </div>

        <div class="main-content">

            <!-- SALES TAB -->
            <div id="sales" class="tab-content active">
                <h2>Sales Invoice</h2>

                <div class="subtabs">
                    <button class="subtab-btn active" onclick="switchSalesSubtab('sales-create', this)">Create
                        Invoice</button>
                    <button class="subtab-btn" onclick="switchSalesSubtab('sales-list', this)">View Invoices</button>
                    <button class="subtab-btn" onclick="switchSalesSubtab('sales-quote-create', this)">Create Quote</button>
                    <button class="subtab-btn" onclick="switchSalesSubtab('sales-quote-list', this)">View Quotes</button>
                </div>

                <div id="sales-create" class="subtab-content active">
                    <form id="salesInvoiceForm" onsubmit="return false;">
                        <input type="hidden" id="saleInvoiceIdEdit">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Invoice Date</label>
                                <input type="date" id="saleDate" required>
                            </div>
                            <div class="form-group">
                                <label>Customer (Type to search)</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="saleCustomer" class="autocomplete-input"
                                        placeholder="Start typing customer name..." autocomplete="off">
                                    <div class="autocomplete-dropdown" id="saleCustomerList"></div>
                                </div>
                                <button type="button" onclick="openAddCustomerModal()"
                                    style="width: auto; margin-top: 5px;">+ Add New Customer</button>
                                <input type="hidden" id="saleCustomerId">
                            </div>
                        </div>

                        <div class="section-title">Line Items</div>
                        <table class="line-items-table">
                            <thead>
                                <tr>
                                    <th>Size</th>
                                    <th>Unit</th>
                                    <th>Bags Received (Ready Screws)</th>
                                    <th>Qty</th>
                                    <th>Rate ()</th>
                                    <th>Discount (%)</th>
                                    <th>Line Tax ()</th>
                                    <th>Total ()</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="saleLineItems">
                            </tbody>
                        </table>

                        <button type="button" onclick="addSaleLine()" class="success">+ Add Line Item</button>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Additional Invoice Tax () - Applied on top of line taxes</label>
                                <input type="number" id="saleInvoiceTax" step="0.01" value="0" readonly>
                            </div>
                        </div>

                        <div class="totals-box">
                            <div class="total-item">
                                <label>Subtotal:</label>
                                <div class="amount currency"><span id="saleSubtotal">0</span></div>
                            </div>
                            <div class="total-item">
                                <label>Line Taxes:</label>
                                <div class="amount currency"><span id="saleTaxTotal">0</span></div>
                            </div>
                            <div class="total-item">
                                <label>Invoice Tax (18% GST):</label>
                                <div class="amount currency"><span id="saleInvoiceTaxDisplay">0</span></div>
                            </div>
                            <div class="total-item">
                                <label>Grand Total:</label>
                                <div class="amount currency"><span id="saleGrandTotal">0</span></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Notes (optional)</label>
                                <textarea id="saleNotes" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="button-group no-print">
                            <button type="button" onclick="saveSalesInvoice()" class="success"> Save Invoice</button>
                            <button type="button" onclick="clearSalesForm()"> Clear Form</button>
                            <button type="button" onclick="window.print()" class="success"> Print</button>
                        </div>
                    </form>
                </div>

                <div id="sales-list" class="subtab-content">
                    <h3>All Sales Invoices</h3>
                    <div class="button-group no-print" style="margin:8px 0 12px 0; gap:8px;">
                        <button type="button" onclick="openImportModal('salesImport')" style="width:auto;"> Import CSV
                            (Sales Invoices)</button>
                        <button type="button" onclick="openImportModal('bankLedger')" style="width:auto;"> Import CSV
                            (Bank Statement)</button>
                    </div>

                    <!-- Bulk Actions for Sales Invoices -->
                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAllSalesInvoices" onchange="toggleSelectAllSalesInvoices()">
                        <label for="selectAllSalesInvoices">Select All</label>
                        <select id="bulkActionSalesInvoices" style="margin-left: 10px;">
                            <option value="">Bulk Actions</option>
                            <option value="edit">Edit Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button type="button" onclick="applyBulkActionSalesInvoices()" class="success">Apply</button>
                    </div>

                    <!-- Search bar for Sales Invoices -->
                    <div class="invoice-search">
                        <input type="text" id="salesInvoiceSearch"
                            placeholder="Search by party, item, amount or size..."
                            style="margin: 12px 0; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>

                    <table id="salesInvoiceTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">Select</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Amount ()</th>
                                <th>Line Tax ()</th>
                                <th>Invoice Tax ()</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Invoices will be populated here -->
                            <tr id="salesTotalRow"
                                style="font-weight: bold; background: #f0f0f0; border-top: 2px solid #333;">
                                <td colspan="3" style="text-align: right; font-weight: bold;">TOTAL:</td>
                                <td id="salesTotalAmount" class="currency">0.00</td>
                                <td id="salesTotalLineTax" class="currency">0.00</td>
                                <td id="salesTotalInvoiceTax" class="currency">0.00</td>
                                <td></td> <!-- Empty for actions -->
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="sales-quote-create" class="subtab-content">
                    <h3>Create Quote</h3>
                    <form id="salesQuoteForm" onsubmit="return false;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="quoteDate">
                            </div>
                            <div class="form-group">
                                <label>Customer</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="quoteCustomer" class="autocomplete-input" placeholder="Start typing customer name..." autocomplete="off">
                                    <div class="autocomplete-dropdown" id="quoteCustomerList"></div>
                                </div>
                                <input type="hidden" id="quoteCustomerId">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Stage</label>
                                <select id="quoteStage">
                                    <option value="Rolling">Rolling</option>
                                    <option value="Plating">Plating</option>
                                    <option value="Furnace">Hardening</option>
                                    <option value="Tampering">Tampering</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Size (only from inventory)</label>
                                <input type="text" id="quoteSize" list="quoteSizeOptions" placeholder="Start typing size..." onchange="handleQuoteSizeInput(this.value)">
                            </div>
                            <div class="form-group">
                                <label>Unit</label>
                                <select id="quoteUnit">
                                    <option value="Bags">Bags</option>
                                    <option value="KG">KG</option>
                                    <option value="PKT">PKT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Bag Factor / Count</label>
                                <input type="number" id="quoteBagFactor" min="1" placeholder="e.g. 24 packets per bag or 50 kg per bag">
                            </div>
                            <div class="form-group">
                                <label>Qty</label>
                                <input type="number" id="quoteQty" min="1" placeholder="Qty">
                            </div>
                        </div>

                        <div class="section-title">Line Items</div>
                        <table class="line-items-table">
                            <thead>
                                <tr>
                                    <th>Size</th>
                                    <th>Unit</th>
                                    <th>Qty</th>
                                    <th>Stage</th>
                                    <th>Bags Used</th>
                                    <th>Total Qty</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="quoteLineItems">
                            </tbody>
                        </table>
                        <button type="button" class="success" onclick="addQuoteLine()">+ Add Line</button>

                        <div class="button-group no-print" style="margin-top:12px;">
                            <button type="button" class="success" onclick="saveQuote()"> Save Quote</button>
                            <button type="button" onclick="clearQuoteForm()"> Clear</button>
                        </div>
                    </form>
                </div>

                <div id="sales-quote-list" class="subtab-content">
                    <h3>View Quotes</h3>
                <div class="invoice-search">
                    <input type="text" id="quoteSearch" placeholder="Search quotes..." oninput="filterQuotes(this.value)">
                </div>
                    <table id="quotesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Stage</th>
                                <th>Size</th>
                                <th>Qty</th>
                                <th>Total Qty</th>
                                <th>Bags Used</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Remarks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PURCHASE TAB -->
            <div id="purchase" class="tab-content">
                <h2>Purchase Invoice</h2>

                <div class="subtabs">
                    <button class="subtab-btn active" onclick="switchPurchaseSubtab('purchase-create', this)">Create
                        Invoice</button>
                    <button class="subtab-btn" onclick="switchPurchaseSubtab('purchase-list', this)">View
                        Invoices</button>
                </div>

                <div id="purchase-create" class="subtab-content active">
                    <form id="purchaseInvoiceForm" onsubmit="return false;">
                        <input type="hidden" id="purchaseInvoiceIdEdit">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Invoice Date</label>
                                <input type="date" id="purchaseDate" required>
                            </div>
                            <div class="form-group">
                                <label>Supplier (Type to search)</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="purchaseSupplier" class="autocomplete-input"
                                        placeholder="Start typing supplier name..." autocomplete="off">
                                    <div class="autocomplete-dropdown" id="purchaseSupplierList"></div>
                                </div>
                                <button type="button" onclick="openAddSupplierModal()"
                                    style="width: auto; margin-top: 5px;">+ Add New Supplier</button>
                                <input type="hidden" id="purchaseSupplierId">
                            </div>
                        </div>

                        <div class="section-title">Line Items</div>
                        <table class="line-items-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Size (Ready Screws)</th>
                                    <th>Stage (Ready Screws)</th>
                                    <th>Bags Received (Ready Screws)</th>
                                    <th>Unit</th>
                                    <th>Qty</th>
                                    <th>Rate ()</th>
                                    <th>Line Tax ()</th>
                                    <th>Total ()</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseLineItems">
                            </tbody>
                        </table>

                        <button type="button" onclick="addPurchaseLine()" class="success">+ Add Line Item</button>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Additional Invoice Tax () - Applied on top of line taxes</label>
                                <input type="number" id="purchaseInvoiceTax" step="0.01" value="0">
                            </div>
                        </div>

                        <div class="totals-box">
                            <div class="total-item">
                                <label>Subtotal:</label>
                                <div class="amount currency"><span id="purchaseSubtotal">0</span></div>
                            </div>
                            <div class="total-item">
                                <label>Line Taxes:</label>
                                <div class="amount currency"><span id="purchaseTaxTotal">0</span></div>
                            </div>
                            <div class="total-item">
                                <label>Invoice Tax:</label>
                                <div class="amount currency"><span id="purchaseInvoiceTaxDisplay">0</span></div>
                            </div>
                            <div class="total-item">
                                <label>Grand Total:</label>
                                <div class="amount currency"><span id="purchaseGrandTotal">0</span></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Notes (optional)</label>
                                <textarea id="purchaseNotes" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="button-group no-print">
                            <button type="button" onclick="savePurchaseInvoice()" class="success"> Save
                                Invoice</button>
                            <button type="button" onclick="clearPurchaseForm()"> Clear Form</button>
                            <button type="button" onclick="window.print()" class="success"> Print</button>
                        </div>
                    </form>
                </div>

                <div id="purchase-list" class="subtab-content">
                    <h3>All Purchase Invoices</h3>
                    <div class="button-group no-print" style="margin:8px 0 12px 0; gap:8px;">
                        <button type="button" onclick="openImportModal('purchaseImport')" style="width:auto;"> Import
                            CSV (Purchase Invoices)</button>
                        <button type="button" onclick="openImportModal('bankLedger')" style="width:auto;"> Import CSV
                            (Bank Statement)</button>
                    </div>

                    <!-- Bulk Actions for Purchase Invoices -->
                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAllPurchaseInvoices"
                            onchange="toggleSelectAllPurchaseInvoices()">
                        <label for="selectAllPurchaseInvoices">Select All</label>
                        <select id="bulkActionPurchaseInvoices" style="margin-left: 10px;">
                            <option value="">Bulk Actions</option>
                            <option value="edit">Edit Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button type="button" onclick="applyBulkActionPurchaseInvoices()" class="success">Apply</button>
                    </div>

                    <!-- Search bar for Purchase Invoices -->
                    <div class="invoice-search">
                        <input type="text" id="purchaseInvoiceSearch"
                            placeholder="Search by party, item, amount or size..."
                            style="margin: 12px 0; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>

                    <div class="report-filters">
                        <div class="form-group">
                            <label>Filter by Category</label>
                            <select id="purchaseCategoryFilter" onchange="filterPurchaseByCategory()">
                                <option value="">All Categories</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Machine Repair">Machine Repair</option>
                                <option value="RAW MATERIALS">RAW MATERIALS</option>
                                <option value="Other">Other</option>
                                <option value="Wire">Wire</option>
                                <option value="Ready Screws">Ready Screws</option>
                                <option value="P E">P E</option>
                                <option value="miscellaneous">miscellaneous</option>
                            </select>
                        </div>
                    </div>
                    <div id="categoryTotalsSummary"></div>
                    <table id="purchaseInvoiceTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">Select</th>
                                <th>Date</th>
                                <th>Supplier</th>
                                <th>Categories</th>
                                <th>Amount ()</th>
                                <th>Line Tax ()</th>
                                <th>Invoice Tax ()</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Invoices will be populated here -->
                            <tr id="purchaseTotalRow"
                                style="font-weight: bold; background: #f0f0f0; border-top: 2px solid #333;">
                                <td colspan="4" style="text-align: right; font-weight: bold;">TOTAL:</td>
                                <td id="purchaseTotalAmount" class="currency">0.00</td>
                                <td id="purchaseTotalLineTax" class="currency">0.00</td>
                                <td id="purchaseTotalInvoiceTax" class="currency">0.00</td>
                                <td></td> <!-- Empty for actions -->
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTS TAB -->
            <div id="reports" class="tab-content">
                <h2>Reports</h2>

                <div class="subtabs">
                    <button class="subtab-btn active" onclick="switchReportsSubtab('report-sizewise', this)">Size-wise
                        Sales</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-sizewise-purchase', this)">Size-wise
                        Purchases</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-customerwise', this)">Customer-wise
                        Sales</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-pl', this)">P&L Statement</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-business-intel', this)"> Business
                        Intelligence</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-visual-analytics', this)"> Visual
                        Analytics</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-elaborate', this)"> Elaborate</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-activity-logs', this)"> Logs</button>
                </div>

                <div id="report-sizewise" class="subtab-content active">
                    <h3>Size-wise Sales Report</h3>
                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportSizeFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportSizeToDate">
                        </div>
                        <button type="button" onclick="generateSizewiseReport()"> Generate Report</button>
                        <button type="button" onclick="exportReportCSV('sizewiseTable')"> Export CSV</button>
                    </div>
                    <table id="sizewiseTable">
                        <thead>
                            <tr>
                                <th>Size</th>
                                <th>Total KG</th>
                                <th>Total PKT</th>
                                <th>Total Value ()</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div id="report-sizewise-purchase" class="subtab-content">
                    <h3>Size-wise Purchases Report</h3>
                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportSizePurchaseFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportSizePurchaseToDate">
                        </div>
                        <button type="button" onclick="generateSizewisePurchaseReport()"> Generate Report</button>
                        <button type="button" onclick="exportReportCSV('sizewisePurchaseTable')"> Export CSV</button>
                    </div>
                    <table id="sizewisePurchaseTable">
                        <thead>
                            <tr>
                                <th>Size</th>
                                <th>Total KG</th>
                                <th>Total PKT</th>
                                <th>Total Value ()</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div id="report-customerwise" class="subtab-content">
                    <h3>Customer-wise Sales Report</h3>
                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportCustFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportCustToDate">
                        </div>
                        <div class="form-group">
                            <label>Filter by Customer (optional)</label>
                            <input type="text" id="reportCustFilter" placeholder="Leave blank for all">
                        </div>
                        <button type="button" onclick="generateCustomerwiseReport()"> Generate Report</button>
                        <button type="button" onclick="exportReportCSV('customerwiseTable')"> Export CSV</button>
                    </div>
                    <table id="customerwiseTable">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Total Sales ()</th>
                                <th>Total KG</th>
                                <th>Total PKT</th>
                                <th>Top Sizes</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div id="report-elaborate" class="subtab-content">
                    <h3>Elaborate Stock Flow Report</h3>
                    <p style="color:#6b7280; margin-bottom:8px;">See how every size is moving: factory production, vendor purchases, and on-hand stock for the selected window.</p>
                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportElaborateFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportElaborateToDate">
                        </div>
                        <button type="button" onclick="generateElaborateReport()"> Generate Report</button>
                        <button type="button" onclick="exportReportCSV('elaborateFactoryTable')"> Export Factory</button>
                        <button type="button" onclick="exportReportCSV('elaboratePurchaseTable')"> Export Purchases</button>
                        <button type="button" onclick="exportReportCSV('elaborateStockTable')"> Export Stock</button>
                    </div>
                    <div class="elaborate-grid" style="display:grid; gap:18px;">
                        <div class="card" style="padding:16px; background:#f8fafc; border-radius:10px;">
                            <h4>Factory Made (Production)</h4>
                            <table id="elaborateFactoryTable">
                                <thead>
                                    <tr>
                                        <th>Size</th>
                                        <th>Total Bags</th>
                                        <th>Stages</th>
                                        <th>Machines</th>
                                        <th>Last Produced</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="card" style="padding:16px; background:#f8fafc; border-radius:10px;">
                            <h4>Purchased Externally</h4>
                            <table id="elaboratePurchaseTable">
                                <thead>
                                    <tr>
                                        <th>Size</th>
                                        <th>Total KG</th>
                                        <th>Total PKT</th>
                                        <th>Total Value ()</th>
                                        <th>Suppliers</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="card" style="padding:16px; background:#f8fafc; border-radius:10px;">
                            <h4>Sizes Already In Stock</h4>
                            <table id="elaborateStockTable">
                                <thead>
                                    <tr>
                                        <th>Size</th>
                                        <th>Raw Wire (KG)</th>
                                        <th>Finished Goods (PKT)</th>
                                        <th>Last Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                            <p style="font-size:12px; color:#6b7280; margin-top:8px;">Stock values represent the live snapshot at the time of report creation.</p>
                        </div>
                    </div>
                </div>

                <div id="report-pl" class="subtab-content">
                    <h3>Profit & Loss Statement</h3>

                    <div class="subtabs" style="margin-bottom: 15px;">
                        <button class="subtab-btn active" onclick="switchPLSubtab('pl-gross', this)">Gross P&L (Grand
                            Total)</button>
                        <button class="subtab-btn" onclick="switchPLSubtab('pl-tax', this)">Actual Cost vs Tax
                            P&L</button>
                        <button class="subtab-btn" onclick="switchPLSubtab('pl-gst', this)">GST</button>
                        <button class="subtab-btn" onclick="switchPLSubtab('pl-masters', this)">Masters</button>
                    </div>

                    <div id="pl-gross" class="subtab-content active">
                        <h4 style="margin-bottom: 15px;">Gross Profit & Loss (Including All Taxes)</h4>
                        <div class="report-filters">
                            <div class="form-group">
                                <label>From Date</label>
                                <input type="date" id="reportPLFromDate">
                            </div>
                            <div class="form-group">
                                <label>To Date</label>
                                <input type="date" id="reportPLToDate">
                            </div>
                            <button type="button" onclick="generatePLReport()" class="success"> Generate P&L</button>
                            <button type="button" onclick="exportReportCSV('plTable')" class="success"> Export
                                CSV</button>
                        </div>
                        <table id="plTable">
                            <thead>
                                <tr>
                                    <th>Particulars</th>
                                    <th style="text-align: right;">Amount ()</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>Net Profit/Loss</td>
                                    <td id="plNetResult" style="text-align: right;">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div id="pl-tax" class="subtab-content">
                        <h4 style="margin-bottom: 15px;">Profit & Loss - Actual Cost vs Line Tax</h4>
                        <div class="report-filters">
                            <div class="form-group">
                                <label>From Date</label>
                                <input type="date" id="reportPLTaxFromDate">
                            </div>
                            <div class="form-group">
                                <label>To Date</label>
                                <input type="date" id="reportPLTaxToDate">
                            </div>
                            <button type="button" onclick="generatePLTaxReport()" class="success"> Generate
                                Report</button>
                            <button type="button" onclick="exportReportCSV('plTaxTable')" class="success"> Export
                                CSV</button>
                        </div>
                        <table id="plTaxTable">
                            <thead>
                                <tr>
                                    <th>Particulars</th>
                                    <th style="text-align: right;">Amount ()</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>Net Profit/Loss (Actual Cost)</td>
                                    <td id="plTaxNetResult" style="text-align: right;">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div id="pl-gst" class="subtab-content">
                        <h4 style="margin-bottom: 15px;">GST Calculation</h4>
                        <div class="report-filters">
                            <div class="form-group">
                                <label>From Date</label>
                                <input type="date" id="reportGSTFromDate">
                            </div>
                            <div class="form-group">
                                <label>To Date</label>
                                <input type="date" id="reportGSTToDate">
                            </div>
                            <button type="button" onclick="generateGSTReport()" class="success"> Generate
                                Report</button>
                            <button type="button" onclick="exportReportCSV('gstTable')" class="success"> Export
                                CSV</button>
                        </div>
                        <table id="gstTable">
                            <thead>
                                <tr>
                                    <th>Particulars</th>
                                    <th style="text-align: right;">Amount ()</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>Net GST Payable</td>
                                    <td id="gstNetResult" style="text-align: right;">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div id="pl-masters" class="subtab-content">
                        <h4 style="margin-bottom: 15px;">Masters Summary</h4>
                        <div class="report-filters">
                            <div class="form-group">
                                <label>From Date</label>
                                <input type="date" id="reportMastersFromDate">
                            </div>
                            <div class="form-group">
                                <label>To Date</label>
                                <input type="date" id="reportMastersToDate">
                            </div>
                            <button type="button" onclick="generateMastersReport()" class="success"> Generate Masters
                                Summary</button>
                            <button type="button" onclick="exportReportCSV('mastersTable')" class="success"> Export
                                CSV</button>
                        </div>
                        <table id="mastersTable">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th style="text-align: right;">Amount ()</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="report-activity-logs" class="subtab-content">
                    <h3>Action Logs</h3>
                    <p style="color:#6b7280; margin-bottom:8px;">All key actions are captured with time, user and context for traceability.</p>
                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="logsFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="logsToDate">
                        </div>
                        <div class="form-group">
                            <label>Search</label>
                            <input type="text" id="logsSearch" placeholder="Search action, details or user..." oninput="generateActivityLogs(false)">
                        </div>
                        <div class="form-group" style="align-self:flex-end;">
                            <label style="display:flex; align-items:center; gap:6px; font-size:13px;">
                                <input type="checkbox" id="logsHideNavigation" checked onchange="generateActivityLogs(false)">
                                Hide tab/navigation events
                            </label>
                        </div>
                        <button type="button" onclick="generateActivityLogs(true)"> Refresh Logs</button>
                        <button type="button" onclick="exportReportCSV('activityLogsTable')"> Export Logs</button>
                    </div>
                    <table id="activityLogsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Role</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <!-- NEW BUSINESS INTELLIGENCE DASHBOARD -->
                <div id="report-business-intel" class="subtab-content">
                    <h3>Business Intelligence Dashboard</h3>

                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportBIFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportBIToDate">
                        </div>
                        <button type="button" onclick="generateBusinessIntelligenceReport()" class="success"> Generate
                            Dashboard</button>
                        <button type="button" onclick="exportBIDashboard()" class="success"> Export Report</button>
                    </div>

                    <div id="biDashboard">
                        <div class="dashboard-cards">
                            <div class="dashboard-card">
                                <h4> Financial Overview</h4>
                                <div class="metric-value" id="biTotalSales">0</div>
                                <div>Total Sales</div>
                                <div class="metric-value" id="biTotalPurchases">0</div>
                                <div>Total Purchases</div>
                                <div class="metric-value" id="biNetProfit">0</div>
                                <div>Net Profit</div>
                            </div>

                            <div class="dashboard-card">
                                <h4> Inventory Health</h4>
                                <div class="metric-value" id="biTotalInventoryValue">0</div>
                                <div>Inventory Value</div>
                                <div class="metric-value" id="biLowStockItems">0</div>
                                <div>Low Stock Items</div>
                                <div class="metric-value" id="biInventoryTurnover">0.0</div>
                                <div>Turnover Ratio</div>
                            </div>

                            <div class="dashboard-card">
                                <h4> Customer Insights</h4>
                                <div class="metric-value" id="biTopCustomer">-</div>
                                <div>Top Customer</div>
                                <div class="metric-value" id="biAvgOrderValue">0</div>
                                <div>Avg Order Value</div>
                                <div class="metric-value" id="biCustomerCount">0</div>
                                <div>Total Customers</div>
                            </div>

                            <div class="dashboard-card">
                                <h4> Purchase Analysis</h4>
                                <div class="metric-value" id="biFrequentSupplier">-</div>
                                <div>Most Frequent Supplier</div>
                                <div class="metric-value" id="biRawMaterialCost">0</div>
                                <div>Raw Material Cost</div>
                                <div class="metric-value" id="biMaintenanceCost">0</div>
                                <div>Maintenance Cost</div>
                            </div>

                        </div>

                        <div class="chart-container">
                            <h4> Key Business Insights</h4>
                            <div id="biInsights">
                                <!-- Insights will be populated here -->
                            </div>
                        </div>

                        <div class="chart-container">
                            <h4> Top Performers</h4>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <h5>Top 5 Customers</h5>
                                    <ul class="top-list" id="biTopCustomers">
                                        <!-- Top customers will be populated here -->
                                    </ul>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <h5>Top 5 Products</h5>
                                    <ul class="top-list" id="biTopProducts">
                                        <!-- Top products will be populated here -->
                                    </ul>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <h5>Frequent Purchases</h5>
                                    <ul class="top-list" id="biFrequentPurchases">
                                        <!-- Frequent purchases will be populated here -->
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="chart-container">
                            <h4> Raw Material Consumption</h4>
                            <table id="biRawMaterialTable">
                                <thead>
                                    <tr>
                                        <th>Material Type</th>
                                        <th>Total Qty (KG)</th>
                                        <th>Total Cost ()</th>
                                        <th>Avg Monthly Usage</th>
                                        <th>Reorder Frequency</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>

                        <!--  Production Recommendations -->
                        <div class="chart-container">
                            <h4> Production Recommendations</h4>
                            <ul class="top-list" id="biProductionRecommendations">
                                <!-- Recommendations will be populated here -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- GODFATHER COMMAND CENTER -->
                <hr style="margin: 30px 0; border: 0; border-top: 1px dashed #cbd5e1;">
                <h3> Godfather Command Center</h3>

                <div class="report-filters">
                    <div class="form-group" style="max-width: 180px;">
                        <label>From</label>
                        <input type="date" id="gfFromDate">
                    </div>
                    <div class="form-group" style="max-width: 180px;">
                        <label>To</label>
                        <input type="date" id="gfToDate">
                    </div>
                    <button type="button" onclick="generateGodfatherReport()" class="success"
                        style="margin-top: 23px;"> Run Oracle Engine</button>
                </div>

                <div class="godfather-grid">
                    <div class="godfather-card critical" id="card-runway">
                        <h4> Production Runway</h4>
                        <div class="metric" id="kpi-runway">-- Days</div>
                        <div class="sub-metric">Until Finished Stockout (based on last 30 days)</div>
                    </div>
                    <div class="godfather-card warning" id="card-cash">
                        <h4> Cash To Collect</h4>
                        <div class="metric" id="kpi-collect">0</div>
                        <div class="sub-metric">Outstanding Customer Balance (Ledger)</div>
                    </div>
                    <div class="godfather-card success" id="card-efficiency">
                        <h4> Capital Efficiency</h4>
                        <div class="metric" id="kpi-efficiency">0.0</div>
                        <div class="sub-metric">Revenue per KG of Wire (period)</div>
                    </div>
                    <div class="godfather-card" id="card-revenue">
                        <h4> Period Revenue</h4>
                        <div class="metric" id="kpi-revenue">0</div>
                        <div class="sub-metric" id="kpi-net">Net Cash (Sales  Purchases): 0</div>
                    </div>
                </div>

                <div class="insight-grid-gf">
                    <div class="chart-container godfather">
                        <h4> The Oracle: Production Queue</h4>
                        <p style="font-size:12px; color:#7f8c8d;">Prioritized based on 30-day sales velocity vs current
                            finished stock.</p>
                        <table id="gf-production-table">
                            <thead>
                                <tr>
                                    <th>Priority</th>
                                    <th>Size</th>
                                    <th>Stock (PKT)</th>
                                    <th>Daily Velocity</th>
                                    <th>Runway</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="chart-container godfather">
                        <h4> Profitability X-Ray</h4>
                        <p style="font-size:12px; color:#7f8c8d;">Top revenue-contributing sizes in the selected period.
                        </p>
                        <ul class="list-widget" id="gf-profit-list"></ul>
                    </div>
                </div>

                <!-- GODFATHER VISUAL PULSE -->
                <hr style="margin: 30px 0; border: 0; border-top: 1px dashed #cbd5e1;">

                <h3> Godfather Visual Pulse</h3>
                <div class="button-group">
                    <button type="button" onclick="generateGodfatherVisuals()" class="success"> Update Pulse &
                        Matrix</button>
                </div>

                <div class="chart-container godfather">
                    <h4> The Pulse: Daily Sales (Last 30 Days)</h4>
                    <canvas id="chart-pulse" height="120"></canvas>
                </div>

                <div class="chart-container godfather">
                    <h4> The Matrix: Stock vs Velocity</h4>
                    <p style="font-size:12px; color:#7f8c8d;">Top-left: dead stock; bottom-right: high-risk fast movers.
                    </p>
                    <canvas id="chart-matrix" height="260"></canvas>
                </div>

                <!-- NEW VISUAL ANALYTICS SECTION -->
                <div id="report-visual-analytics" class="subtab-content">
                    <h3> Visual Analytics & Charts</h3>

                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportChartFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportChartToDate">
                        </div>
                        <button type="button" onclick="generateAllCharts()" class="success"> Generate All
                            Charts</button>
                    </div>

                    <div class="charts-row">
                        <div class="chart-wrapper">
                            <h4> Profit & Loss Trend</h4>
                            <canvas id="profitLossChart" class="chart-canvas"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h4> Sales by Size (Top 10)</h4>
                            <canvas id="salesBySizeChart" class="chart-canvas"></canvas>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-wrapper">
                            <h4> Customer Sales Distribution</h4>
                            <canvas id="customerSalesChart" class="chart-canvas"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h4> Purchase Categories</h4>
                            <canvas id="purchaseCategoriesChart" class="chart-canvas"></canvas>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-wrapper full-width-chart">
                            <h4> Monthly Sales vs Purchases</h4>
                            <canvas id="monthlyTrendChart" class="chart-canvas"
                                style="height: 400px !important;"></canvas>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-wrapper">
                            <h4> Raw Material Consumption</h4>
                            <canvas id="rawMaterialChart" class="chart-canvas"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h4> Inventory Value Distribution</h4>
                            <canvas id="inventoryValueChart" class="chart-canvas"></canvas>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-wrapper full-width-chart">
                            <h4> Purchase Frequency Analysis</h4>
                            <canvas id="purchaseFrequencyChart" class="chart-canvas"
                                style="height: 400px !important;"></canvas>
                        </div>
                    </div>

                    <!--  Stock vs Sales chart to visualise current finished goods stock against recent sales for top sizes -->
                    <div class="charts-row">
                        <div class="chart-wrapper full-width-chart">
                            <h4> Stock vs Sales (Top Sizes)</h4>
                            <canvas id="stockVsSalesChart" class="chart-canvas"
                                style="height: 400px !important;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LEDGER TAB -->
            <div id="ledger" class="tab-content">
                <h2>Ledger</h2>

                <div class="report-filters">
                    <div class="form-group" style="flex: 1; min-width: 250px;">
                        <label>Select Party (Type to search)</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="ledgerPartySearch" class="autocomplete-input"
                                placeholder="Search customer or supplier..." autocomplete="off">
                            <div class="autocomplete-dropdown" id="ledgerPartyList"></div>
                        </div>
                        <input type="hidden" id="ledgerPartyId">
                        <input type="hidden" id="ledgerPartyType">
                    </div>
                </div>

                <div id="ledgerViewSection" style="display:none;">
                    <h3>Ledger for <span id="ledgerPartyName"></span></h3>
                    <table id="ledgerTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reference</th>
                                <th>Type</th>
                                <th>Debit ()</th>
                                <th>Credit ()</th>
                                <th>Balance ()</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>

                    <div class="section-title">Manual Adjustment</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="manualAdjDate">
                        </div>
                        <div class="form-group">
                            <label>Debit ()</label>
                            <input type="number" id="manualAdjDebit" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Credit ()</label>
                            <input type="number" id="manualAdjCredit" step="0.01" value="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Note</label>
                            <input type="text" id="manualAdjNote" placeholder="Reason for adjustment">
                        </div>
                    </div>
                    <div class="button-group no-print">
                        <button type="button" onclick="saveManualAdjustment()" class="success"> Save
                            Adjustment</button>
                    </div>

                    <div style="background: #e8f8f5; padding: 15px; border-radius: 4px; margin-top: 30px;">
                        <h3 style="margin-top: 0;">Net Balance: <span class="currency" id="netBalance">0</span></h3>
                        <small id="balanceNote" style="color: #7f8c8d;"></small>
                    </div>
                </div>
            </div>

            <!-- Tab: Machine Size Control -->
            <div id="size-control" class="tab-content dark-surface">
                <h2>Machine Size Control & Status</h2>
                <p>Set current size being produced and machine status. Changes apply immediately to production tracking.
                </p>

                <div class="inventory-toolbar" style="margin-top: 10px;">
                    <div>
                        <select id="machineFilterSelect" class="form-control" onchange="setMachineFilter(this.value)">
                            <option value="All">All</option>
                            <option value="Header">Header</option>
                            <option value="Rolling">Rolling</option>
                            <option value="Furnace">Furnace</option>
                            <option value="Tampering">Tampering</option>
                            <option value="Plating">Plating</option>
                        </select>
                    </div>
                    <button class="group-btn" style="background: rgba(255,255,255,0.08); color:#ff9b9b;"
                        onclick="forceReinitializeMachines()">Reset Machines</button>
                </div>

                <div class="card" style="margin-top:16px;">
                    <h3 style="margin-top:0;">Pending Size Change Requests</h3>
                    <div id="size-control-change-requests" style="margin-top:12px;"></div>
                </div>

                <div id="size-control-grid" class="machine-grid">
                    <!-- Machine cards will be populated by JavaScript -->
                </div>
            </div>

            <!-- Tab: Dashboard -->
            <div id="dashboard" class="tab-content dark-surface">
                <h2>Machine Dashboard</h2>
                <p>Live visibility of every machine with shift-based totals. Use the controls below to request size
                    changes for specific machines.</p>

                <div class="inventory-toolbar" style="margin-top: 10px; flex-wrap: wrap; gap: 12px;">
                    <div>
                        <label style="display:block; font-size:0.85em; color:var(--text-secondary);">Machine Group</label>
                        <select id="dashboardStageFilter" class="form-control"
                            onchange="setDashboardStageFilter(this.value)">
                            <option value="All">All</option>
                            <option value="Header">Header</option>
                            <option value="Rolling">Rolling</option>
                            <option value="Furnace">Furnace</option>
                            <option value="Tampering">Tampering</option>
                            <option value="Plating">Plating</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; font-size:0.85em; color:var(--text-secondary);">Machine</label>
                        <select id="dashboardMachineSelect" class="form-control">
                            <option value="">Select Machine</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; font-size:0.85em; color:var(--text-secondary);">Target Size</label>
                        <select id="dashboardSizeSelect" class="form-control">
                            <option value="">Select Size</option>
                        </select>
                    </div>
                    <div style="flex:1; min-width:200px;">
                        <label style="display:block; font-size:0.85em; color:var(--text-secondary);">Notes (optional)</label>
                        <input type="text" id="dashboardChangeNote" class="form-control" placeholder="Add quick note for team">
                    </div>
                    <div style="align-self:flex-end;">
                        <button class="success" onclick="submitSizeChangeRequest()">Change</button>
                    </div>
                </div>

                <div class="card" style="margin-top: 16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0;">Pending Size Change Requests</h3>
                        <small style="color:var(--text-secondary);">Appears here and in Machine Size Control tab</small>
                    </div>
                    <div id="dashboard-change-requests" style="margin-top:12px;"></div>
                </div>

                <div id="dashboard-grid" class="machine-grid" style="margin-top: 20px;">
                    <!-- Dashboard machine cards -->
                </div>
            </div>

            <!-- Tab: Production Entry -->
            <div id="production-entry" class="tab-content dark-surface">
                <h2>Production Entry</h2>
                <p>Record production output from machines. Click on a machine to add bags.</p>

                <div class="production-controls"
                    style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <select id="productionFilterSelect" class="form-control" onchange="setProductionFilter(this.value)">
                            <option value="All">All Machines</option>
                            <option value="Header">Header</option>
                            <option value="Rolling">Rolling</option>
                            <option value="Furnace">Furnace</option>
                            <option value="Tampering">Tampering</option>
                            <option value="Plating">Plating</option>
                        </select>
                    </div>
                    <div class="date-display" style="font-size: 1.2em; font-weight: bold; color: var(--color-primary);">
                        Today: <span id="production-date"></span>
                    </div>
                </div>

                <div id="production-entry-grid" class="machine-grid">
                    <!-- Production cards will be populated by JavaScript -->
                </div>
            </div>

            <!-- Tab: Packing & Finished Goods -->
            <div id="packing" class="tab-content">
                <h2>Packing & Finished Goods</h2>
                <p>Pack items into finished goods and manage finished inventory.</p>

                <div id="packing-grid">
                <div class="packing-layout" style="display: flex; flex-direction: column; gap: 16px;">
                    <div class="finished-goods-section">
                        <div class="card">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3>Pending Orders (Quotes)</h3>
                            </div>
                            <div id="pending-orders-list" style="max-height: 500px; overflow-y: auto;">
                                <!-- Pending orders will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="finished-goods-section">
                        <div class="card">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3>Finished Goods Inventory</h3>
                                <span class="badge badge-ok" style="font-size: 1.2em;">Total: <span
                                        id="total-finished-goods">0</span> Bags</span>
                            </div>

                            <div id="finished-goods-list" style="max-height: 500px; overflow-y: auto;">
                                <!-- Finished goods list will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="packing-entry-section" style="margin-top: 8px;">
                        <div class="card">
                            <h3>Quick Packing Entry</h3>
                            <div class="form-group">
                                <label>Select Size</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="packing-size-search" placeholder="Search size..." list="packingSizeStageOptions"
                                        autocomplete="off" onchange="handlePackingSizeInput(this.value)">
                                    <datalist id="packingSizeStageOptions"></datalist>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Source Stage</label>
                                    <select id="packing-source-stage" onchange="updatePackingSizeOptions()">
                                        <option value="Rolling">Rolling</option>
                                        <option value="Plating">Plating</option>
                                        <option value="Furnace">Furnace</option>
                                        <option value="Tampering">Tampering</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Number of Bags</label>
                                    <input type="number" id="packing-bags" placeholder="Qty" min="1">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Remarks / Packets per Bag</label>
                                <input type="text" id="packing-remarks" placeholder="e.g. 20 packets of 1kg">
                            </div>

                            <div class="button-group">
                                <button class="success" onclick="packItems()"> Move to Finished Goods</button>
                                <button onclick="clearPackingForm()">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Tab: Inventory Tracking -->
            <div id="inventory" class="tab-content dark-surface">
                <div class="inventory-toolbar">
                    <h2>Inventory Tracking</h2>
                    <div class="inventory-search">
                        <input type="text" id="inventory-search" placeholder="Search inventory by size..."
                            oninput="filterInventoryBySize(this.value)">
                        <button type="button" onclick="clearInventorySearch()"></button>
                    </div>
                </div>

                <div id="inventory-search-info" class="inventory-search-info"></div>

                <div id="inventory-grid" class="inventory-grid">
                    <!-- Inventory stages will be populated by JavaScript -->
                </div>
            </div>

            <!-- MASTERS TAB -->
            <div id="masters" class="tab-content">
                <h2>Masters</h2>

                <div class="subtabs">
                    <button class="subtab-btn active"
                        onclick="switchMastersSubtab('masters-customers', this)">Customers</button>
                    <button class="subtab-btn"
                        onclick="switchMastersSubtab('masters-suppliers', this)">Suppliers</button>
                    <button class="subtab-btn" onclick="switchMastersSubtab('masters-sizes', this)">Sizes/Items</button>
                    <button class="subtab-btn" onclick="switchMastersSubtab('masters-machines', this)">Machines</button>
                </div>

                <div id="masters-customers" class="subtab-content active">
                    <h3>Customer Masters</h3>
                    <div class="button-group">
                        <button class="btn btn--primary" onclick="openAddCustomerModal()"> Add New Customer</button>
                        <button class="btn btn--secondary" onclick="openImportModal('customers')"> Import from
                            Excel</button>
                    </div>

                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAllCustomers" onchange="toggleSelectAll('customers')">
                        <label for="selectAllCustomers">Select All</label>
                        <select id="bulkActionCustomers" style="margin-left: 10px;">
                            <option value="">Bulk Actions</option>
                            <option value="edit">Edit Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button type="button" onclick="applyBulkAction('customers')"
                            class="btn btn--primary">Apply</button>
                    </div>

                    <table id="customersTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">Select</th>
                                <th>Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div id="masters-suppliers" class="subtab-content">
                    <h3>Supplier Masters</h3>
                    <div class="button-group">
                        <button class="btn btn--primary" onclick="openAddSupplierModal()"> Add New Supplier</button>
                        <button class="btn btn--secondary" onclick="openImportModal('suppliers')"> Import from
                            Excel</button>
                    </div>

                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAllSuppliers" onchange="toggleSelectAll('suppliers')">
                        <label for="selectAllSuppliers">Select All</label>
                        <select id="bulkActionSuppliers" style="margin-left: 10px;">
                            <option value="">Bulk Actions</option>
                            <option value="edit">Edit Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button type="button" onclick="applyBulkAction('suppliers')"
                            class="btn btn--primary">Apply</button>
                    </div>

                    <table id="suppliersTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">Select</th>
                                <th>Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div id="masters-sizes" class="subtab-content">
                    <h3>Size/Item Masters</h3>
                    <div class="button-group">
                        <button class="btn btn--primary" onclick="openAddSizeModal()"> Add New Size</button>
                        <button class="btn btn--secondary" onclick="openImportModal('sizes')"> Import from
                            Excel</button>
                    </div>

                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAllSizes" onchange="toggleSelectAll('sizes')">
                        <label for="selectAllSizes">Select All</label>
                        <select id="bulkActionSizes" style="margin-left: 10px;">
                            <option value="">Bulk Actions</option>
                            <option value="edit">Edit Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button type="button" onclick="applyBulkAction('sizes')" class="btn btn--primary">Apply</button>
                    </div>

                    <table id="sizesTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">Select</th>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Default Unit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div id="masters-machines" class="subtab-content">
                    <h3>Machine Masters</h3>
                    <div class="button-group">
                        <button class="btn btn--primary" onclick="openAddMachineModal()"> Add New Machine</button>
                        <button class="btn btn--secondary" onclick="openImportModal('machines')"> Import from
                            Excel</button>
                    </div>

                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAllMachines" onchange="toggleSelectAll('machines')">
                        <label for="selectAllMachines">Select All</label>
                        <select id="bulkActionMachines" style="margin-left: 10px;">
                            <option value="">Bulk Actions</option>
                            <option value="edit">Edit Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button type="button" onclick="applyBulkAction('machines')"
                            class="btn btn--primary">Apply</button>
                    </div>

                    <table id="machinesTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">Select</th>
                                <th>Machine Type</th>
                                <th>Display Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- INVENTORY TAB -->
            <div id="inventory" class="tab-content dark-surface">
                <div class="inventory-toolbar">
                    <div>
                        <h2>Inventory</h2>
                        <p>Real-time stock levels updated from sales and purchases.</p>
                    </div>
                    <div class="inventory-search">
                        <input type="text" id="inventorySearchInput"
                            placeholder="Search by item type (e.g., 'wire', 'screw', '2mm', etc.)">
                        <button type="button" onclick="clearInventorySearch()"></button>
                    </div>
                </div>
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Size/Item</th>
                            <th>Raw Wire (KG)</th>
                            <th>Finished Goods (PKT)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <!-- BACKUP TAB -->
            <div id="backup" class="tab-content">
                <h2>Backup & Restore</h2>
                <p>Save all data to JSON file or restore from backup.</p>

                <div class="button-group no-print">
                    <button type="button" onclick="downloadBackup()" class="success"> Download Backup</button>
                    <button type="button" onclick="document.getElementById('restoreFile').click()" class="success">
                        Restore from File</button>
                    <button type="button" onclick="cleanupDuplicateLedgers()" class="danger"> Cleanup Duplicate
                        Ledgers</button>
                    <button type="button" id="btnDedupePurchaseInvoices" class="danger" title="One-time cleanup to remove duplicate purchase invoices"> Clean Duplicate Purchase Invoices</button>
                    <button type="button" id="sizeIdCleanupBtn" onclick="startSizeIdMigration()" title="One-time data cleanup for quoted size IDs" class="danger"> Clean Size IDs (Remove Extra Quotes)</button>
                    <input type="file" id="restoreFile" style="display:none;" accept=".json"
                        onchange="restoreBackup(event)">
                </div>

                <div id="backupStatus"></div>
                <div id="sizeIdMigrationLog" style="margin-top:10px;font-size:12px;color:#374151;"></div>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- View Invoice Modal -->
    <div id="viewInvoiceModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('viewInvoiceModal')">&times;</span>
            <h3>Invoice Details</h3>
            <div id="invoiceContent"></div>
                <div class="button-group no-print" style="margin-top: 20px;">
                    <button type="button" onclick="window.print()" class="success"> Print Invoice</button>
                    <button type="button" onclick="closeModal('viewInvoiceModal')">Close</button>
                </div>
            </div>
        </div>

    <!-- View Quote Modal -->
    <div id="viewQuoteModal" class="modal">
        <div class="modal-content">
                <span class="modal-close" onclick="closeModal('viewQuoteModal')">&times;</span>
            <h3>Quote Details</h3>
            <div id="quoteContent"></div>
            <div class="button-group no-print" style="margin-top: 20px;">
                <button type="button" onclick="closeModal('viewQuoteModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('customerModal')">&times;</span>
            <h3>Add/Edit Customer</h3>
            <form id="customerForm" onsubmit="saveCustomer(event); return false;">
                <input type="hidden" id="customerId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Customer Name *</label>
                        <input type="text" id="customerName" required>
                    </div>
                </div>
                <button type="submit" class="success"> Save Customer</button>
                <button type="button" onclick="closeModal('customerModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Supplier Modal -->
    <div id="supplierModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('supplierModal')">&times;</span>
            <h3>Add/Edit Supplier</h3>
            <form id="supplierForm" onsubmit="saveSupplier(event); return false;">
                <input type="hidden" id="supplierId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Supplier Name *</label>
                        <input type="text" id="supplierName" required>
                    </div>
                </div>
                <button type="submit" class="success"> Save Supplier</button>
                <button type="button" onclick="closeModal('supplierModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Size Modal -->
    <div id="sizeModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('sizeModal')">&times;</span>
            <h3>Add/Edit Size/Item</h3>
            <form id="sizeForm" onsubmit="saveSize(event); return false;">
                <input type="hidden" id="sizeId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Code *</label>
                        <input type="text" id="sizeCode" required>
                    </div>
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="sizeName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Default Unit Type</label>
                        <select id="sizeUnitType">
                            <option value="KG">KG</option>
                            <option value="PKT">PKT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="sizeDesc">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Price per KG ()</label>
                        <input type="number" id="sizePriceKG" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Price per PKT ()</label>
                        <input type="number" id="sizePricePKT" step="0.01" min="0">
                    </div>
                </div>
                <button type="submit" class="success"> Save Size</button>
                <button type="button" onclick="closeModal('sizeModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Excel Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('importModal')">&times;</span>
            <h3 id="importModalTitle">Import Excel</h3>
            <input type="hidden" id="importType">

            <div id="importStep1">
                <p>Select Excel or CSV file to import:</p>
                <input type="file" id="importFile" accept=".xlsx,.xls,.csv" onchange="previewExcelFile(event)">
                <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">Supports XLSX, XLS, and CSV formats. All
                    rows will be imported (no limit).</p>
            </div>

            <div id="importStep2" style="display:none;">
                <p>Map columns from Excel to database fields:</p>
                <div id="columnMappingUI"></div>
                <button type="button" onclick="confirmImport()" class="success"> Import Data</button>
                <button type="button" onclick="cancelImport()">Cancel</button>
            </div>

            <div id="importStep3" style="display:none;">
                <div class="alert success" id="importMessage"> Import completed successfully!</div>
                <button type="button" onclick="closeModal('importModal')">Close</button>
            </div>
        </div>
    </div>

    <datalist id="sizeOptionsList"></datalist>
    <datalist id="quoteSizeOptions"></datalist>
    <div id="toast" aria-live="polite" aria-atomic="true"></div>

    <script>
        // ========== Firebase Configuration ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAvWG3-sFi3gjOzJj0AmpqK1M1KMTdA348",
            authDomain: "bokki-7bf3c.firebaseapp.com",
            databaseURL: "https://bokki-7bf3c-default-rtdb.firebaseio.com",
            projectId: "bokki-7bf3c",
            storageBucket: "bokki-7bf3c.firebasestorage.app",
            messagingSenderId: "1068686831368",
            appId: "1:1068686831368:web:96ed8e8a698e7900d0c6bd"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ========== Key Sanitization Functions ==========
        function sanitizeKey(key) {
            if (!key) return key;
            return key.toString()
                .replace(/\./g, '_dot_')
                .replace(/\#/g, '_hash_')
                .replace(/\$/g, '_dollar_')
                .replace(/\[/g, '_openbracket_')
                .replace(/\]/g, '_closebracket_')
                .replace(/\//g, '_slash_');
        }

        function unsanitizeKey(key) {
            if (!key) return key;
            return key.toString()
                .replace(/_dot_/g, '.')
                .replace(/_hash_/g, '#')
                .replace(/_dollar_/g, '$')
                .replace(/_openbracket_/g, '[')
                .replace(/_closebracket_/g, ']')
                .replace(/_slash_/g, '/');
        }

        function getInventorySizeKey(key) {
            return sanitizeKey(key || 'UNKNOWN_SIZE');
        }



        // Util: Promise timeout to avoid silent hangs on network/db issues
        function withTimeout(promise, ms, msg) {
            return Promise.race([
                promise,
                new Promise((_, reject) => setTimeout(() => reject(new Error(msg || 'Operation timed out')), ms))
            ]);
        }


        // Wait until Firebase .info/connected flips true (up to timeout). Returns boolean instead of throwing.
        async function waitForOnline(timeoutMs = 8000) {
            const start = Date.now();
            while (!isConnected && (Date.now() - start) < timeoutMs) {
                await new Promise(r => setTimeout(r, 150));
            }
            return isConnected;
        }
        // ========== Firebase Helper Functions ==========
        let isConnected = false;
        let offlineTimer = null;

        function markConnecting() {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl && statusEl.textContent !== ' Online') {
                statusEl.textContent = ' Connecting...';
                statusEl.className = 'connection-status disconnected';
            }
        }

        // Check Firebase connection status
        function checkConnection() {
            const connectedRef = firebase.database().ref(".info/connected");
            connectedRef.on("value", function (snap) {
                if (snap.val() === true) {
                    clearTimeout(offlineTimer);
                    offlineTimer = null;
                    markOnline();
                    flushPendingWrites();
                } else {
                    isConnected = false;
                    markConnecting();
                    clearTimeout(offlineTimer);
                    offlineTimer = setTimeout(() => {
                        if (!isConnected) {
                            const statusEl = document.getElementById('connectionStatus');
                            if (statusEl) {
                                statusEl.textContent = ' Offline';
                                statusEl.className = 'connection-status disconnected';
                            }
                        }
                    }, 7000);
                }
                App.ui.updatePendingBadge();
            });
        }

        // Firebase database helper functions
        async function fbInsert(storeName, data) {
            const ref = database.ref(storeName).push();
            const key = ref.key;
            if (data.id) {
                data.id = sanitizeKey(data.id);
            }
            await withTimeout(ref.set(data), 12000, 'DB write timed out');
            markOnline();
            return key;
        }

        async function fbPut(storeName, key, data) {
            const sanitizedKey = sanitizeKey(key);
            if (data.id) {
                data.id = sanitizeKey(data.id);
            }
            await withTimeout(database.ref(`${storeName}/${sanitizedKey}`).set(data), 12000, 'DB write timed out');
            markOnline();
            return sanitizedKey;
        }

        async function fbDelete(storeName, key) {
            const sanitizedKey = sanitizeKey(key);
            await database.ref(`${storeName}/${sanitizedKey}`).remove();
            markOnline();
        }

        async function fbGet(storeName, key) {
            const sanitizedKey = sanitizeKey(key);
            const snapshot = await database.ref(`${storeName}/${sanitizedKey}`).once('value');
            const data = snapshot.val();
            markOnline();
            if (data && data.id) {
                data.id = unsanitizeKey(data.id);
            }
            return data;
        }

        async function fbGetAll(storeName) {
            const snapshot = await database.ref(storeName).once('value');
            const results = [];
            snapshot.forEach((childSnapshot) => {
                let data = childSnapshot.val();
                if (data && data.id) {
                    data.id = unsanitizeKey(data.id);
                }
                results.push({
                    ...data,
                    id: data.id || childSnapshot.key
                });
            });
            markOnline();
            return results;
        }

        // ========== Core App Namespace & Utilities ==========
        const App = {
            state: {
                customers: [],
                suppliers: [],
                sizes: [],
                invoices: { sales: [], purchase: [] },
                pendingWrites: [],
                role: 'Admin',
                currentUser: null
            },
            cache: {
                customersById: {},
                suppliersById: {},
                sizesById: {}
            },
            permissions: {
                Admin: { editInvoices: true, deleteInvoices: true, manageMasters: true, viewReports: true },
                Manager: { editInvoices: true, deleteInvoices: false, manageMasters: true, viewReports: true },
                Viewer: { editInvoices: false, deleteInvoices: false, manageMasters: false, viewReports: true }
            },
            utils: {},
            ui: {},
            db: {},
            invoiceEngine: {}
        };
        window.App = App;

        function loadPendingQueue() {
            try {
                const raw = localStorage.getItem('factory_pending_writes');
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (err) {
                console.warn('Failed to parse pending queue', err);
                return [];
            }
        }

        function persistPendingQueue() {
            try {
                localStorage.setItem('factory_pending_writes', JSON.stringify(App.state.pendingWrites.slice(0, 50)));
            } catch (err) {
                console.warn('Unable to persist pending queue', err);
            }
        }

        App.ui.updatePendingBadge = function () {
            const badge = document.getElementById('pendingSyncBadge');
            if (!badge) return;
            const count = App.state.pendingWrites.length;
            badge.textContent = count ? `${count} pending` : '';
            badge.style.display = count ? 'inline-flex' : 'none';
        };

        App.state.pendingWrites = loadPendingQueue();
        App.ui.updatePendingBadge();

        App.ui.toastTimeout = null;
        App.ui.showToast = function (message, type = 'info') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.className = '';
            toast.textContent = message;
            toast.classList.add('show', type);
            clearTimeout(App.ui.toastTimeout);
            App.ui.toastTimeout = setTimeout(() => {
                toast.classList.remove('show', 'success', 'error', 'warning', 'info');
            }, 3600);
        };

        App.utils.debounce = function (fn, wait = 300) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(null, args), wait);
            };
        };

        App.utils.formatCurrency = (num) => `${(Number(num) || 0).toFixed(2)}`;

        App.utils.resolveName = function (type, id, fallback = 'N/A') {
            if (!id) return fallback;
            const map = type === 'customer' ? App.cache.customersById : App.cache.suppliersById;
            const record = map[id];
            if (record) {
                return record.display_name || record.supplier_name || record.name || fallback;
            }
            return fallback;
        };

        App.utils.resolveSizeName = function (sizeId, fallback = 'N/A') {
            if (!sizeId) return fallback;
            const size = App.cache.sizesById[sizeId];
            return (size && (size.size_name || size.code || size.name)) || fallback;
        };

        // Migration helper: clean quoted size IDs like "\"ID_123\"" or "'ID_123'" -> ID_123
        function cleanSizeIdForMigration(raw) {
            if (raw === null || raw === undefined) return raw;
            if (typeof raw !== 'string') return raw;
            let s = raw.trim();
            if ((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))) {
                s = s.slice(1, -1);
            }
            return s;
        }

        function markOnline() {
            isConnected = true;
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.textContent = ' Online';
                statusEl.className = 'connection-status connected';
            }
        }

        // Core data snapshot loader to populate state even if realtime listeners lag
        async function fetchCoreDataSnapshot() {
            try {
                const [customers, suppliers, sizes, sales, purchases] = await Promise.all([
                    fbGetAll('customers').catch(() => []),
                    fbGetAll('suppliers').catch(() => []),
                    fbGetAll('sizes').catch(() => []),
                    fbGetAll('salesInvoices').catch(() => []),
                    fbGetAll('purchaseInvoices').catch(() => [])
                ]);
                updateCaches(customers, 'customers');
                updateCaches(suppliers, 'suppliers');
                updateCaches(sizes, 'sizes');
                App.state.invoices.sales = sales.map(v => normalizeInvoice(v, 'sales', v.id));
                App.state.invoices.purchase = purchases.map(v => normalizeInvoice(v, 'purchase', v.id));
                debouncedRefreshCustomersTable();
                debouncedRefreshSuppliersTable();
                debouncedRefreshSizesTable();
                debouncedRefreshSalesInvoiceList();
                debouncedRefreshPurchaseInvoiceList();
            } catch (err) {
                console.warn('Core data snapshot fetch failed', err);
            }
        }

        // Wire up search inputs to live filtering
        function bindInvoiceSearchListeners() {
            const salesSearchEl = document.getElementById('salesInvoiceSearch');
            if (salesSearchEl) {
                salesSearchEl.addEventListener('input', () => App.invoiceEngine.renderInvoiceTable('sales'));
            }
            const purchaseSearchEl = document.getElementById('purchaseInvoiceSearch');
            if (purchaseSearchEl) {
                purchaseSearchEl.addEventListener('input', () => App.invoiceEngine.renderInvoiceTable('purchase'));
            }
            const purchaseCategoryEl = document.getElementById('purchaseCategoryFilter');
            if (purchaseCategoryEl) {
                purchaseCategoryEl.addEventListener('change', () => App.invoiceEngine.renderInvoiceTable('purchase'));
            }
        }

        function bindDedupePurchaseButton() {
            const btn = document.getElementById('btnDedupePurchaseInvoices');
            if (!btn) return;
            btn.addEventListener('click', async () => {
                const ok = confirm('This will scan purchase invoices and remove exact duplicate copies from the database. One copy is kept and deletions are logged. Run now?');
                if (!ok) return;
                const originalText = btn.textContent;
                try {
                    btn.disabled = true;
                    btn.textContent = 'Cleaning duplicates...';
                    await App.db.dedupePurchaseInvoices();
                } catch (err) {
                    console.error('Purchase invoice dedupe failed', err);
                    alert('Error cleaning duplicate purchase invoices: ' + (err && err.message ? err.message : err));
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            });
        }

        // Shared helpers for reports to ensure consistent totals
        async function getReportInvoices(type) {
            try {
                return await App.db.listInvoices(type);
            } catch (err) {
                console.warn(`Report fetch failed for ${type}, falling back to cache`, err);
                return Array.isArray(App.state.invoices[type === 'sales' ? 'sales' : 'purchase']) ? App.state.invoices[type === 'sales' ? 'sales' : 'purchase'] : [];
            }
        }

        function computeInvoiceTotalsForReport(inv, type) {
            const lines = Array.isArray(inv.lines) ? inv.lines : [];
            return App.invoiceEngine.calculateTotals(type, lines, inv.invoice_tax);
        }

        // ======== One-time Size ID Cleanup Migration ========
        function appendSizeIdLog(msg) {
            console.log('[SizeIDMigration]', msg);
            const logBox = document.getElementById('sizeIdMigrationLog');
            if (logBox) {
                const line = document.createElement('div');
                line.textContent = msg;
                logBox.appendChild(line);
            }
        }

        function startSizeIdMigration() {
            if (!confirm('This will scan Firebase and clean size IDs stored like \"ID_123\" or \'ID_123\'. It will not delete data. Run now?')) return;
            const btn = document.getElementById('sizeIdCleanupBtn');
            if (btn) btn.disabled = true;
            runSizeIdCleanupMigration().finally(() => { if (btn) btn.disabled = false; });
        }

        // ======== Core App Init ========
        async function initApp() {
            try {
                checkConnection();
                setupRealtimeListeners();
                fetchCoreDataSnapshot();
                if (!localStorage.getItem('purchaseSupplierNameFixApplied')) {
                    try {
                        await ensurePurchaseSupplierNames();
                        localStorage.setItem('purchaseSupplierNameFixApplied', 'yes');
                    } catch (err) {
                        console.warn('supplier name repair failed', err);
                    }
                }
                // Set default dates
                const today = getToday();
                const firstDay = getFirstDayOfMonth ? getFirstDayOfMonth() : today;
                if (document.getElementById('saleDate')) document.getElementById('saleDate').value = today;
                if (document.getElementById('purchaseDate')) document.getElementById('purchaseDate').value = today;
                if (document.getElementById('manualAdjDate')) document.getElementById('manualAdjDate').value = today;
                if (document.getElementById('reportPLFromDate')) document.getElementById('reportPLFromDate').value = firstDay;
                if (document.getElementById('reportPLToDate')) document.getElementById('reportPLToDate').value = today;
                if (document.getElementById('reportPLTaxFromDate')) document.getElementById('reportPLTaxFromDate').value = firstDay;
                if (document.getElementById('reportPLTaxToDate')) document.getElementById('reportPLTaxToDate').value = today;
                if (document.getElementById('reportGSTFromDate')) document.getElementById('reportGSTFromDate').value = firstDay;
                if (document.getElementById('reportGSTToDate')) document.getElementById('reportGSTToDate').value = today;
                if (document.getElementById('reportSizeFromDate')) document.getElementById('reportSizeFromDate').value = firstDay;
                if (document.getElementById('reportSizeToDate')) document.getElementById('reportSizeToDate').value = today;
                if (document.getElementById('reportSizePurchaseFromDate')) document.getElementById('reportSizePurchaseFromDate').value = firstDay;
                if (document.getElementById('reportSizePurchaseToDate')) document.getElementById('reportSizePurchaseToDate').value = today;
            } catch (err) {
                console.error('Error in initApp', err);
            }
        }

        async function runSizeIdCleanupMigration() {
            const result = {
                totalUpdated: 0,
                perPath: {}
            };
            const tasks = [
                {
                    path: 'salesInvoices',
                    handler: (val, childKey, updates) => {
                        (val.lines || []).forEach((line, idx) => {
                            ['size_id', 'sizeId', 'current_size'].forEach(k => {
                                const cleaned = cleanSizeIdForMigration(line[k]);
                                if (cleaned !== line[k]) {
                                    updates[`${childKey}/lines/${idx}/${k}`] = cleaned;
                                    result.totalUpdated++;
                                }
                            });
                        });
                    }
                },
                {
                    path: 'purchaseInvoices',
                    handler: (val, childKey, updates) => {
                        (val.lines || []).forEach((line, idx) => {
                            ['size_id', 'sizeId', 'current_size'].forEach(k => {
                                const cleaned = cleanSizeIdForMigration(line[k]);
                                if (cleaned !== line[k]) {
                                    updates[`${childKey}/lines/${idx}/${k}`] = cleaned;
                                    result.totalUpdated++;
                                }
                            });
                        });
                    }
                },
                {
                    path: 'quotes',
                    handler: (val, childKey, updates) => {
                        (val.lines || []).forEach((line, idx) => {
                            ['size_id', 'sizeId'].forEach(k => {
                                const cleaned = cleanSizeIdForMigration(line[k]);
                                if (cleaned !== line[k]) {
                                    updates[`${childKey}/lines/${idx}/${k}`] = cleaned;
                                    result.totalUpdated++;
                                }
                            });
                        });
                    }
                },
                {
                    path: 'stockLevels',
                    handler: (val, childKey, updates) => {
                        const cleaned = cleanSizeIdForMigration(val.size_id);
                        if (cleaned !== val.size_id) {
                            updates[`${childKey}/size_id`] = cleaned;
                            result.totalUpdated++;
                        }
                    }
                },
                {
                    path: 'productionEntries',
                    handler: (val, childKey, updates) => {
                        const cleaned = cleanSizeIdForMigration(val.size_id || val.sizeId);
                        if (cleaned !== (val.size_id || val.sizeId)) {
                            if (val.size_id !== undefined) updates[`${childKey}/size_id`] = cleaned;
                            if (val.sizeId !== undefined) updates[`${childKey}/sizeId`] = cleaned;
                            result.totalUpdated++;
                        }
                    }
                },
                {
                    path: 'packingEntries',
                    handler: (val, childKey, updates) => {
                        const cleaned = cleanSizeIdForMigration(val.size_id || val.sizeId);
                        if (cleaned !== (val.size_id || val.sizeId)) {
                            if (val.size_id !== undefined) updates[`${childKey}/size_id`] = cleaned;
                            if (val.sizeId !== undefined) updates[`${childKey}/sizeId`] = cleaned;
                            result.totalUpdated++;
                        }
                    }
                }
            ];

            appendSizeIdLog('Starting size ID cleanup...');
            for (const task of tasks) {
                try {
                    const snap = await database.ref(task.path).once('value');
                    if (!snap.exists()) {
                        appendSizeIdLog(`${task.path}: no data`);
                        continue;
                    }
                    const updates = {};
                    snap.forEach(child => {
                        const val = child.val() || {};
                        task.handler(val, child.key, updates);
                    });
                    const count = Object.keys(updates).length;
                    if (count > 0) {
                        await database.ref(task.path).update(updates);
                    }
                    result.perPath[task.path] = count;
                    appendSizeIdLog(`${task.path}: updated ${count} fields`);
                } catch (err) {
                    appendSizeIdLog(`${task.path}: error ${err.message}`);
                    console.error('[SizeIDMigration]', task.path, err);
                }
            }
            appendSizeIdLog(`Size ID cleanup finished. Total fields cleaned: ${result.totalUpdated}`);
            return result;
        }

        App.utils.markInvalid = function (element, message) {
            if (!element) return;
            element.classList.add('input-error');
            if (message) {
                element.setAttribute('title', message);
                element.dataset.error = message;
            }
            element.setAttribute('aria-invalid', 'true');
        };

        App.utils.clearValidation = function (container) {
            if (!container) return;
            container.querySelectorAll('.input-error').forEach(el => {
                el.classList.remove('input-error');
                el.removeAttribute('aria-invalid');
                el.removeAttribute('data-error');
                el.removeAttribute('title');
            });
        };

        function applyPerformanceMode(enabled) {
            const body = document.body;
            if (!body) return;
            if (enabled) {
                body.classList.add('performance-mode');
            } else {
                body.classList.remove('performance-mode');
            }
            const btn = document.getElementById('perfToggle');
            if (btn) {
                btn.textContent = enabled ? ' Performance: ON' : ' Performance';
            }
            try { localStorage.setItem('factory_perf_mode', enabled ? '1' : '0'); } catch (e) { }
        }

        function togglePerformanceMode() {
            const enabled = !document.body.classList.contains('performance-mode');
            applyPerformanceMode(enabled);
            App.ui.showToast(enabled ? 'Performance mode enabled' : 'Performance mode disabled', 'info');
        }

        App.ui.requireOnline = function () {
            if (!isConnected) {
                App.ui.showToast('Connection uncertain. Will attempt and sync when online.', 'warning');
            }
            return true;
        };

        App.hasPermission = function (capability) {
            const role = App.state.role || 'Admin';
            return !!(App.permissions[role] && App.permissions[role][capability]);
        };

        function updateCaches(list, targetKey) {
            if (!Array.isArray(list)) return;
            App.state[targetKey] = list;
            const map = {};
            list.forEach(item => {
                if (!item || !item.id) return;
                map[item.id] = item;
            });
            if (targetKey === 'customers') {
                App.cache.customersById = map;
            } else if (targetKey === 'suppliers') {
                App.cache.suppliersById = map;
            } else if (targetKey === 'sizes') {
                App.cache.sizesById = map;
            }
        }

        function enqueueWrite(action) {
            App.state.pendingWrites.push(action);
            persistPendingQueue();
            App.ui.updatePendingBadge();
        }

        async function flushPendingWrites() {
            if (!isConnected || !App.state.pendingWrites.length) return;
            const remaining = [];
            for (const job of App.state.pendingWrites) {
                try {
                    if (job.type === 'put') {
                        await fbPut(job.path, job.key, job.payload);
                    } else if (job.type === 'push') {
                        await fbInsert(job.path, job.payload);
                    } else if (job.type === 'delete') {
                        await fbDelete(job.path, job.key);
                    }
                } catch (err) {
                    console.warn('Retry failed for job', job, err);
                    remaining.push(job);
                }
            }
            App.state.pendingWrites = remaining;
            persistPendingQueue();
            App.ui.updatePendingBadge();
        }
        // Real-time listeners for data updates

        // DEBOUNCE TIMERS TO PREVENT DUPLICATE REFRESHES
        let salesRefreshTimer = null;
        let purchaseRefreshTimer = null;
        let customersRefreshTimer = null;
        let suppliersRefreshTimer = null;
        let sizesRefreshTimer = null;
        let inventoryRefreshTimer = null;
        let logsRefreshTimer = null;

        function debouncedRefreshSalesInvoiceList() {
            clearTimeout(salesRefreshTimer);
            salesRefreshTimer = setTimeout(() => {
                refreshSalesInvoiceList();
            }, 300);
        }

        function debouncedRefreshPurchaseInvoiceList() {
            clearTimeout(purchaseRefreshTimer);
            purchaseRefreshTimer = setTimeout(() => {
                refreshPurchaseInvoiceList();
            }, 300);
        }

        function debouncedRefreshCustomersTable() {
            clearTimeout(customersRefreshTimer);
            customersRefreshTimer = setTimeout(() => {
                refreshCustomersTable();
            }, 300);
        }

        function debouncedRefreshSuppliersTable() {
            clearTimeout(suppliersRefreshTimer);
            suppliersRefreshTimer = setTimeout(() => {
                refreshSuppliersTable();
            }, 300);
        }

        function debouncedRefreshSizesTable() {
            clearTimeout(sizesRefreshTimer);
            sizesRefreshTimer = setTimeout(() => {
                refreshSizesTable();
            }, 300);
        }

        function debouncedRefreshInventoryTable() {
            clearTimeout(inventoryRefreshTimer);
            inventoryRefreshTimer = setTimeout(() => {
                refreshInventoryTable();
            }, 300);
        }

        function debouncedRefreshLogsTable() {
            clearTimeout(logsRefreshTimer);
            logsRefreshTimer = setTimeout(() => {
                activityLogsCache = [];
                if (document.getElementById('report-activity-logs')?.classList.contains('active')) {
                    generateActivityLogs(true);
                }
            }, 400);
        }

        function setupRealtimeListeners() {
            // Customers - debounced
            database.ref('customers').on('value', (snapshot) => {
                const list = [];
                snapshot.forEach(child => {
                    const val = child.val() || {};
                    val.id = val.id || child.key;
                    list.push(val);
                });
                updateCaches(list, 'customers');
                debouncedRefreshCustomersTable();
            });

            // Suppliers - debounced
            database.ref('suppliers').on('value', (snapshot) => {
                const list = [];
                snapshot.forEach(child => {
                    const val = child.val() || {};
                    val.id = val.id || child.key;
                    list.push(val);
                });
                updateCaches(list, 'suppliers');
                debouncedRefreshSuppliersTable();
            });

            // Sizes - debounced
            database.ref('sizes').on('value', (snapshot) => {
                const list = [];
                snapshot.forEach(child => {
                    const val = child.val() || {};
                    val.id = val.id || child.key;
                    list.push(val);
                });
                updateCaches(list, 'sizes');
                debouncedRefreshSizesTable();
            });

            // Sales Invoices - debounced
            database.ref('salesInvoices').on('value', (snapshot) => {
                const list = [];
                const seen = new Set();
                snapshot.forEach(child => {
                    const norm = normalizeInvoice(child.val(), 'sales', child.key);
                    if (!norm) return;
                    const key = norm.invoice_id;
                    if (seen.has(key)) return;
                    seen.add(key);
                    list.push(norm);
                });
                App.state.invoices.sales = list;
                debouncedRefreshSalesInvoiceList();
            });

            // Purchase Invoices - debounced
            database.ref('purchaseInvoices').on('value', (snapshot) => {
                const list = [];
                const seen = new Set();
                snapshot.forEach(child => {
                    const norm = normalizeInvoice(child.val(), 'purchase', child.key);
                    if (!norm) return;
                    const key = norm.purchase_id;
                    if (seen.has(key)) return;
                    seen.add(key);
                    list.push(norm);
                });
                App.state.invoices.purchase = list;
                debouncedRefreshPurchaseInvoiceList();
            });

            // Stock Levels - debounced
            database.ref('stockLevels').on('value', (snapshot) => {
                debouncedRefreshInventoryTable();
            });

            // Activity Logs - debounced refresh (only fetch when needed)
            if (database.ref('activityLogs')) {
                database.ref('activityLogs').limitToLast(300).on('value', () => {
                    debouncedRefreshLogsTable();
                });
            }
        }

        // ========== Database Facade ==========
        const INVOICE_PATH = { sales: 'salesInvoices', purchase: 'purchaseInvoices' };

        function normalizeInvoice(raw, type, keyFromDb) {
            if (!raw) return null;
            const isPurchase = type === 'purchase';
            const normalized = { ...raw };
            const id = isPurchase
                ? (raw.purchase_id || raw.purchaseId || raw.id || raw.invoice_id || keyFromDb)
                : (raw.invoice_id || raw.invoiceId || raw.id || keyFromDb);
            const partyId = isPurchase
                ? (raw.supplier_id || raw.supplierId || raw.supplier || raw.supplierid || raw.supplier_name)
                : (raw.customer_id || raw.customerId || raw.customer || raw.customerid || raw.customer_name);
            normalized.type = type;
            if (isPurchase) {
                normalized.purchase_id = id;
                normalized.purchaseId = id;
                normalized.supplierId = partyId || '';
            } else {
                normalized.invoice_id = id;
                normalized.invoiceId = id;
                normalized.customerId = partyId || '';
            }
            if (!normalized.date && raw.invoice_date) normalized.date = raw.invoice_date;
            if (isPurchase) {
                normalized.supplier_id = partyId || '';
            } else {
                normalized.customer_id = partyId || '';
            }
            normalized.lines = Array.isArray(raw.lines) ? raw.lines : (Array.isArray(raw.line_items) ? raw.line_items : []);
            normalized.invoice_subtotal = raw.invoice_subtotal ?? raw.subtotal ?? 0;
            normalized.invoice_line_tax_total = raw.invoice_line_tax_total ?? raw.line_tax_total ?? 0;
            normalized.invoice_tax = raw.invoice_tax ?? raw.additional_tax ?? 0;
            normalized.invoice_grand_total = raw.invoice_grand_total ?? raw.total ?? 0;
            if (!normalized._key) normalized._key = keyFromDb || id;
            return normalized;
        }

        async function safePut(path, key, payload) {
            if (!App.ui.requireOnline()) {
                enqueueWrite({ type: 'put', path, key, payload });
                return key;
            }
            return fbPut(path, key, payload);
        }

        async function safePush(path, payload) {
            const tempKey = payload.id || payload.invoice_id || payload.purchase_id || `${path}-${Date.now()}`;
            if (!App.ui.requireOnline()) {
                enqueueWrite({ type: 'push', path, payload: { ...payload, id: tempKey } });
                return tempKey;
            }
            return fbInsert(path, payload);
        }

        async function safeDelete(path, key) {
            if (!App.ui.requireOnline()) {
                enqueueWrite({ type: 'delete', path, key });
                return;
            }
            return fbDelete(path, key);
        }

        App.db.saveInvoice = async function (type, invoice) {
            const path = INVOICE_PATH[type] || type;
            const key = type === 'sales'
                ? (invoice.invoice_id || invoice.invoiceId || invoice.id)
                : (invoice.purchase_id || invoice.invoice_id || invoice.invoiceId || invoice.id);
            if (!key) throw new Error('Invoice key missing');
            const payload = { ...invoice };
            payload.type = type;
            if (type === 'sales') payload.invoice_id = key;
            if (type === 'purchase') payload.purchase_id = key;
            await safePut(path, key, payload);
            const cacheKey = type === 'sales' ? 'sales' : 'purchase';
            const existing = Array.isArray(App.state.invoices[cacheKey]) ? [...App.state.invoices[cacheKey]] : [];
            const idx = existing.findIndex(inv => (inv.invoice_id || inv.purchase_id || inv.id) === key);
            const normalized = normalizeInvoice(payload, type, key);
            if (idx >= 0) existing[idx] = normalized; else existing.push(normalized);
            App.state.invoices[cacheKey] = existing;
            return key;
        };

        App.db.listInvoices = async function (type) {
            const cacheKey = type === 'sales' ? 'sales' : 'purchase';
            const cached = App.state.invoices[cacheKey];
            if (Array.isArray(cached) && cached.length) return cached;
            const path = INVOICE_PATH[type] || type;
            try {
                const list = await fbGetAll(path);
                const normalizedList = [];
                const seen = new Set();
                list.forEach(item => {
                    const norm = normalizeInvoice(item, type, item.id);
                    if (!norm) return;
                    const key = type === 'sales' ? norm.invoice_id : norm.purchase_id;
                    if (seen.has(key)) return;
                    seen.add(key);
                    normalizedList.push(norm);
                });
                App.state.invoices[cacheKey] = normalizedList;
                return normalizedList;
            } catch (err) {
                console.warn(`Unable to load ${type} invoices from server`, err);
                return Array.isArray(cached) ? cached : [];
            }
        };

        App.db.getInvoice = async function (type, id) {
            const list = await App.db.listInvoices(type);
            const found = list.find(inv => inv.invoice_id === id || inv.purchase_id === id || inv.id === id);
            if (found) return found;
            const path = INVOICE_PATH[type] || type;
            const raw = await fbGet(path, id);
            return normalizeInvoice(raw, type, id);
        };

        App.db.deleteInvoice = async function (type, id) {
            const path = INVOICE_PATH[type] || type;
            await safeDelete(path, id);
            const cacheKey = type === 'sales' ? 'sales' : 'purchase';
            if (Array.isArray(App.state.invoices[cacheKey])) {
                App.state.invoices[cacheKey] = App.state.invoices[cacheKey].filter(inv => (inv.invoice_id || inv.purchase_id || inv.id) !== id);
            }
        };

        App.db.dedupePurchaseInvoices = async function () {
            if (!isConnected) return;
            try {
                if (localStorage.getItem('factory_purchase_dedupe_done') === '1') return;
            } catch (e) { }
            try {
                const rawList = await fbGetAll(INVOICE_PATH.purchase);
                const groups = {};
                rawList.forEach(item => {
                    const norm = normalizeInvoice(item, 'purchase', item.id);
                    if (!norm || !norm.purchase_id) return;
                    const key = norm.purchase_id;
                    if (!groups[key]) groups[key] = [];
                    groups[key].push({ norm, raw: item });
                });
                const deletions = [];
                Object.values(groups).forEach(items => {
                    if (items.length <= 1) return;
                    const signature = (inv) => JSON.stringify({
                        date: inv.date,
                        supplier_id: inv.supplier_id,
                        subtotal: inv.invoice_subtotal,
                        lineTax: inv.invoice_line_tax_total,
                        invoiceTax: inv.invoice_tax,
                        grand: inv.invoice_grand_total,
                        lines: (inv.lines || []).map(l => ({
                            category: l.category,
                            size: l.size_id || l.size,
                            qty: l.qty,
                            rate: l.rate_per_unit || l.rate,
                            tax: l.tax_per_unit || l.tax,
                            stage: l.stage,
                            total: l.line_grand_total || l.line_total_before_tax
                        }))
                    });
                    const bySig = {};
                    items.forEach(entry => {
                        const sig = signature(entry.norm);
                        if (!bySig[sig]) bySig[sig] = [];
                        bySig[sig].push(entry);
                    });
                    Object.values(bySig).forEach(list => {
                        if (list.length <= 1) return;
                        // keep first, delete rest
                        list.slice(1).forEach(extra => {
                            const deleteKey = extra.raw.id || extra.norm._key || extra.norm.purchase_id;
                            deletions.push({ key: deleteKey, purchase_id: extra.norm.purchase_id });
                        });
                    });
                });
                for (const del of deletions) {
                    await safeDelete(INVOICE_PATH.purchase, del.key);
                    App.db.log({
                        action: 'purchase.invoice.dedupe.delete',
                        entityType: 'purchaseInvoice',
                        entityId: del.purchase_id,
                        description: `Removed duplicate purchase invoice ${del.purchase_id} (key ${del.key})`
                    });
                }
                if (deletions.length) {
                    App.ui.showToast(`Cleaned ${deletions.length} duplicate purchase invoices`, 'success');
                }
                try { localStorage.setItem('factory_purchase_dedupe_done', '1'); } catch (e) { }
            } catch (err) {
                console.warn('Deduplication failed', err);
            }
        };

        App.db.saveMaster = async function (kind, payload) {
            if (!payload.id) throw new Error('Missing master id');
            await safePut(kind, payload.id, payload);
            const existing = Array.isArray(App.state[kind]) ? App.state[kind] : [];
            const updated = existing.filter(item => item.id !== payload.id).concat(payload);
            updateCaches(updated, kind);
            return payload.id;
        };

        App.db.deleteMaster = async function (kind, id) {
            await safeDelete(kind, id);
        };

        App.db.log = async function (details) {
            const userName = details.user || details.userName || (typeof getCurrentUserName === 'function' ? getCurrentUserName() : (App.state.currentUser?.name || 'User'));
            const userId = details.userId || (App.state.currentUser?.id || userName || 'local');
            const entry = {
                id: details.id || `LOG-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                timestamp: details.timestamp || new Date().toISOString(),
                action: details.action || 'event',
                entityType: details.entityType || '',
                entityId: details.entityId || '',
                userId,
                user: userName || userId,
                role: details.role || App.state.role || 'Admin',
                description: details.description || '',
                details: details.details || details.extra || {},
                extra: details.extra || details.details || {}
            };
            await safePut('activityLogs', entry.id, entry);
            if (typeof appState !== 'undefined') {
                if (!Array.isArray(appState.activityLogs)) appState.activityLogs = [];
                appState.activityLogs.unshift(entry);
                appState.activityLogs = appState.activityLogs.slice(0, 500);
            }
            if (!Array.isArray(activityLogsCache)) activityLogsCache = [];
            activityLogsCache.unshift(entry);
            activityLogsCache = activityLogsCache.slice(0, 500);
            if (document.getElementById('report-activity-logs')?.classList.contains('active')) {
                setTimeout(() => generateActivityLogs(true), 50);
            }
            return entry;
        };

        // ========== Invoice Engine (Shared) ==========
        App.invoiceEngine.normalizeLines = function (type, lines) {
            if (!Array.isArray(lines)) return [];
            return lines.map((line, idx) => {
                const qty = parseFloat(line.qty) || 0;
                const rate = parseFloat(line.rate_per_unit || line.rate) || 0;
                const disc = parseFloat(line.discount_pct || 0);
                const taxPerUnit = parseFloat(line.tax_per_unit || line.tax) || 0;
                const base = qty * rate;
                const discountAmt = base * (disc / 100);
                const beforeTax = (typeof line.line_total_before_tax === 'number') ? line.line_total_before_tax : (base - discountAmt);
                const lineTax = (typeof line.line_tax_total === 'number') ? line.line_tax_total : (qty * taxPerUnit);
                const grand = (typeof line.line_grand_total === 'number') ? line.line_grand_total : (beforeTax + lineTax);
                return {
                    ...line,
                    line_id: line.line_id || idx + 1,
                    qty,
                    rate_per_unit: rate,
                    discount_pct: disc,
                    tax_per_unit: taxPerUnit,
                    line_total_before_tax: beforeTax,
                    line_tax_total: lineTax,
                    line_grand_total: grand
                };
            });
        };

        App.invoiceEngine.calculateTotals = function (type, lines, invoiceTaxValue) {
            const normalized = App.invoiceEngine.normalizeLines(type, lines);
            const subtotal = normalized.reduce((sum, l) => sum + (l.line_total_before_tax || 0), 0);
            const lineTax = normalized.reduce((sum, l) => sum + (l.line_tax_total || 0), 0);
            let invoiceTax = typeof invoiceTaxValue === 'number' && !isNaN(invoiceTaxValue) ? invoiceTaxValue : 0;
            if (type === 'sales') {
                invoiceTax = subtotal * 0.18;
            }
            const grand = subtotal + lineTax + invoiceTax;
            return { subtotal, lineTax, invoiceTax, grand, lines: normalized };
        };

        App.invoiceEngine.nextInvoiceId = async function (type) {
            const todayPart = getToday().replace(/-/g, '');
            const prefix = type === 'sales' ? 'S' : 'P';
            const invoices = await App.db.listInvoices(type);
            const count = invoices.filter(inv => {
                const key = inv.invoice_id || inv.purchase_id || inv.id || '';
                return key.includes(todayPart);
            }).length;
            return `${prefix}-${todayPart}-${String(count + 1).padStart(3, '0')}`;
        };

        App.invoiceEngine.validateInvoice = function (type, invoice) {
            const errors = [];
            if (!invoice.date) errors.push({ field: 'date', message: 'Date is required' });
            if (!invoice.partyId) errors.push({ field: 'party', message: `Select a ${type === 'sales' ? 'customer' : 'supplier'}` });
            if (!Array.isArray(invoice.lines) || !invoice.lines.length) {
                errors.push({ field: 'lines', message: 'Add at least one line item' });
            } else {
                invoice.lines.forEach((line, idx) => {
                    if (!line.qty || line.qty <= 0) errors.push({ field: `line-${idx}-qty`, message: 'Quantity must be greater than zero' });
                    if (line.rate_per_unit < 0) errors.push({ field: `line-${idx}-rate`, message: 'Rate cannot be negative' });
                    if (type === 'sales' && !line.size_id) errors.push({ field: `line-${idx}-size`, message: 'Select a size for each line' });
                    if (type === 'purchase' && (line.category || '').toLowerCase() === 'ready screws') {
                        if (!line.size_id) errors.push({ field: `line-${idx}-size`, message: 'Select a size for Ready Screws' });
                        if (!line.stage) errors.push({ field: `line-${idx}-stage`, message: 'Select stage for Ready Screws' });
                        if (!line.bags_received || line.bags_received <= 0) errors.push({ field: `line-${idx}-bags`, message: 'Enter bags received' });
                    }
                });
            }
            if ((invoice.totals?.grand || 0) < 0) {
                errors.push({ field: 'totals', message: 'Total cannot be negative' });
            }
            return { valid: errors.length === 0, errors };
        };

        const lineDomConfig = {
            sales: {
                container: 'saleLineItems',
                fields: {
                    size: '.sl-size',
                    unit: '.sl-unit',
                    qty: '.sl-qty',
                    rate: '.sl-rate',
                    discount: '.sl-disc',
                    tax: '.sl-tax',
                    total: '.sl-total'
                }
            },
            purchase: {
                container: 'purchaseLineItems',
                fields: {
                    category: '.it-category',
                    description: '.it-name',
                    size: '.it-size',
                    stage: '.it-stage',
                    bags: '.it-bags',
                    unit: '.it-unit',
                    qty: '.it-qty',
                    rate: '.it-rate',
                    tax: '.it-tax',
                    total: '.it-total'
                }
            }
        };

        App.invoiceEngine.readLinesFromDOM = function (type) {
            const cfg = lineDomConfig[type];
            if (!cfg) return [];
            const rows = document.querySelectorAll(`#${cfg.container} tr`);
            const lines = [];
            rows.forEach((row, idx) => {
                if (type === 'sales') {
                    const qty = parseFloat(row.querySelector(cfg.fields.qty)?.value) || 0;
                    const rate = parseFloat(row.querySelector(cfg.fields.rate)?.value) || 0;
                    const disc = parseFloat(row.querySelector(cfg.fields.discount)?.value) || 0;
                    const taxPerUnit = parseFloat(row.querySelector(cfg.fields.tax)?.value) || 0;
                    const base = qty * rate;
                    const discountAmt = base * (disc / 100);
                    const beforeTax = base - discountAmt;
                    const lineTax = qty * taxPerUnit;
                    const grand = beforeTax + lineTax;
                    const sizeInput = row.querySelector(cfg.fields.size);
                    const sizeId = sizeInput?.dataset.sizeId || sizeInput?.value || null;
                    row.querySelector(cfg.fields.total).textContent = grand.toFixed(2);
                    lines.push({
                        line_id: idx + 1,
                        size_id: sizeId || null,
                        unit_type: row.querySelector(cfg.fields.unit)?.value || 'KG',
                        qty,
                        rate_per_unit: rate,
                        discount_pct: disc,
                        tax_per_unit: taxPerUnit,
                        line_total_before_tax: beforeTax,
                        line_tax_total: lineTax,
                        line_grand_total: grand
                    });
                } else if (type === 'purchase') {
                    const qty = parseFloat(row.querySelector(cfg.fields.qty)?.value) || 0;
                    const rate = parseFloat(row.querySelector(cfg.fields.rate)?.value) || 0;
                    const taxPerUnit = parseFloat(row.querySelector(cfg.fields.tax)?.value) || 0;
                    const beforeTax = qty * rate;
                    const lineTax = qty * taxPerUnit;
                    const grand = beforeTax + lineTax;
                    const sizeInput = row.querySelector(cfg.fields.size);
                    const sizeId = sizeInput?.dataset.sizeId || sizeInput?.value || null;
                    row.querySelector(cfg.fields.total).textContent = grand.toFixed(2);
                    lines.push({
                        line_id: idx + 1,
                        category: row.querySelector(cfg.fields.category)?.value || '',
                        description: row.querySelector(cfg.fields.description)?.value || '',
                        size_id: sizeId || null,
                        stage: row.querySelector(cfg.fields.stage)?.value || '',
                        bags_received: parseInt(row.querySelector(cfg.fields.bags)?.value || 0, 10) || 0,
                        unit_type: row.querySelector(cfg.fields.unit)?.value || 'KG',
                        qty,
                        rate_per_unit: rate,
                        tax_per_unit: taxPerUnit,
                        line_total_before_tax: beforeTax,
                        line_tax_total: lineTax,
                        line_grand_total: grand
                    });
                }
            });
            return lines;
        };

        App.invoiceEngine.refreshTotals = function (type) {
            const lines = App.invoiceEngine.readLinesFromDOM(type);
            const totals = App.invoiceEngine.calculateTotals(
                type,
                lines,
                type === 'purchase' ? (parseFloat(document.getElementById('purchaseInvoiceTax')?.value) || 0) : undefined
            );
            if (type === 'sales') {
                const invTaxInput = document.getElementById('saleInvoiceTax');
                if (invTaxInput) invTaxInput.value = totals.invoiceTax.toFixed(2);
                const subEl = document.getElementById('saleSubtotal');
                const lineTaxEl = document.getElementById('saleTaxTotal');
                const invTaxEl = document.getElementById('saleInvoiceTaxDisplay');
                const grandEl = document.getElementById('saleGrandTotal');
                if (subEl) subEl.textContent = totals.subtotal.toFixed(2);
                if (lineTaxEl) lineTaxEl.textContent = totals.lineTax.toFixed(2);
                if (invTaxEl) invTaxEl.textContent = totals.invoiceTax.toFixed(2);
                if (grandEl) grandEl.textContent = totals.grand.toFixed(2);
            } else {
                const subEl = document.getElementById('purchaseSubtotal');
                const lineTaxEl = document.getElementById('purchaseTaxTotal');
                const invTaxEl = document.getElementById('purchaseInvoiceTaxDisplay');
                const grandEl = document.getElementById('purchaseGrandTotal');
                if (subEl) subEl.textContent = totals.subtotal.toFixed(2);
                if (lineTaxEl) lineTaxEl.textContent = totals.lineTax.toFixed(2);
                if (invTaxEl) invTaxEl.textContent = totals.invoiceTax.toFixed(2);
                if (grandEl) grandEl.textContent = totals.grand.toFixed(2);
            }
            return totals;
        };

        App.invoiceEngine.renderInvoiceModal = async function (invoice, type) {
            if (!invoice) return;
            const lines = App.invoiceEngine.normalizeLines(type, invoice.lines || invoice.line_items || []);
            const partyId = type === 'sales'
                ? (invoice.customer_id || invoice.customerId || invoice.customer || invoice.customerid)
                : (invoice.supplier_id || invoice.supplierId || invoice.supplier || invoice.supplierid || invoice.supplier_name);
            const partyName = type === 'sales'
                ? App.utils.resolveName('customer', partyId, '(Deleted Customer)')
                : App.utils.resolveName('supplier', partyId, '(Deleted Supplier)');
            const totals = App.invoiceEngine.calculateTotals(type, lines, invoice.invoice_tax);
            const idValue = invoice.invoice_id || invoice.purchase_id || invoice.id || invoice.invoiceNo || invoice.invoice_no || '';
            const headerTitle = type === 'sales' ? 'SALES INVOICE' : 'PURCHASE INVOICE';
            const columnHeaders = type === 'sales'
                ? ['Size', 'Unit', 'Qty', 'Rate ()', 'Discount (%)', 'Line Tax ()', 'Total ()']
                : ['Category', 'Item', 'Size', 'Stage', 'Unit', 'Qty', 'Rate ()', 'Line Tax ()', 'Total ()'];

            let html = `<div class="invoice-details">
                <div class="invoice-header">
                    <div>
                        <h2 style="margin: 0;">${headerTitle}</h2>
                        <strong>Invoice ID:</strong> ${idValue}<br>
                        <strong>Date:</strong> ${invoice.date || ''}
                    </div>
                    <div style="text-align: right;">
                        <strong>${type === 'sales' ? 'Customer' : 'Supplier'}:</strong> ${partyName}
                    </div>
                </div>
                <table style="width: 100%; margin: 20px 0; border-collapse: collapse;">
                    <thead><tr style="background: #34495e; color: white;">`;
            columnHeaders.forEach(col => {
                html += `<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">${col}</th>`;
            });
            html += `</tr></thead><tbody>`;

            for (const line of lines) {
                if (type === 'sales') {
                    const sizeName = App.utils.resolveSizeName(line.size_id, 'N/A');
                    html += `<tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${sizeName}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${line.unit_type || ''}</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${line.qty}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${App.utils.formatCurrency(line.rate_per_unit)}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${(line.discount_pct || 0).toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${App.utils.formatCurrency(line.line_tax_total)}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${App.utils.formatCurrency(line.line_grand_total)}</td>
                    </tr>`;
                } else {
                    const sizeName = App.utils.resolveSizeName(line.size_id, line.size || 'N/A');
                    const stageLabel = line.stage ? (typeof INVENTORY_STAGE_LABELS !== 'undefined' ? (INVENTORY_STAGE_LABELS[line.stage] || line.stage) : line.stage) : '';
                    html += `<tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${line.category || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${line.description || line.item_name || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${sizeName}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${stageLabel || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${line.unit_type || ''}</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${line.qty || 0}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${App.utils.formatCurrency(line.rate_per_unit)}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${App.utils.formatCurrency(line.line_tax_total)}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${App.utils.formatCurrency(line.line_grand_total)}</td>
                    </tr>`;
                }
            }

            html += `</tbody></table>
                <div style="display:flex; justify-content:flex-end; gap:40px; background:#ecf0f1; padding:15px; border-radius:4px;">
                    <div style="text-align:right;">
                        <strong>Subtotal:</strong><br>
                        <strong>Line Taxes:</strong><br>
                        <strong>Invoice Tax:</strong><br>
                        <strong style="font-size:18px;">Grand Total:</strong>
                    </div>
                    <div style="text-align:right; min-width:150px;">
                        ${App.utils.formatCurrency(totals.subtotal)}<br>
                        ${App.utils.formatCurrency(totals.lineTax)}<br>
                        ${App.utils.formatCurrency(totals.invoiceTax)}<br>
                        <strong style="font-size:18px; color:#e74c3c;">${App.utils.formatCurrency(totals.grand)}</strong>
                    </div>
                </div>`;

            if (invoice.notes) {
                html += `<div style="margin-top: 20px;"><strong>Notes:</strong> ${invoice.notes}</div>`;
            }

            html += `</div>`;

            const target = document.getElementById('invoiceContent') || document.getElementById('invoiceModalBody');
            if (target) {
                target.innerHTML = html;
            }
            openModal('viewInvoiceModal');
        };

        App.invoiceEngine.getListConfig = function (type) {
            if (type === 'purchase') {
                return {
                    cacheKey: 'purchase',
                    idField: 'purchase_id',
                    tableId: 'purchaseInvoiceTable',
                    totalRowId: 'purchaseTotalRow',
                    totals: {
                        amount: 'purchaseTotalAmount',
                        lineTax: 'purchaseTotalLineTax',
                        invoiceTax: 'purchaseTotalInvoiceTax'
                    },
                    searchInputId: 'purchaseInvoiceSearch',
                    partyResolver: (id) => App.utils.resolveName('supplier', id, '(Deleted Supplier)'),
                    viewFn: 'viewPurchaseInvoice',
                    editFn: 'editPurchaseInvoice',
                    deleteFn: 'deletePurchaseInvoice'
                };
            }
            return {
                cacheKey: 'sales',
                idField: 'invoice_id',
                tableId: 'salesInvoiceTable',
                totalRowId: 'salesTotalRow',
                totals: {
                    amount: 'salesTotalAmount',
                    lineTax: 'salesTotalLineTax',
                    invoiceTax: 'salesTotalInvoiceTax'
                },
                searchInputId: 'salesInvoiceSearch',
                partyResolver: (id) => App.utils.resolveName('customer', id, '(Deleted Customer)'),
                viewFn: 'viewSalesInvoice',
                editFn: 'editSalesInvoice',
                deleteFn: 'deleteSalesInvoice'
            };
        };

        App.invoiceEngine.getFilteredInvoices = function (type) {
            const cfg = App.invoiceEngine.getListConfig(type);
            const searchTerm = (document.getElementById(cfg.searchInputId)?.value || '').toLowerCase().trim();
            const categoryFilter = type === 'purchase' ? (document.getElementById('purchaseCategoryFilter')?.value || 'All') : 'All';
            const base = Array.isArray(App.state.invoices[cfg.cacheKey]) ? App.state.invoices[cfg.cacheKey] : [];
            const unique = [];
            const seen = new Set();
            base.forEach(inv => {
                const key = inv[cfg.idField] || inv.id;
                if (!key || seen.has(key)) return;
                seen.add(key);
                unique.push(inv);
            });
            const filteredByCategory = unique.filter(inv => type !== 'purchase' || categoryFilter === 'All' || (inv.lines || []).some(l => (l.category || '').toLowerCase() === categoryFilter.toLowerCase()));
            if (!searchTerm) return filteredByCategory;

            const numSearch = parseFloat(searchTerm);
            const isNumeric = !isNaN(numSearch);
            return filteredByCategory.filter(inv => {
                const idStr = (inv[cfg.idField] || '').toLowerCase();
                const partyId = type === 'purchase' ? inv.supplier_id : inv.customer_id;
                const party = (cfg.partyResolver(partyId) || '').toLowerCase();
                const notesStr = (inv.notes || '').toLowerCase();
                const dateStr = (inv.date || '').toLowerCase();
                const totals = [
                    inv.invoice_grand_total,
                    inv.invoice_subtotal,
                    inv.invoice_line_tax_total,
                    inv.invoice_tax
                ].map(Number).filter(n => !isNaN(n));

                const lineMatch = (inv.lines || []).some(l => {
                    const sizeName = App.utils.resolveSizeName(l.size_id, l.size || '').toLowerCase();
                    const desc = (l.description || l.item_name || '').toLowerCase();
                    const category = (l.category || '').toLowerCase();
                    const stage = (l.stage || '').toLowerCase();
                    const unit = (l.unit_type || '').toLowerCase();
                    const qty = parseFloat(l.qty);
                    const rate = parseFloat(l.rate_per_unit || l.rate);
                    const tax = parseFloat(l.tax_per_unit || l.tax);
                    const lineTotal = parseFloat(l.line_grand_total || l.line_total_before_tax || 0);
                    const textMatch = [sizeName, desc, category, stage, unit].some(v => v.includes(searchTerm));
                    const numMatch = isNumeric && [qty, rate, tax, lineTotal].some(n => !isNaN(n) && n === numSearch);
                    return textMatch || numMatch;
                });

                const amountMatch = isNumeric && totals.some(n => n === numSearch);
                return idStr.includes(searchTerm)
                    || party.includes(searchTerm)
                    || notesStr.includes(searchTerm)
                    || dateStr.includes(searchTerm)
                    || lineMatch
                    || amountMatch;
            });
        };

        App.invoiceEngine.renderInvoiceTable = function (type) {
            const cfg = App.invoiceEngine.getListConfig(type);
            const tbody = document.querySelector(`#${cfg.tableId} tbody`);
            if (!tbody) return;
            const categoryFilter = type === 'purchase' ? (document.getElementById('purchaseCategoryFilter')?.value || 'All') : 'All';
            const totalRow = document.getElementById(cfg.totalRowId);
            tbody.querySelectorAll(`tr:not(#${cfg.totalRowId})`).forEach(row => row.remove());

            const invoices = App.invoiceEngine.getFilteredInvoices(type);
            let totalAmount = 0;
            let totalLineTax = 0;
            let totalInvoiceTax = 0;
            invoices.forEach(inv => {
                const idVal = inv[cfg.idField];
                const partyId = type === 'purchase' ? inv.supplier_id : inv.customer_id;
                const partyName = cfg.partyResolver(partyId);
                const row = document.createElement('tr');
                const viewId = idVal ? idVal.replace(/"/g, '') : '';
                const editDisabled = App.hasPermission('editInvoices') ? '' : 'disabled aria-disabled="true"';
                const deleteDisabled = App.hasPermission('deleteInvoices') ? '' : 'disabled aria-disabled="true"';
                row.innerHTML = `<td class="checkbox-column"><input type="checkbox" class="${type}InvoiceCheckbox" data-id="${viewId}"></td>
                    <td>${inv.date || ''}</td>
                    <td>${partyName}</td>
                    <td class="currency">${App.utils.formatCurrency(inv.invoice_grand_total)}</td>
                    <td class="currency">${App.utils.formatCurrency(inv.invoice_line_tax_total)}</td>
                    <td class="currency">${App.utils.formatCurrency(inv.invoice_tax || 0)}</td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" onclick="${cfg.viewFn}('${viewId}')">View</button>
                            <button type="button" ${editDisabled} onclick="${cfg.editFn}('${viewId}')">Edit</button>
                            <button type="button" class="danger" ${deleteDisabled} onclick="${cfg.deleteFn}('${viewId}')">Delete</button>
                        </div>
                    </td>`;
                tbody.insertBefore(row, totalRow);
                totalAmount += Number(inv.invoice_grand_total || 0);
                totalLineTax += Number(inv.invoice_line_tax_total || 0);
                totalInvoiceTax += Number(inv.invoice_tax || 0);
            });

            const totals = cfg.totals;
            document.getElementById(totals.amount).textContent = '' + totalAmount.toFixed(2);
            document.getElementById(totals.lineTax).textContent = '' + totalLineTax.toFixed(2);
            document.getElementById(totals.invoiceTax).textContent = '' + totalInvoiceTax.toFixed(2);
            if (type === 'purchase') {
                const summaryElement = document.getElementById('categoryTotalsSummary');
                if (summaryElement) {
                    summaryElement.innerHTML = categoryFilter && categoryFilter !== 'All'
                        ? `Showing ${invoices.length} invoices for ${categoryFilter}`
                        : `Showing ${invoices.length} purchase invoices`;
                }
            }
            setTimeout(() => addDataLabelsToTable(cfg.tableId), 50);
        };

        async function ensurePurchaseSupplierNames() {
            const invoices = await fbGetAll('purchaseInvoices');
            const suppliers = await fbGetAll('suppliers');
            const supplierMap = {};
            suppliers.forEach(s => supplierMap[s.id] = s);
            let updated = 0;
            for (const inv of invoices) {
                const supplierId = inv.supplier_id || inv.supplierId || inv.supplierid || inv.supplier;
                if (!supplierId) continue;
                const supp = supplierMap[supplierId];
                const name = supp?.supplier_name || supp?.name || inv.supplier_name || supplierId;
                if (name && inv.supplier_name !== name) {
                    inv.supplier_name = name;
                    await fbPut('purchaseInvoices', inv.purchase_id, inv);
                    updated++;
                }
            }
            if (updated) {
                console.log(`Supplier names repaired for ${updated} purchase invoices`);
            }
        }

        // ========== LEDGER CLEANUP FUNCTION ==========
        async function cleanupDuplicateLedgers() {
            if (!isConnected) {
                alert("No internet connection. Cannot cleanup ledgers.");
                return;
            }

            if (!confirm("This will delete all duplicate and extra ledger entries that don't correspond to actual invoices. This action cannot be undone. Continue?")) {
                return;
            }

            try {
                const statusElement = document.getElementById('backupStatus');
                statusElement.innerHTML = '<div class="alert"> Cleaning up ledger entries...</div>';

                // Get all data
                const salesInvoices = await fbGetAll('salesInvoices');
                const purchaseInvoices = await fbGetAll('purchaseInvoices');
                const allLedgers = await fbGetAll('ledgerEntries');

                // Create sets of valid invoice IDs
                const validSalesInvoiceIds = new Set(salesInvoices.map(inv => inv.invoice_id));
                const validPurchaseInvoiceIds = new Set(purchaseInvoices.map(inv => inv.purchase_id));

                // Track which ledgers to keep and delete
                const ledgersToKeep = [];
                const ledgersToDelete = [];
                const seenEntries = new Set();

                for (const ledger of allLedgers) {
                    const key = `${ledger.date}_${ledger.party_type}_${ledger.party_id}_${ledger.reference_type}_${ledger.reference_id}_${ledger.debit}_${ledger.credit}_${ledger.note}`;

                    // Check if this is a duplicate
                    if (seenEntries.has(key)) {
                        ledgersToDelete.push(ledger);
                        continue;
                    }

                    seenEntries.add(key);

                    // Check if this ledger corresponds to a valid invoice
                    if (ledger.reference_type === 'SALE') {
                        if (validSalesInvoiceIds.has(ledger.reference_id)) {
                            ledgersToKeep.push(ledger);
                        } else {
                            ledgersToDelete.push(ledger);
                        }
                    } else if (ledger.reference_type === 'PURCHASE') {
                        if (validPurchaseInvoiceIds.has(ledger.reference_id)) {
                            ledgersToKeep.push(ledger);
                        } else {
                            ledgersToDelete.push(ledger);
                        }
                    } else {
                        // Keep manual adjustments and bank transactions
                        ledgersToKeep.push(ledger);
                    }
                }

                // Delete the invalid/duplicate ledger entries
                let deletedCount = 0;
                for (const ledger of ledgersToDelete) {
                    await fbDelete('ledgerEntries', ledger.id);
                    deletedCount++;
                }

                statusElement.innerHTML = `<div class="alert success"> Cleanup completed! Deleted ${deletedCount} duplicate/invalid ledger entries. Kept ${ledgersToKeep.length} valid entries.</div>`;

                console.log(`Ledger cleanup: Deleted ${deletedCount} entries, kept ${ledgersToKeep.length} entries`);

            } catch (error) {
                console.error("Error during ledger cleanup:", error);
                document.getElementById('backupStatus').innerHTML = '<div class="alert danger"> Error during cleanup: ' + error.message + '</div>';
            }
        }

        // ========== UI Helpers ==========
        function getToday() {
            const now = new Date();
            const istDate = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
            const year = istDate.getFullYear();
            const month = String(istDate.getMonth() + 1).padStart(2, '0');
            const day = String(istDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getFirstDayOfMonth() {
            const now = new Date();
            const istDate = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
            const year = istDate.getFullYear();
            const month = String(istDate.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}-01`;
        }

        function openModal(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.add('active');
            el.style.display = 'flex';
        }

        function closeModal(id) {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove('active');
            }
            if (el && el.style) {
                el.style.display = 'none';
            }
        }

        // ============================================
        // MOBILE HELPER FUNCTIONS
        // ============================================
        function addDataLabelsToTable(tableId) {
            // Add data-label attributes to table cells for mobile card layout
            const table = document.getElementById(tableId);
            if (!table) return;

            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    if (headers[index] && !cell.classList.contains('checkbox-column')) {
                        cell.setAttribute('data-label', headers[index]);
                    }
                });
            });
        }

        // Auto-add data labels to all tables after rendering
        function updateAllTableLabels() {
            const tables = document.querySelectorAll('table[id]');
            tables.forEach(table => {
                addDataLabelsToTable(table.id);
            });
        }

        // ============================================
        // MOBILE MENU FUNCTIONS
        // ============================================
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            const menuToggle = document.getElementById('mobileMenuToggle');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');

            // Change icon
            if (sidebar.classList.contains('active')) {
                menuToggle.textContent = '';
                menuToggle.classList.add('open');
                overlay.style.left = '280px';
                overlay.style.width = 'calc(100% - 280px)';
            } else {
                menuToggle.textContent = '';
                menuToggle.classList.remove('open');
                overlay.style.left = '0';
                overlay.style.width = '100%';
            }
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            const menuToggle = document.getElementById('mobileMenuToggle');

            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            menuToggle.textContent = '';
            menuToggle.classList.remove('open');
            overlay.style.left = '0';
            overlay.style.width = '100%';
        }

        // Close mobile menu when clicking on any tab
        function closeMobileMenuOnTabClick() {
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }
        }

        // ============================================
        // ORIGINAL TAB SWITCHING FUNCTION
        // ============================================
        function switchMainTab(tabName, btn) {
            // Close mobile menu when switching tabs
            closeMobileMenuOnTabClick();
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            const targetTab = document.getElementById(tabName);
            if (targetTab) targetTab.classList.add('active');
            if (btn) btn.classList.add('active');

            // Re-render heavy tabs on demand so data like finished goods appears immediately
            try { localStorage.setItem('activeMainTab', tabName); } catch (e) {}
            if (tabName === 'production-entry' && typeof renderProductionEntryTab === 'function') {
                renderProductionEntryTab();
            } else if (tabName === 'packing' && typeof renderPackingTab === 'function') {
                renderPackingTab();
            } else if (tabName === 'inventory' && typeof renderInventoryTab === 'function') {
                renderInventoryTab();
            } else if (tabName === 'size-control' && typeof renderSizeControlTab === 'function') {
                renderSizeControlTab();
            } else if (tabName === 'dashboard' && typeof renderDashboardTab === 'function') {
                renderDashboardTab();
            }

            recordActionLog('Main Tab Switch', `Opened ${tabName} tab`, { tab: tabName });
        }

        function switchSalesSubtab(id, btn) {
            const parent = document.getElementById('sales');
            parent.querySelectorAll('.subtab-content').forEach(s => s.classList.remove('active'));
            parent.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function switchPurchaseSubtab(id, btn) {
            const parent = document.getElementById('purchase');
            parent.querySelectorAll('.subtab-content').forEach(s => s.classList.remove('active'));
            parent.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function switchReportsSubtab(id, btn) {
            const parent = document.getElementById('reports');
            parent.querySelectorAll('.subtab-content').forEach(s => s.classList.remove('active'));
            parent.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if (id === 'report-elaborate') {
                generateElaborateReport();
            } else if (id === 'report-activity-logs') {
                generateActivityLogs(false);
            }
            recordActionLog('Report Tab Switch', `Opened ${id}`, { tab: id });
        }

        function switchMastersSubtab(id, btn) {
            const parent = document.getElementById('masters');
            parent.querySelectorAll('.subtab-content').forEach(s => s.classList.remove('active'));
            parent.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function switchPLSubtab(id, btn) {
            const parent = document.getElementById('report-pl');
            parent.querySelectorAll('.subtab-content').forEach(s => s.classList.remove('active'));
            parent.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        // ========== CUSTOMER AUTOCOMPLETE ==========
        document.getElementById('saleCustomer').addEventListener('input', async (e) => {
            const search = e.target.value.toLowerCase();
            const dropdown = document.getElementById('saleCustomerList');
            if (!search) { dropdown.classList.remove('active'); return; }
            const customers = await fbGetAll('customers');
            const matches = customers.filter(c => c.display_name.toLowerCase().includes(search));
            dropdown.innerHTML = '';
            matches.forEach(cust => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.textContent = cust.display_name;
                div.onclick = () => {
                    e.target.value = cust.display_name;
                    document.getElementById('saleCustomerId').value = cust.id;
                    dropdown.classList.remove('active');
                };
                dropdown.appendChild(div);
            });
            if (matches.length > 0) dropdown.classList.add('active');
        });

        // Quote customer autocomplete
        document.getElementById('quoteCustomer').addEventListener('input', async (e) => {
            const search = e.target.value.toLowerCase();
            const dropdown = document.getElementById('quoteCustomerList');
            if (!search) { dropdown.classList.remove('active'); return; }
            const customers = await fbGetAll('customers');
            const matches = customers.filter(c => (c.display_name || '').toLowerCase().includes(search));
            dropdown.innerHTML = '';
            matches.forEach(cust => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.textContent = cust.display_name;
                div.onclick = () => {
                    e.target.value = cust.display_name;
                    document.getElementById('quoteCustomerId').value = cust.id;
                    dropdown.classList.remove('active');
                };
                dropdown.appendChild(div);
            });
            if (matches.length > 0) dropdown.classList.add('active');
        });

        // ========== SUPPLIER AUTOCOMPLETE ==========
        document.getElementById('purchaseSupplier').addEventListener('input', async (e) => {
            const search = e.target.value.toLowerCase();
            const dropdown = document.getElementById('purchaseSupplierList');
            if (!search) { dropdown.classList.remove('active'); return; }
            const suppliers = await fbGetAll('suppliers');
            const matches = suppliers.filter(s => s.supplier_name.toLowerCase().includes(search));
            dropdown.innerHTML = '';
            matches.forEach(supp => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.textContent = supp.supplier_name;
                div.onclick = () => {
                    e.target.value = supp.supplier_name;
                    document.getElementById('purchaseSupplierId').value = supp.id;
                    dropdown.classList.remove('active');
                };
                dropdown.appendChild(div);
            });
            if (matches.length > 0) dropdown.classList.add('active');
        });

        // ========== LEDGER PARTY SEARCH ==========
        document.getElementById('ledgerPartySearch').addEventListener('input', async (e) => {
            const search = e.target.value.toLowerCase();
            const dropdown = document.getElementById('ledgerPartyList');
            if (!search) { dropdown.classList.remove('active'); return; }
            const customers = await fbGetAll('customers');
            const suppliers = await fbGetAll('suppliers');
            const allParties = [...customers.map(c => ({ ...c, type: 'CUSTOMER' })), ...suppliers.map(s => ({ ...s, type: 'SUPPLIER' }))];
            const matches = allParties.filter(p => (p.display_name || p.supplier_name).toLowerCase().includes(search));
            dropdown.innerHTML = '';
            matches.forEach(p => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.textContent = `${p.display_name || p.supplier_name} (${p.type})`;
                div.onclick = () => {
                    e.target.value = p.display_name || p.supplier_name;
                    document.getElementById('ledgerPartyId').value = p.id;
                    document.getElementById('ledgerPartyType').value = p.type;
                    document.getElementById('ledgerPartyName').textContent = p.display_name || p.supplier_name;
                    dropdown.classList.remove('active');
                    showLedgerForParty(p.id, p.type, p.display_name || p.supplier_name);
                };
                dropdown.appendChild(div);
            });
            if (matches.length > 0) dropdown.classList.add('active');
        });

        // ======== LEDGER VIEW & MANUAL ADJUSTMENT ========
        async function showLedgerForParty(partyId, partyType, partyName) {
            try {
                if (!partyId || !partyType) {
                    App.ui.showToast('Select a customer or supplier first.', 'error');
                    return;
                }
                const section = document.getElementById('ledgerViewSection');
                const tbody = document.querySelector('#ledgerTable tbody');
                const netBalanceEl = document.getElementById('netBalance');
                const balanceNoteEl = document.getElementById('balanceNote');
                if (!section || !tbody) return;

                const allLedgers = await fbGetAll('ledgerEntries');
                const entries = (allLedgers || []).filter(l => l.party_id === partyId && l.party_type === partyType);

                entries.sort((a, b) => {
                    const da = a.date || '';
                    const db = b.date || '';
                    if (da < db) return -1;
                    if (da > db) return 1;
                    const ra = a.reference_id || '';
                    const rb = b.reference_id || '';
                    return ra.localeCompare(rb);
                });

                tbody.innerHTML = '';
                let running = 0;
                entries.forEach(entry => {
                    const debit = Number(entry.debit) || 0;
                    const credit = Number(entry.credit) || 0;
                    running += (debit - credit);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${entry.date || ''}</td>
                        <td>${entry.reference_id || ''}</td>
                        <td>${entry.reference_type || ''}</td>
                        <td class="currency">${App.utils.formatCurrency ? App.utils.formatCurrency(debit) : debit.toFixed(2)}</td>
                        <td class="currency">${App.utils.formatCurrency ? App.utils.formatCurrency(credit) : credit.toFixed(2)}</td>
                        <td class="currency">${App.utils.formatCurrency ? App.utils.formatCurrency(running) : running.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });

                if (netBalanceEl) {
                    netBalanceEl.textContent = App.utils.formatCurrency ? App.utils.formatCurrency(running) : running.toFixed(2);
                }
                if (balanceNoteEl) {
                    const name = partyName || 'this party';
                    if (running > 0) balanceNoteEl.textContent = `${name} owes you this amount.`;
                    else if (running < 0) balanceNoteEl.textContent = `You owe ${name} this amount.`;
                    else balanceNoteEl.textContent = 'No net outstanding balance.';
                }
                section.style.display = 'block';
            } catch (err) {
                console.error('Unable to load ledger entries', err);
                App.ui.showToast(err.message || 'Unable to load ledger entries', 'error');
            }
        }

        async function saveManualAdjustment() {
            const partyId = document.getElementById('ledgerPartyId')?.value;
            const partyType = document.getElementById('ledgerPartyType')?.value;
            const partyName = document.getElementById('ledgerPartyName')?.textContent || '';
            if (!partyId || !partyType) {
                App.ui.showToast('Select a party before saving an adjustment.', 'error');
                return;
            }
            const date = document.getElementById('manualAdjDate')?.value || getToday();
            const debitVal = Number(document.getElementById('manualAdjDebit')?.value) || 0;
            const creditVal = Number(document.getElementById('manualAdjCredit')?.value) || 0;
            const noteVal = (document.getElementById('manualAdjNote')?.value || '').trim() || 'Manual adjustment';

            if (debitVal === 0 && creditVal === 0) {
                App.ui.showToast('Enter a debit or credit amount.', 'error');
                return;
            }
            if (debitVal !== 0 && creditVal !== 0) {
                App.ui.showToast('Use either debit or credit, not both.', 'error');
                return;
            }

            const entry = {
                date,
                party_type: partyType,
                party_id: partyId,
                reference_type: 'ADJUSTMENT',
                reference_id: 'ADJ-' + Date.now(),
                debit: debitVal,
                credit: creditVal,
                note: noteVal
            };

            try {
                await safePush('ledgerEntries', entry);
                App.ui.showToast('Manual adjustment saved.', 'success');
                const debitEl = document.getElementById('manualAdjDebit');
                const creditEl = document.getElementById('manualAdjCredit');
                const noteEl = document.getElementById('manualAdjNote');
                if (debitEl) debitEl.value = '0';
                if (creditEl) creditEl.value = '0';
                if (noteEl) noteEl.value = '';
                await showLedgerForParty(partyId, partyType, partyName);
            } catch (err) {
                console.error('Error saving manual adjustment', err);
                App.ui.showToast(err.message || 'Unable to save adjustment', 'error');
            }
        }

        // Close dropdowns on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-wrapper')) {
                document.querySelectorAll('.autocomplete-dropdown').forEach(d => d.classList.remove('active'));
            }
        });

        // ========== SALES INVOICE ==========
        async function addSaleLine(initialData = null) {
            const tbody = document.getElementById('saleLineItems');
            const id = 'sl_' + Date.now();
            const row = document.createElement('tr');
            row.id = id;
            row.innerHTML = `
                <td>
                    <div class="autocomplete-wrapper">
                        <input type="text" class="sl-size autocomplete-input" placeholder="Type size name..." data-id="${id}" autocomplete="off">
                        <div class="autocomplete-dropdown" id="saleSizeDropdown_${id}"></div>
                    </div>
                </td>
                <td><select class="sl-unit" data-id="${id}"><option value="KG">KG</option><option value="PKT">PKT</option></select></td>
                <td><input type="number" class="sl-qty" step="0.01" data-id="${id}"></td>
                <td><input type="number" class="sl-rate" step="0.01" data-id="${id}"></td>
                <td><input type="number" class="sl-disc" min="0" max="100" step="0.01" data-id="${id}" value="0"></td>
                <td><input type="number" class="sl-tax" step="0.01" data-id="${id}"></td>
                <td><span class="sl-total">0</span></td>
                <td><button type="button" onclick="document.getElementById('${id}').remove(); updateSalesTotals();" class="danger">Delete</button></td>
            `;
            tbody.appendChild(row);

            const sizeInput = row.querySelector('.sl-size');
            const dropdown = row.querySelector(`#saleSizeDropdown_${id}`);

            sizeInput.addEventListener('input', async (e) => {
                const search = e.target.value.toLowerCase();
                if (!search) { dropdown.classList.remove('active'); return; }
                const sizes = await fbGetAll('sizes');
                const matches = sizes.filter(s => (s.size_name || '').toLowerCase().includes(search) || (s.code || '').toLowerCase().includes(search));
                dropdown.innerHTML = '';
                matches.forEach(size => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.textContent = `${size.size_name} (${size.code})`;
                    div.onclick = async () => {
                        e.target.value = size.size_name;
                        e.target.dataset.sizeId = size.id;
                        row.querySelector('.sl-unit').value = size.default_unit_type || 'KG';
                        // Auto-set rate based on unit
                        const unit = row.querySelector('.sl-unit').value;
                        row.querySelector('.sl-rate').value = unit === 'KG' ? size.price_per_kg || 0 : size.price_per_pkt || 0;
                        dropdown.classList.remove('active');
                        updateSalesTotals();
                    };
                    dropdown.appendChild(div);
                });
                if (matches.length > 0) dropdown.classList.add('active');
            });

            // Auto-update rate when unit changes
            row.querySelector('.sl-unit').addEventListener('change', async (e) => {
                const sizeId = sizeInput.dataset.sizeId;
                if (sizeId) {
                    const fullSize = await fbGet('sizes', sizeId);
                    row.querySelector('.sl-rate').value = e.target.value === 'KG' ? fullSize.price_per_kg || 0 : fullSize.price_per_pkt || 0;
                    updateSalesTotals();
                }
            });

            function applyInitialData(data) {
                if (!data) return;
                if (data.sizeName) {
                    sizeInput.value = data.sizeName;
                }
                if (data.sizeId) {
                    sizeInput.dataset.sizeId = data.sizeId;
                }
                if (data.unit) row.querySelector('.sl-unit').value = data.unit;
                if (typeof data.qty !== 'undefined') row.querySelector('.sl-qty').value = data.qty;
                if (typeof data.rate !== 'undefined') row.querySelector('.sl-rate').value = data.rate;
                if (typeof data.discount !== 'undefined') row.querySelector('.sl-disc').value = data.discount;
                if (typeof data.tax !== 'undefined') row.querySelector('.sl-tax').value = data.tax;
                if (typeof data.total !== 'undefined') row.querySelector('.sl-total').textContent = Number(data.total).toFixed(2);
            }

            row.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', updateSalesTotals);
                el.addEventListener('change', updateSalesTotals);
            });
            applyInitialData(initialData);
            updateSalesTotals();
            return row;
        }

        function updateSalesTotals() {
            App.invoiceEngine.refreshTotals('sales');
        }

        async function saveSalesInvoice() {
            const form = document.getElementById('salesInvoiceForm');
            App.utils.clearValidation(form);
            if (!App.hasPermission('editInvoices')) {
                App.ui.showToast('You do not have permission to edit invoices', 'error');
                return;
            }

            const date = document.getElementById('saleDate').value;
            const custId = document.getElementById('saleCustomerId').value;
            const lines = App.invoiceEngine.readLinesFromDOM('sales');
            const totals = App.invoiceEngine.calculateTotals('sales', lines);
            const existingId = document.getElementById('saleInvoiceIdEdit').value;
            const invId = existingId || await App.invoiceEngine.nextInvoiceId('sales');

            const invoice = {
                invoice_id: invId,
                invoiceId: invId,
                date,
                customer_id: custId,
                customerId: custId,
                lines,
                invoice_subtotal: totals.subtotal,
                invoice_line_tax_total: totals.lineTax,
                invoice_tax: totals.invoiceTax,
                invoice_grand_total: totals.grand,
                notes: document.getElementById('saleNotes').value || '',
                updatedAt: new Date().toISOString(),
                createdBy: typeof getCurrentUserName === 'function' ? getCurrentUserName() : 'User'
            };

            const validation = App.invoiceEngine.validateInvoice('sales', { date, partyId: custId, lines, totals });
            if (!validation.valid) {
                validation.errors.forEach(err => {
                    if (err.field === 'date') App.utils.markInvalid(document.getElementById('saleDate'), err.message);
                    if (err.field === 'party') App.utils.markInvalid(document.getElementById('saleCustomer'), err.message);
                    if (err.field.startsWith('line-')) {
                        const parts = err.field.split('-');
                        const idx = parseInt(parts[1], 10);
                        const rows = document.querySelectorAll('#saleLineItems tr');
                        const row = rows[idx];
                        if (row) {
                            const fieldKey = parts[2];
                            if (fieldKey === 'qty') App.utils.markInvalid(row.querySelector('.sl-qty'), err.message);
                            if (fieldKey === 'rate') App.utils.markInvalid(row.querySelector('.sl-rate'), err.message);
                            if (fieldKey === 'size') App.utils.markInvalid(row.querySelector('.sl-size'), err.message);
                        }
                    }
                });
                App.ui.showToast(validation.errors[0].message, 'error');
                return;
            }

            try {
                await App.db.saveInvoice('sales', invoice);
            } catch (error) {
                console.error('Error saving invoice', error);
                App.ui.showToast(error.message || 'Unable to save invoice', 'error');
                return;
            }

            // Ledger handling
            try {
                if (isConnected) {
                    const allLedgers = await fbGetAll('ledgerEntries');
                    const existingLedgers = allLedgers.filter(l => l.reference_id === invId && l.reference_type === 'SALE');
                    for (const led of existingLedgers) {
                        await fbDelete('ledgerEntries', led.id);
                    }
                }
                await safePush('ledgerEntries', {
                    date,
                    party_type: 'CUSTOMER',
                    party_id: custId,
                    reference_type: 'SALE',
                    reference_id: invId,
                    debit: totals.grand,
                    credit: 0,
                    note: `Sale ${invId}`
                });
            } catch (err) {
                console.warn('Ledger update skipped', err);
            }

            // Stock adjustments
            for (const line of lines) {
                if (line.size_id) {
                    let stock = null;
                    try {
                        stock = await fbGet('stockLevels', line.size_id);
                    } catch (err) { }
                    if (!stock) stock = { size_id: line.size_id, raw_wire_qty: 0, finished_goods_qty: 0 };
                    if (line.unit_type === 'PKT') stock.finished_goods_qty -= line.qty;
                    await safePut('stockLevels', line.size_id, stock);
                }
            }

            const customerName = App.utils.resolveName('customer', custId, 'Customer');
            App.db.log({
                action: existingId ? 'sales.invoice.update' : 'sales.invoice.create',
                entityType: 'salesInvoice',
                entityId: invId,
                description: `${existingId ? 'Updated' : 'Created'} invoice ${invId} for ${customerName}`,
                extra: { total: totals.grand, lines: lines.length }
            });

            clearSalesForm();
            App.ui.showToast(`Saved invoice ${invId}`, 'success');
        }

        function clearSalesForm() {
            document.getElementById('salesInvoiceForm').reset();
            document.getElementById('saleDate').value = getToday();
            document.getElementById('saleLineItems').innerHTML = '';
            document.getElementById('saleCustomerId').value = '';
            document.getElementById('saleInvoiceTax').value = '0';
            document.getElementById('saleSubtotal').textContent = '0';
            document.getElementById('saleTaxTotal').textContent = '0';
            document.getElementById('saleInvoiceTaxDisplay').textContent = '0';
            document.getElementById('saleGrandTotal').textContent = '0';
            document.getElementById('saleInvoiceIdEdit').value = '';
            // Add initial line item after clearing
            addSaleLine();
        }

        async function refreshSalesInvoiceList() {
            try {
                await App.db.listInvoices('sales');
                App.invoiceEngine.renderInvoiceTable('sales');
            } catch (error) {
                console.error("Error refreshing sales invoices:", error);
            }
        }

        async function viewSalesInvoice(invId) {
            try {
                const inv = await App.db.getInvoice('sales', invId);
                if (!inv) {
                    App.ui.showToast('Invoice not found', 'error');
                    return;
                }
                await App.invoiceEngine.renderInvoiceModal(inv, 'sales');
            } catch (error) {
                console.error("Error viewing sales invoice:", error);
                App.ui.showToast("Error viewing sales invoice: " + error.message, 'error');
            }
        }

        // ========== PURCHASE INVOICE ==========
        const READY_SCREW_STAGE_OPTIONS = [
            { value: 'Header', label: 'Header Output' },
            { value: 'Rolling', label: 'Rolling Output' },
            { value: 'Furnace', label: 'Hardening Output' },
            { value: 'Tampering', label: 'Tampering Output' },
            { value: 'Plating', label: 'Plating Output' },
            { value: 'Finished Goods', label: 'Finished Goods' }
        ];

        function toggleReadyScrewFields(row, categorySelect) {
            const show = (categorySelect?.value || '').toLowerCase() === 'ready screws';
            row.querySelectorAll('.ready-only-field').forEach(el => {
                el.style.display = show ? '' : 'none';
            });
            if (!show) {
                const sizeInput = row.querySelector('.it-size');
                const stageSelect = row.querySelector('.it-stage');
                const bagsInput = row.querySelector('.it-bags');
                if (sizeInput) {
                    sizeInput.value = '';
                    delete sizeInput.dataset.sizeId;
                }
                if (stageSelect) stageSelect.value = '';
                if (bagsInput) bagsInput.value = '';
            }
        }

        async function addPurchaseLine(initialData = null) {
            const tbody = document.getElementById('purchaseLineItems');
            const id = 'pl_' + Date.now();
            const stageOptionsHtml = READY_SCREW_STAGE_OPTIONS.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
            const row = document.createElement('tr');
            row.id = id;
            row.innerHTML = `
                <td><select class="it-category" data-id="${id}">
                    <option value="">Select Category</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Machine Repair">Machine Repair</option>
                    <option value="RAW MATERIALS">RAW MATERIALS</option>
                    <option value="Other">Other</option>
                    <option value="Wire">Wire</option>
                    <option value="Ready Screws">Ready Screws</option>
                    <option value="P E">P E</option>
                    <option value="miscellaneous">miscellaneous</option>
                </select></td>
                <td><input type="text" class="it-name" placeholder="Description" data-id="${id}"></td>
                <td>
                    <div class="ready-only-field" style="display:none;">
                        <div class="autocomplete-wrapper">
                            <input type="text" class="it-size autocomplete-input" placeholder="Type size name..." data-id="${id}" autocomplete="off">
                            <div class="autocomplete-dropdown" id="purchaseSizeDropdown_${id}"></div>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="ready-only-field" style="display:none;">
                        <select class="it-stage" data-id="${id}">
                            <option value="">Select Stage</option>
                            ${stageOptionsHtml}
                        </select>
                    </div>
                </td>
                <td>
                    <div class="ready-only-field" style="display:none;">
                        <input type="number" class="it-bags" min="1" step="1" placeholder="# Bags">
                    </div>
                </td>
                <td><select class="it-unit" data-id="${id}"><option>KG</option><option>PKT</option></select></td>
                <td><input type="number" class="it-qty" step="0.01" data-id="${id}"></td>
                <td><input type="number" class="it-rate" step="0.01" data-id="${id}"></td>
                <td><input type="number" class="it-tax" step="0.01" data-id="${id}"></td>
                <td><span class="it-total">0</span></td>
                <td><button type="button" onclick="document.getElementById('${id}').remove(); updatePurchaseTotals();" class="danger">Delete</button></td>
            `;
            tbody.appendChild(row);

            const categorySelect = row.querySelector('.it-category');
            const sizeInput = row.querySelector('.it-size');
            const dropdown = row.querySelector(`#purchaseSizeDropdown_${id}`);
            const stageSelect = row.querySelector('.it-stage');
            const bagsInput = row.querySelector('.it-bags');

            sizeInput?.addEventListener('input', async (e) => {
                const search = e.target.value.toLowerCase();
                if (!search) { dropdown.classList.remove('active'); return; }
                let sizes = Array.isArray(App.state.sizes) && App.state.sizes.length ? App.state.sizes : null;
                if (!sizes) {
                    try {
                        sizes = await fbGetAll('sizes');
                        updateCaches(sizes, 'sizes');
                    } catch (err) {
                        sizes = [];
                    }
                }
                const matches = sizes.filter(s => (s.size_name || '').toLowerCase().includes(search) || (s.code || '').toLowerCase().includes(search));
                dropdown.innerHTML = '';
                matches.forEach(size => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.textContent = `${size.size_name} (${size.code})`;
                    div.onclick = () => {
                        e.target.value = size.size_name;
                        e.target.dataset.sizeId = size.id;
                        row.querySelector('.it-unit').value = size.default_unit_type || 'KG';
                        const unit = row.querySelector('.it-unit').value;
                        row.querySelector('.it-rate').value = unit === 'KG' ? size.price_per_kg || 0 : size.price_per_pkt || 0;
                        dropdown.classList.remove('active');
                        updatePurchaseTotals();
                    };
                    dropdown.appendChild(div);
                });
                if (matches.length > 0) dropdown.classList.add('active');
            });

            row.querySelector('.it-unit').addEventListener('change', async (e) => {
                const sizeId = sizeInput?.dataset.sizeId;
                if (sizeId) {
                    const fullSize = App.cache.sizesById[sizeId] || await fbGet('sizes', sizeId);
                    if (fullSize) {
                        row.querySelector('.it-rate').value = e.target.value === 'KG' ? fullSize.price_per_kg || 0 : fullSize.price_per_pkt || 0;
                        updatePurchaseTotals();
                    }
                }
            });

            function applyInitialData(data) {
                if (!data) return;
                if (data.category) categorySelect.value = data.category;
                if (data.description) row.querySelector('.it-name').value = data.description;
                if (data.sizeName) {
                    sizeInput.value = data.sizeName;
                    sizeInput.dataset.sizeId = data.sizeId || '';
                }
                if (stageSelect) {
                    if (data.stage) {
                        stageSelect.value = data.stage;
                    } else if ((data.category || '').toLowerCase() === 'ready screws') {
                        stageSelect.value = 'Finished Goods';
                    }
                }
                if (data.unit) row.querySelector('.it-unit').value = data.unit;
                if (typeof data.receivedBags !== 'undefined' && bagsInput) {
                    bagsInput.value = data.receivedBags;
                }
                if (typeof data.qty !== 'undefined') row.querySelector('.it-qty').value = data.qty;
                if (typeof data.rate !== 'undefined') row.querySelector('.it-rate').value = data.rate;
                if (typeof data.tax !== 'undefined') row.querySelector('.it-tax').value = data.tax;
                if (typeof data.total !== 'undefined') row.querySelector('.it-total').textContent = Number(data.total).toFixed(2);
            }

            row.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', updatePurchaseTotals);
                el.addEventListener('change', updatePurchaseTotals);
            });

            categorySelect.addEventListener('change', () => toggleReadyScrewFields(row, categorySelect));
            applyInitialData(initialData);
            toggleReadyScrewFields(row, categorySelect);
            return row;
        }

        function updatePurchaseTotals() {
            App.invoiceEngine.refreshTotals('purchase');
        }

        async function savePurchaseInvoice() {
            const form = document.getElementById('purchaseInvoiceForm');
            App.utils.clearValidation(form);
            if (!App.hasPermission('editInvoices')) {
                App.ui.showToast('You do not have permission to edit invoices', 'error');
                return;
            }

            const date = document.getElementById('purchaseDate').value;
            const suppId = document.getElementById('purchaseSupplierId').value;
            const lines = App.invoiceEngine.readLinesFromDOM('purchase');
            const invoiceTaxInput = parseFloat(document.getElementById('purchaseInvoiceTax').value) || 0;
            const totals = App.invoiceEngine.calculateTotals('purchase', lines, invoiceTaxInput);
            const existingId = document.getElementById('purchaseInvoiceIdEdit').value;
            const purId = existingId || await App.invoiceEngine.nextInvoiceId('purchase');

            const invoice = {
                purchase_id: purId,
                invoice_id: purId,
                date,
                supplier_id: suppId,
                supplierId: suppId,
                lines,
                invoice_subtotal: totals.subtotal,
                invoice_line_tax_total: totals.lineTax,
                invoice_tax: totals.invoiceTax,
                invoice_grand_total: totals.grand,
                notes: document.getElementById('purchaseNotes').value || '',
                updatedAt: new Date().toISOString(),
                createdBy: typeof getCurrentUserName === 'function' ? getCurrentUserName() : 'User'
            };

            const validation = App.invoiceEngine.validateInvoice('purchase', { date, partyId: suppId, lines, totals });
            if (!validation.valid) {
                validation.errors.forEach(err => {
                    if (err.field === 'date') App.utils.markInvalid(document.getElementById('purchaseDate'), err.message);
                    if (err.field === 'party') App.utils.markInvalid(document.getElementById('purchaseSupplier'), err.message);
                    if (err.field.startsWith('line-')) {
                        const parts = err.field.split('-');
                        const idx = parseInt(parts[1], 10);
                        const rows = document.querySelectorAll('#purchaseLineItems tr');
                        const row = rows[idx];
                        if (row) {
                            const fieldKey = parts[2];
                            if (fieldKey === 'qty') App.utils.markInvalid(row.querySelector('.it-qty'), err.message);
                            if (fieldKey === 'rate') App.utils.markInvalid(row.querySelector('.it-rate'), err.message);
                            if (fieldKey === 'size') App.utils.markInvalid(row.querySelector('.it-size'), err.message);
                            if (fieldKey === 'stage') App.utils.markInvalid(row.querySelector('.it-stage'), err.message);
                            if (fieldKey === 'bags') App.utils.markInvalid(row.querySelector('.it-bags'), err.message);
                        }
                    }
                });
                App.ui.showToast(validation.errors[0].message, 'error');
                return;
            }

            try {
                await App.db.saveInvoice('purchase', invoice);
            } catch (error) {
                console.error('Error saving purchase invoice', error);
                App.ui.showToast(error.message || 'Unable to save purchase invoice', 'error');
                return;
            }

            try {
                if (isConnected) {
                    const allLedgers = await fbGetAll('ledgerEntries');
                    const existingLedgers = allLedgers.filter(l => l.reference_id === purId && l.reference_type === 'PURCHASE');
                    for (const led of existingLedgers) {
                        await fbDelete('ledgerEntries', led.id);
                    }
                }
                await safePush('ledgerEntries', {
                    date,
                    party_type: 'SUPPLIER',
                    party_id: suppId,
                    reference_type: 'PURCHASE',
                    reference_id: purId,
                    debit: 0,
                    credit: totals.grand,
                    note: `Purchase ${purId}`
                });
            } catch (err) {
                console.warn('Ledger update skipped for purchase', err);
            }

            let readyInventoryTouched = false;
            for (const line of lines) {
                if (!line.size_id) continue;
                let stock = null;
                try { stock = await fbGet('stockLevels', line.size_id); } catch (err) { }
                if (!stock) stock = { size_id: line.size_id, raw_wire_qty: 0, finished_goods_qty: 0 };
                const category = (line.category || '').toLowerCase();
                if (category === 'wire') {
                    stock.raw_wire_qty = (stock.raw_wire_qty || 0) + line.qty;
                } else if (category === 'ready screws') {
                    stock.finished_goods_qty = (stock.finished_goods_qty || 0) + line.qty;
                }
                await safePut('stockLevels', line.size_id, stock);

                if (category === 'ready screws') {
                    const stageKey = typeof normalizeStageKey === 'function' ? normalizeStageKey(line.stage || 'Finished Goods') : (line.stage || 'Finished Goods');
                    const sizeKey = getInventorySizeKey(line.size_id);
                    if (!appState.inventory[stageKey]) appState.inventory[stageKey] = {};
                    const bagsToAdd = line.bags_received && line.bags_received > 0 ? line.bags_received : Math.max(1, Math.ceil(line.qty || 0));
                    appState.inventory[stageKey][sizeKey] = (appState.inventory[stageKey][sizeKey] || 0) + bagsToAdd;
                    readyInventoryTouched = true;
                }
            }
            if (readyInventoryTouched) {
                try { await fbPut('appState', 'appState', appState); } catch (err) { console.warn('Unable to persist inventory change', err); }
                if (typeof renderInventoryTab === 'function') renderInventoryTab();
            }

            const supplierName = App.utils.resolveName('supplier', suppId, 'Supplier');
            App.db.log({
                action: existingId ? 'purchase.invoice.update' : 'purchase.invoice.create',
                entityType: 'purchaseInvoice',
                entityId: purId,
                description: `${existingId ? 'Updated' : 'Created'} purchase ${purId} for ${supplierName}`,
                extra: { total: totals.grand, lines: lines.length }
            });

            clearPurchaseForm();
            App.ui.showToast(`Saved purchase ${purId}`, 'success');
        }

        function clearPurchaseForm() {
            document.getElementById('purchaseInvoiceForm').reset();
            document.getElementById('purchaseDate').value = getToday();
            document.getElementById('purchaseLineItems').innerHTML = '';
            document.getElementById('purchaseSupplierId').value = '';
            document.getElementById('purchaseInvoiceTax').value = '0';
            document.getElementById('purchaseSubtotal').textContent = '0';
            document.getElementById('purchaseTaxTotal').textContent = '0';
            document.getElementById('purchaseInvoiceTaxDisplay').textContent = '0';
            document.getElementById('purchaseGrandTotal').textContent = '0';
            document.getElementById('purchaseInvoiceIdEdit').value = '';
            addPurchaseLine();
        }

        async function viewPurchaseInvoice(purId) {
            try {
                const inv = await App.db.getInvoice('purchase', purId);
                if (!inv) {
                    App.ui.showToast('Invoice not found', 'error');
                    return;
                }
                await App.invoiceEngine.renderInvoiceModal(inv, 'purchase');
            } catch (error) {
                console.error('Error viewing purchase invoice:', error);
                App.ui.showToast('Error loading invoice: ' + error.message, 'error');
            }
        }

        async function editSalesInvoice(invId) {
            try {
                const inv = await App.db.getInvoice('sales', invId);
                if (!inv) {
                    App.ui.showToast('Invoice not found', 'error');
                    return;
                }
                const custKey = inv.customer_id || inv.customerId || inv.customer;
                const customerName = App.utils.resolveName('customer', custKey, 'N/A');
                document.getElementById('saleDate').value = inv.date;
                document.getElementById('saleCustomer').value = customerName;
                document.getElementById('saleCustomerId').value = custKey || '';
                document.getElementById('saleInvoiceTax').value = inv.invoice_tax || '0';
                document.getElementById('saleNotes').value = inv.notes || '';
                document.getElementById('saleLineItems').innerHTML = '';

                for (const line of inv.lines || []) {
                    const sizeName = line.size_id ? App.utils.resolveSizeName(line.size_id, '') : '';
                    await addSaleLine({
                        sizeName,
                        sizeId: line.size_id || '',
                        unit: line.unit_type || 'KG',
                        qty: line.qty,
                        rate: line.rate_per_unit,
                        discount: line.discount_pct || 0,
                        tax: line.tax_per_unit,
                        total: line.line_grand_total
                    });
                }
                document.getElementById('saleInvoiceIdEdit').value = invId;
                updateSalesTotals();
                switchSalesSubtab('sales-create', document.querySelector('#sales .subtab-btn'));
            } catch (error) {
                console.error('Error editing sales invoice:', error);
                App.ui.showToast('Error loading invoice for editing: ' + error.message, 'error');
            }
        }

        async function deleteSalesInvoice(invId) {
            if (!App.hasPermission('deleteInvoices')) {
                App.ui.showToast('You do not have permission to delete invoices', 'error');
                return;
            }
            const inv = await App.db.getInvoice('sales', invId);
            if (!inv) {
                App.ui.showToast('Invoice not found', 'error');
                return;
            }
            const customerName = App.utils.resolveName('customer', inv.customer_id || inv.customerId, 'Customer');
            if (!confirm(`Delete invoice ${invId} for ${customerName}?`)) return;
            try {
                for (const line of inv.lines || []) {
                    if (line.size_id) {
                        let stock = await fbGet('stockLevels', line.size_id).catch(() => null) || { size_id: line.size_id, raw_wire_qty: 0, finished_goods_qty: 0 };
                        if (line.unit_type === 'PKT') stock.finished_goods_qty = (stock.finished_goods_qty || 0) + (line.qty || 0);
                        await safePut('stockLevels', line.size_id, stock);
                    }
                }
                try {
                    const ledgers = await fbGetAll('ledgerEntries');
                    const entries = ledgers.filter(l => l.reference_id === invId && l.reference_type === 'SALE');
                    for (const ent of entries) {
                        await safeDelete('ledgerEntries', ent.id);
                    }
                } catch (err) {
                    console.warn('Unable to clear ledger entries for sale', err);
                }
                await App.db.deleteInvoice('sales', invId);
                App.db.log({
                    action: 'sales.invoice.delete',
                    entityType: 'salesInvoice',
                    entityId: invId,
                    description: `Deleted invoice ${invId} for ${customerName}`,
                    extra: { total: inv.invoice_grand_total, customer: customerName }
                });
                App.ui.showToast('Sales invoice deleted', 'success');
            } catch (err) {
                console.error('Error deleting sales invoice', err);
                App.ui.showToast(err.message || 'Unable to delete invoice', 'error');
            }
        }

        async function refreshPurchaseInvoiceList() {
            try {
                await App.db.listInvoices('purchase');
                App.invoiceEngine.renderInvoiceTable('purchase');
            } catch (error) {
                console.error("Error refreshing purchase invoices:", error);
            }
        }

        async function editPurchaseInvoice(purId) {
            try {
                const inv = await App.db.getInvoice('purchase', purId);
                if (!inv) return;

                const supplierId = inv.supplier_id || inv.supplierId || inv.supplierid || inv.supplier || inv.supplier_name || '';
                const supplierName = App.utils.resolveName('supplier', supplierId, inv.supplier_name || 'N/A');

                document.getElementById('purchaseDate').value = inv.date;
                document.getElementById('purchaseSupplier').value = supplierName;
                document.getElementById('purchaseSupplierId').value = supplierId;
                document.getElementById('purchaseInvoiceTax').value = inv.invoice_tax || '0';
                document.getElementById('purchaseNotes').value = inv.notes || '';
                document.getElementById('purchaseLineItems').innerHTML = '';

                for (const line of inv.lines) {
                    let sizeName = '';
                    if (line.size_id) {
                        const size = await fbGet('sizes', line.size_id);
                        if (size) sizeName = size.size_name;
                    }
                    await addPurchaseLine({
                        category: line.category,
                        description: line.description || '',
                        sizeName,
                        sizeId: line.size_id || '',
                        unit: line.unit_type || 'KG',
                        qty: line.qty,
                        rate: line.rate_per_unit,
                        tax: line.tax_per_unit,
                        total: line.line_grand_total,
                        stage: line.stage || '',
                        receivedBags: line.bags_received || ''
                    });
                }
                document.getElementById('purchaseInvoiceIdEdit').value = purId;
                updatePurchaseTotals();
                switchPurchaseSubtab('purchase-create', document.querySelector('#purchase .subtab-btn'));
            } catch (error) {
                console.error('Error editing purchase invoice:', error);
                App.ui.showToast('Error loading invoice for editing: ' + error.message, 'error');
            }
        }

        async function deletePurchaseInvoice(purId) {
            if (!App.hasPermission('deleteInvoices')) {
                App.ui.showToast('You do not have permission to delete invoices', 'error');
                return;
            }
            const inv = await App.db.getInvoice('purchase', purId);
            if (!inv) {
                App.ui.showToast('Invoice not found', 'error');
                return;
            }
            const supplierName = App.utils.resolveName('supplier', inv.supplier_id || inv.supplierId, 'Supplier');
            const totalDisplay = App.utils.formatCurrency(inv.invoice_grand_total || 0);
            if (!confirm(`Delete purchase ${purId} for ${supplierName}? Total ${totalDisplay}`)) return;
            let readyInventoryTouched = false;
            for (const line of inv.lines || []) {
                if (line.category === 'Wire' && line.size_id) {
                    const stock = await fbGet('stockLevels', line.size_id).catch(() => null) || { size_id: line.size_id, raw_wire_qty: 0, finished_goods_qty: 0 };
                    stock.raw_wire_qty = (parseFloat(stock.raw_wire_qty) || 0) - (line.qty || 0);
                    await safePut('stockLevels', line.size_id, stock);
                } else if (line.category === 'Ready Screws' && line.size_id) {
                    const stock = await fbGet('stockLevels', line.size_id).catch(() => null) || { size_id: line.size_id, raw_wire_qty: 0, finished_goods_qty: 0 };
                    stock.finished_goods_qty = (parseFloat(stock.finished_goods_qty) || 0) - (line.qty || 0);
                    await safePut('stockLevels', line.size_id, stock);
                    const stageKey = typeof normalizeStageKey === 'function' ? normalizeStageKey(line.stage || 'Finished Goods') : (line.stage || 'Finished Goods');
                    const sizeKey = getInventorySizeKey(line.size_id);
                    if (appState.inventory && appState.inventory[stageKey] && typeof appState.inventory[stageKey][sizeKey] !== 'undefined') {
                        const bagsToRemove = (line.bags_received && line.bags_received > 0) ? line.bags_received : Math.max(1, Math.ceil(line.qty || 0));
                        const current = parseFloat(appState.inventory[stageKey][sizeKey]) || 0;
                        const nextValue = Math.max(0, current - bagsToRemove);
                        if (nextValue <= 0) {
                            delete appState.inventory[stageKey][sizeKey];
                        } else {
                            appState.inventory[stageKey][sizeKey] = nextValue;
                        }
                        readyInventoryTouched = true;
                    }
                }
            }
            try {
                const ledgers = await fbGetAll('ledgerEntries');
                const ents = ledgers.filter(l => l.reference_id === purId && l.reference_type === 'PURCHASE');
                for (const ent of ents) {
                    await safeDelete('ledgerEntries', ent.id);
                }
            } catch (err) {
                console.warn('Unable to clean purchase ledger entries', err);
            }
            await App.db.deleteInvoice('purchase', purId);
            if (readyInventoryTouched) {
                try { await fbPut('appState', 'appState', appState); } catch (err) { console.warn('Unable to persist inventory after delete', err); }
                if (typeof renderInventoryTab === 'function') renderInventoryTab();
                if (typeof renderFinishedGoodsList === 'function') renderFinishedGoodsList();
            }
            const supplier = inv.supplier_id ? await fbGet('suppliers', inv.supplier_id).catch(() => null) : null;
            App.db.log({
                action: 'purchase.invoice.delete',
                entityType: 'purchaseInvoice',
                entityId: purId,
                description: `Deleted purchase ${purId} for ${supplier?.supplier_name || 'N/A'} (${(inv.invoice_grand_total || 0).toFixed(2)})`,
                extra: { purchaseId: purId, supplier: supplier?.supplier_name || 'N/A', total: inv.invoice_grand_total }
            });
            App.ui.showToast('Purchase invoice deleted', 'success');
        }

        // ========== BULK ACTIONS FOR PURCHASE INVOICES ==========
        function toggleSelectAllPurchaseInvoices() {
            const selectAllCheckbox = document.getElementById('selectAllPurchaseInvoices');
            const checkboxes = document.querySelectorAll('#purchaseInvoiceTable .purchaseInvoiceCheckbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function applyBulkActionPurchaseInvoices() {
            const selectElement = document.getElementById('bulkActionPurchaseInvoices');
            const action = selectElement.value;

            if (!action) {
                alert('Please select a bulk action');
                return;
            }

            const checkboxes = document.querySelectorAll('#purchaseInvoiceTable .purchaseInvoiceCheckbox:checked');

            if (checkboxes.length === 0) {
                alert('Please select at least one invoice');
                return;
            }

            const selectedIds = Array.from(checkboxes).map(checkbox => checkbox.dataset.id);

            if (action === 'edit') {
                if (selectedIds.length > 1) {
                    alert('Please select only one invoice to edit');
                    return;
                }

                // Edit the first selected invoice
                editPurchaseInvoice(selectedIds[0]);
            } else if (action === 'delete') {
                if (!confirm(`Are you sure you want to delete ${selectedIds.length} selected invoices?`)) {
                    return;
                }

                // Delete all selected invoices
                selectedIds.forEach(id => {
                    deletePurchaseInvoice(id);
                });

                // Reset the bulk action dropdown
                selectElement.value = '';

                // Uncheck select all checkbox
                document.getElementById('selectAllPurchaseInvoices').checked = false;
            }
        }

        // ========== MASTERS ==========
        function openAddCustomerModal() {
            document.getElementById('customerId').value = '';
            document.getElementById('customerForm').reset();
            openModal('customerModal');
        }

        async function saveCustomer(e) {
            e.preventDefault();
            App.utils.clearValidation(document.getElementById('customerForm'));
            const name = (document.getElementById('customerName').value || '').trim();
            if (!name) {
                App.utils.markInvalid(document.getElementById('customerName'), 'Name required');
                App.ui.showToast('Customer name is required', 'error');
                return;
            }
            const id = document.getElementById('customerId').value || 'C_' + Date.now();
            const cust = { id, display_name: name };
            try {
                await App.db.saveMaster('customers', cust);
                App.db.log({ action: 'master.customer.save', entityType: 'customer', entityId: id, description: `Saved customer ${name}` });
                closeModal('customerModal');
                App.ui.showToast('Customer saved', 'success');
            } catch (err) {
                console.error('Error saving customer', err);
                App.ui.showToast(err.message || 'Unable to save customer', 'error');
            }
        }

        async function refreshCustomersTable() {
            try {
                const custs = (App.state.customers && App.state.customers.length) ? App.state.customers : await fbGetAll('customers');
                updateCaches(custs, 'customers');
                const tbody = document.querySelector('#customersTable tbody');
                tbody.innerHTML = '';
                const masterDisabled = App.hasPermission('manageMasters') ? '' : 'disabled aria-disabled="true"';
                custs.forEach(c => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="checkbox-column"><input type="checkbox" class="rowCheckbox" data-id="${c.id}"></td>
                        <td>${c.display_name}</td>
                        <td><div class="action-buttons"><button type="button" ${masterDisabled} onclick="editCustomer('${c.id}')" style="width:auto;padding:5px 10px;font-size:12px;">Edit</button><button type="button" class="danger" ${masterDisabled} onclick="deleteCustomer('${c.id}')" style="width:auto;padding:5px 10px;font-size:12px;">Delete</button></div></td>`;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("Error refreshing customers:", error);
            }
        }

        async function editCustomer(id) {
            const cust = await fbGet('customers', id);
            if (cust) {
                document.getElementById('customerId').value = id;
                document.getElementById('customerName').value = cust.display_name;
                openModal('customerModal');
            }
        }

        async function deleteCustomer(id) {
            if (!confirm('Delete?')) return;
            try {
                await App.db.deleteMaster('customers', id);
                App.db.log({ action: 'master.customer.delete', entityType: 'customer', entityId: id, description: `Deleted customer ${id}` });
                App.ui.showToast('Customer deleted', 'success');
            } catch (err) {
                console.error('Error deleting customer', err);
                App.ui.showToast(err.message || 'Unable to delete customer', 'error');
            }
        }

        function openAddSupplierModal() {
            document.getElementById('supplierId').value = '';
            document.getElementById('supplierForm').reset();
            openModal('supplierModal');
        }

        async function saveSupplier(e) {
            e.preventDefault();
            App.utils.clearValidation(document.getElementById('supplierForm'));
            const name = (document.getElementById('supplierName').value || '').trim();
            if (!name) {
                App.utils.markInvalid(document.getElementById('supplierName'), 'Name required');
                App.ui.showToast('Supplier name is required', 'error');
                return;
            }
            const id = document.getElementById('supplierId').value || 'S_' + Date.now();
            const supp = { id, supplier_name: name };
            try {
                await App.db.saveMaster('suppliers', supp);
                App.db.log({ action: 'master.supplier.save', entityType: 'supplier', entityId: id, description: `Saved supplier ${name}` });
                closeModal('supplierModal');
                App.ui.showToast('Supplier saved', 'success');
            } catch (err) {
                console.error('Error saving supplier', err);
                App.ui.showToast(err.message || 'Unable to save supplier', 'error');
            }
        }

        async function refreshSuppliersTable() {
            try {
                const supps = (App.state.suppliers && App.state.suppliers.length) ? App.state.suppliers : await fbGetAll('suppliers');
                updateCaches(supps, 'suppliers');
                const tbody = document.querySelector('#suppliersTable tbody');
                tbody.innerHTML = '';
                const masterDisabled = App.hasPermission('manageMasters') ? '' : 'disabled aria-disabled="true"';
                supps.forEach(s => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="checkbox-column"><input type="checkbox" class="rowCheckbox" data-id="${s.id}"></td>
                        <td>${s.supplier_name}</td>
                        <td><div class="action-buttons"><button type="button" ${masterDisabled} onclick="editSupplier('${s.id}')" style="width:auto;padding:5px 10px;font-size:12px;">Edit</button><button type="button" class="danger" ${masterDisabled} onclick="deleteSupplier('${s.id}')" style="width:auto;padding:5px 10px;font-size:12px;">Delete</button></div></td>`;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("Error refreshing suppliers:", error);
            }
        }

        async function editSupplier(id) {
            const supp = await fbGet('suppliers', id);
            if (supp) {
                document.getElementById('supplierId').value = id;
                document.getElementById('supplierName').value = supp.supplier_name;
                openModal('supplierModal');
            }
        }

        async function deleteSupplier(id) {
            if (!confirm('Delete?')) return;
            try {
                await App.db.deleteMaster('suppliers', id);
                App.db.log({ action: 'master.supplier.delete', entityType: 'supplier', entityId: id, description: `Deleted supplier ${id}` });
                App.ui.showToast('Supplier deleted', 'success');
            } catch (err) {
                console.error('Error deleting supplier', err);
                App.ui.showToast(err.message || 'Unable to delete supplier', 'error');
            }
        }

        function openAddSizeModal() {
            document.getElementById('sizeId').value = '';
            document.getElementById('sizeForm').reset();
            openModal('sizeModal');
        }

        async function saveSize(e) {
            e.preventDefault();
            App.utils.clearValidation(document.getElementById('sizeForm'));
            const name = (document.getElementById('sizeName').value || '').trim();
            const code = (document.getElementById('sizeCode').value || '').trim();
            if (!name || !code) {
                if (!code) App.utils.markInvalid(document.getElementById('sizeCode'), 'Code required');
                if (!name) App.utils.markInvalid(document.getElementById('sizeName'), 'Name required');
                App.ui.showToast('Size code and name are required', 'error');
                return;
            }
            const id = document.getElementById('sizeId').value || 'SZ_' + Date.now();
            const sz = {
                id,
                code,
                size_name: name,
                default_unit_type: document.getElementById('sizeUnitType').value,
                description: document.getElementById('sizeDesc').value,
                price_per_kg: parseFloat(document.getElementById('sizePriceKG').value) || 0,
                price_per_pkt: parseFloat(document.getElementById('sizePricePKT').value) || 0
            };
            try {
                await App.db.saveMaster('sizes', sz);
                App.db.log({ action: 'master.size.save', entityType: 'size', entityId: id, description: `Saved size ${name}` });
                closeModal('sizeModal');
                App.ui.showToast('Size saved', 'success');
            } catch (err) {
                console.error('Error saving size', err);
                App.ui.showToast(err.message || 'Unable to save size', 'error');
            }
        }

        async function refreshSizesTable() {
            try {
                const sizes = (App.state.sizes && App.state.sizes.length) ? App.state.sizes : await fbGetAll('sizes');
                updateCaches(sizes, 'sizes');
                const tbody = document.querySelector('#sizesTable tbody');
                tbody.innerHTML = '';
                const masterDisabled = App.hasPermission('manageMasters') ? '' : 'disabled aria-disabled="true"';
                sizes.forEach(s => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="checkbox-column"><input type="checkbox" class="rowCheckbox" data-id="${s.id}"></td>
                        <td>${s.code || ''}</td>
                        <td>${s.size_name}</td>
                        <td>${s.description || ''}</td>
                        <td>${s.default_unit_type || 'KG'}</td>
                        <td>${(s.price_per_kg || 0).toFixed(2)}</td>
                        <td>${(s.price_per_pkt || 0).toFixed(2)}</td>
                        <td><div class="action-buttons"><button type="button" ${masterDisabled} onclick="editSize('${s.id}')" style="width:auto;padding:5px 10px;font-size:12px;">Edit</button><button type="button" class="danger" ${masterDisabled} onclick="deleteSize('${s.id}')" style="width:auto;padding:5px 10px;font-size:12px;">Delete</button></div></td>`;
                    tbody.appendChild(row);
                });
                appState.sizes = normalizeSizes(sizes);
                updateSizeOptionsDatalist();
            } catch (error) {
                console.error("Error refreshing sizes:", error);
            }
        }

        async function editSize(id) {
            const sz = await fbGet('sizes', id);
            if (sz) {
                document.getElementById('sizeId').value = id;
                document.getElementById('sizeCode').value = sz.code;
                document.getElementById('sizeName').value = sz.size_name;
                document.getElementById('sizeUnitType').value = sz.default_unit_type || 'KG';
                document.getElementById('sizeDesc').value = sz.description || '';
                document.getElementById('sizePriceKG').value = sz.price_per_kg || '';
                document.getElementById('sizePricePKT').value = sz.price_per_pkt || '';
                openModal('sizeModal');
            }
        }

        async function deleteSize(id) {
            if (!confirm('Delete?')) return;
            try {
                await App.db.deleteMaster('sizes', id);
                App.db.log({ action: 'master.size.delete', entityType: 'size', entityId: id, description: `Deleted size ${id}` });
                App.ui.showToast('Size deleted', 'success');
            } catch (err) {
                console.error('Error deleting size', err);
                App.ui.showToast(err.message || 'Unable to delete size', 'error');
            }
        }

        // ========== BULK ACTIONS FOR MASTERS ==========
        function toggleSelectAll(type) {
            const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const checkboxes = document.querySelectorAll(`#${type}Table .rowCheckbox`);

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function applyBulkAction(type) {
            const selectElement = document.getElementById(`bulkAction${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const action = selectElement.value;

            if (!action) {
                alert('Please select a bulk action');
                return;
            }

            const checkboxes = document.querySelectorAll(`#${type}Table .rowCheckbox:checked`);

            if (checkboxes.length === 0) {
                alert('Please select at least one item');
                return;
            }

            const selectedIds = Array.from(checkboxes).map(checkbox => checkbox.dataset.id);

            if (action === 'edit') {
                if (selectedIds.length > 1) {
                    alert('Please select only one item to edit');
                    return;
                }

                // Edit the first selected item
                if (type === 'customers') {
                    editCustomer(selectedIds[0]);
                } else if (type === 'suppliers') {
                    editSupplier(selectedIds[0]);
                } else if (type === 'sizes') {
                    editSize(selectedIds[0]);
                }
            } else if (action === 'delete') {
                if (!confirm(`Are you sure you want to delete ${selectedIds.length} selected items?`)) {
                    return;
                }

                // Delete all selected items
                selectedIds.forEach(id => {
                    if (type === 'customers') {
                        deleteCustomer(id);
                    } else if (type === 'suppliers') {
                        deleteSupplier(id);
                    } else if (type === 'sizes') {
                        deleteSize(id);
                    }
                });

                // Reset the bulk action dropdown
                selectElement.value = '';

                // Uncheck select all checkbox
                document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`).checked = false;
            }
        }

        // ========== IMPORT ==========
        function openImportModal(type) {
            document.getElementById('importType').value = type;
            document.getElementById('importModalTitle').textContent = `Import ${type}`;
            document.getElementById('importStep1').style.display = 'block';
            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('importFile').value = '';
            openModal('importModal');
        }

        async function previewExcelFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const lines = evt.target.result.split('\n');
                    const header = lines[0].split(',').map(s => s.trim().replace(/"/g, ''));
                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const vals = lines[i].split(',').map(s => s.trim().replace(/"/g, ''));
                            const row = {};
                            header.forEach((h, idx) => row[h] = vals[idx] || '');
                            data.push(row);
                        }
                    }
                    window.importedData = data;
                    window.importedColumns = header;
                    showColumnMappingUI();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function getImportFields(type) {
            switch (type) {
                case 'customers':
                    return ['display_name'];
                case 'suppliers':
                    return ['supplier_name'];
                case 'machines':
                    return ['machine_type', 'display_name', 'status', 'current_size'];
                default:
                    return ['code', 'size_name', 'description', 'price_per_kg', 'price_per_pkt'];
            }
        }

        function showColumnMappingUI() {
            const type = document.getElementById('importType').value;
            const fields = getImportFields(type);

            const ui = document.getElementById('columnMappingUI');
            ui.innerHTML = '';
            fields.forEach(f => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                const label = document.createElement('label');
                label.textContent = f + ': ';
                const sel = document.createElement('select');
                sel.id = 'map_' + f;
                sel.innerHTML = '<option value="">-- Select --</option>';
                window.importedColumns.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    sel.appendChild(opt);
                });
                div.appendChild(label);
                div.appendChild(sel);
                ui.appendChild(div);
            });

            document.getElementById('importStep1').style.display = 'none';
            document.getElementById('importStep2').style.display = 'block';
        }

        async function confirmImport() {
            if (!isConnected) {
                alert("No internet connection. Cannot import data.");
                return;
            }

            const type = document.getElementById('importType').value;
            const fields = getImportFields(type);

            const mapping = {};
            fields.forEach(f => { mapping[f] = document.getElementById('map_' + f).value; });

            let cnt = 0;
            for (const row of window.importedData) {
                const rec = { id: 'ID_' + Date.now() + '_' + cnt };
                for (const f in mapping) {
                    if (mapping[f]) rec[f] = row[mapping[f]];
                }
                if (type === 'machines') {
                    rec.machine_type = rec.machine_type || 'Other';
                    rec.display_name = rec.display_name || `Machine ${cnt + 1}`;
                    rec.status = rec.status || 'Idle';
                    rec.current_size = rec.current_size || '';
                }
                await fbInsert(type, rec);
                cnt++;
            }

            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('importStep3').style.display = 'block';
            document.getElementById('importMessage').textContent = ' Imported ' + cnt + ' records.';
        }

        function cancelImport() {
            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('importStep1').style.display = 'block';
        }


        // ===== PATCH: Extended Invoice & Bank Import (non-destructive) =====
        (function () {
            function parseNum(v) { const n = parseFloat(String(v || '').replace(/[^0-9.\-]/g, '')); return isNaN(n) ? 0 : n; }

            async function getOrCreateCustomerByName(nameRaw) {
                const name = (nameRaw || '').trim();
                const customers = await fbGetAll('customers');
                const found = customers.find(c => (c.display_name || '').toLowerCase() === name.toLowerCase());
                if (found) return found.id;
                const id = 'C_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                await fbPut('customers', id, { id, display_name: name || ('UNKNOWN CUSTOMER ' + id.slice(-4)) });
                return id;
            }
            async function getOrCreateSupplierByName(nameRaw) {
                const name = (nameRaw || '').trim();
                const suppliers = await fbGetAll('suppliers');
                const found = suppliers.find(s => (s.supplier_name || '').toLowerCase() === name.toLowerCase());
                if (found) return found.id;
                const id = 'S_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                await fbPut('suppliers', id, { id, supplier_name: name || ('UNKNOWN SUPPLIER ' + id.slice(-4)) });
                return id;
            }
            async function findSizeIdByName(sizeNameRaw) {
                const nm = (sizeNameRaw || '').trim();
                if (!nm) return null;
                const sizes = await fbGetAll('sizes');
                const hit = sizes.find(s => (s.size_name || '').toLowerCase() === nm.toLowerCase());
                return hit ? hit.id : null;
            }
            function nextRef(prefix, date) {
                const ymd = (date || getToday()).replace(/-/g, '');
                return fbGetAll(prefix === 'S' ? 'salesInvoices' : 'purchaseInvoices').then(all => {
                    const cnt = all.filter(x => (prefix === 'S' ? (x.invoice_id || '') : (x.purchase_id || '')).includes(ymd)).length;
                    return `${prefix}-${ymd}-${String(cnt + 1).padStart(3, '0')}`;
                });
            }

            // Override column mapping to include our new types while preserving old ones
            const _orig_showMap = showColumnMappingUI;
            showColumnMappingUI = function () {
                const type = document.getElementById('importType').value;
                let fields;
                if (type === 'salesImport') {
                    fields = ['date', 'customer_name', 'size_name', 'unit_type', 'qty', 'rate', 'discount_pct', 'line_tax', 'notes'];
                } else if (type === 'purchaseImport') {
                    fields = ['date', 'supplier_name', 'category', 'description', 'size_name', 'unit_type', 'qty', 'rate', 'line_tax', 'invoice_tax', 'notes'];
                } else if (type === 'bankLedger') {
                    fields = ['date', 'party_name', 'debit', 'credit', 'note'];
                } else {
                    return _orig_showMap();
                }
                const ui = document.getElementById('columnMappingUI');
                ui.innerHTML = '';
                fields.forEach(f => {
                    const row = document.createElement('div');
                    row.style.marginBottom = '10px';
                    row.innerHTML = `<label>${f}: </label><select id="map_${f}"><option value="">-- Select --</option>${(window.importedColumns || []).map(c => `<option value="${c}">${c}</option>`).join('')}</select>`;
                    ui.appendChild(row);
                });
                document.getElementById('importStep1').style.display = 'none';
                document.getElementById('importStep2').style.display = 'block';
            };

            // Route confirmImport for new types (fallback to original for others)
            const _orig_confirm = confirmImport;
            confirmImport = async function () {
                const type = document.getElementById('importType').value;
                const mapVal = (k) => { const el = document.getElementById('map_' + k); return el ? el.value : ''; };
                if (type === 'salesImport' || type === 'purchaseImport' || type === 'bankLedger') {
                    const rows = window.importedData || [];
                    try {
                        if (type === 'salesImport') {
                            // Build and save minimal 1-line invoices per row
                            for (const r of rows) {
                                const date = r[mapVal('date')] || getToday();
                                const customer = r[mapVal('customer_name')] || '';
                                const sizeName = r[mapVal('size_name')] || '';
                                const unit = (r[mapVal('unit_type')] || 'PKT').toUpperCase();
                                const qty = parseNum(r[mapVal('qty')]);
                                const rate = parseNum(r[mapVal('rate')]);
                                const disc = parseNum(r[mapVal('discount_pct')]);
                                const perTax = parseNum(r[mapVal('line_tax')]);
                                const notes = r[mapVal('notes')] || '';

                                const custId = await getOrCreateCustomerByName(customer);
                                const sizeId = await findSizeIdByName(sizeName);

                                const line_before = qty * rate * (1 - (disc / 100));
                                const line_tax_total = qty * perTax;
                                const sub = line_before;
                                const invLineTax = line_tax_total;
                                const invTax = sub * 0.18;
                                const grand = sub + invLineTax + invTax;

                                const invId = await nextRef('S', date);
                                const line = { line_id: 1, category: 'Sale', description: sizeName || 'Imported', size_id: sizeId || null, unit_type: unit, qty, rate_per_unit: rate, discount_pct: disc, tax_per_unit: perTax, line_total_before_tax: line_before, line_tax_total, line_grand_total: line_before + line_tax_total };
                                const invoice = { invoice_id: invId, date, customer_id: custId, lines: [line], invoice_subtotal: sub, invoice_line_tax_total: invLineTax, invoice_tax: invTax, invoice_grand_total: grand, notes };
                                await fbPut('salesInvoices', invId, invoice);
                                await fbInsert('ledgerEntries', { date, party_type: 'CUSTOMER', party_id: custId, reference_type: 'SALE', reference_id: invId, debit: grand, credit: 0, note: `Sale ${invId}` });
                                if (sizeId && unit === 'PKT') {
                                    let stock = await fbGet('stockLevels', sizeId) || { size_id: sizeId, raw_wire_qty: 0, finished_goods_qty: 0 };
                                    stock.finished_goods_qty = (parseFloat(stock.finished_goods_qty) || 0) - qty;
                                    await fbPut('stockLevels', sizeId, stock);
                                }
                            }
                        } else if (type === 'purchaseImport') {
                            for (const r of rows) {
                                const date = r[mapVal('date')] || getToday();
                                const supplier = r[mapVal('supplier_name')] || '';
                                const category = r[mapVal('category')] || 'P E';
                                const desc = r[mapVal('description')] || 'Imported';
                                const sizeName = r[mapVal('size_name')] || '';
                                const unit = (r[mapVal('unit_type')] || 'KG').toUpperCase();
                                const qty = parseNum(r[mapVal('qty')]);
                                const rate = parseNum(r[mapVal('rate')]);
                                const perTax = parseNum(r[mapVal('line_tax')]);
                                const invTax = parseNum(r[mapVal('invoice_tax')]);
                                const notes = r[mapVal('notes')] || '';

                                const suppId = await getOrCreateSupplierByName(supplier);
                                const sizeId = await findSizeIdByName(sizeName);

                                const line_before = qty * rate;
                                const line_tax_total = qty * perTax;
                                const sub = line_before;
                                const invLineTax = line_tax_total;
                                const grand = sub + invLineTax + invTax;

                                const purId = await nextRef('P', date);
                                const line = { line_id: 1, category, description: desc, size_id: sizeId || null, unit_type: unit, qty, rate_per_unit: rate, tax_per_unit: perTax, line_total_before_tax: line_before, line_tax_total, line_grand_total: line_before + line_tax_total };
                                const invoice = { purchase_id: purId, date, supplier_id: suppId, lines: [line], invoice_subtotal: sub, invoice_line_tax_total: invLineTax, invoice_tax: invTax, invoice_grand_total: grand, notes };
                                await fbPut('purchaseInvoices', purId, invoice);
                                await fbInsert('ledgerEntries', { date, party_type: 'SUPPLIER', party_id: suppId, reference_type: 'PURCHASE', reference_id: purId, debit: 0, credit: grand, note: `Purchase ${purId}` });

                                if (sizeId) {
                                    let stock = await fbGet('stockLevels', sizeId) || { size_id: sizeId, raw_wire_qty: 0, finished_goods_qty: 0 };
                                    if (category === 'Wire') { stock.raw_wire_qty = (parseFloat(stock.raw_wire_qty) || 0) + qty; }
                                    if (category === 'Ready Screws') { stock.finished_goods_qty = (parseFloat(stock.finished_goods_qty) || 0) + qty; }
                                    await fbPut('stockLevels', sizeId, stock);
                                }
                            }
                        } else if (type === 'bankLedger') {
                            const all = await fbGetAll('ledgerEntries');
                            const datePrefix = getToday().replace(/-/g, '');
                            let cnt = all.filter(x => (x.reference_id || '').includes(`L-${datePrefix}-`)).length;
                            for (const r of rows) {
                                const date = r[mapVal('date')] || getToday();
                                const name = r[mapVal('party_name')] || '';
                                const debit = parseNum(r[mapVal('debit')]);
                                const credit = parseNum(r[mapVal('credit')]);
                                const note = r[mapVal('note')] || 'Imported bank entry';
                                const ref = `L-${(date || getToday()).replace(/-/g, '')}-${String(++cnt).padStart(3, '0')}`;
                                if (credit > 0) {
                                    const custId = await getOrCreateCustomerByName(name);
                                    await fbInsert('ledgerEntries', { date, party_type: 'CUSTOMER', party_id: custId, reference_type: 'RECEIPT', reference_id: ref, debit: 0, credit: credit, note });
                                } else if (debit > 0) {
                                    const suppId = await getOrCreateSupplierByName(name);
                                    await fbInsert('ledgerEntries', { date, party_type: 'SUPPLIER', party_id: suppId, reference_type: 'PAYMENT', reference_id: ref, debit: debit, credit: 0, note });
                                }
                            }
                        }
                        // Show success
                        document.getElementById('importStep2').style.display = 'none';
                        const s3 = document.getElementById('importStep3'); if (s3) s3.style.display = 'block';
                        alert('Import completed.');
                    } catch (e) { console.error(e); alert('Import failed: ' + e.message); }
                } else {
                    return _orig_confirm();
                }
            };
        })();
        // ===== END PATCH =====

        // ========== REPORTS ==========
        async function generateSizewiseReport() {
            try {
                const fromDate = document.getElementById('reportSizeFromDate').value;
                const toDate = document.getElementById('reportSizeToDate').value;
                const sales = await fbGetAll('salesInvoices');
                const sizes = await fbGetAll('sizes');

                const sizeMap = {};
                sizes.forEach(s => { sizeMap[s.id] = s; });

                const agg = {};
                for (const inv of sales) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    for (const line of inv.lines) {
                        if (!line.size_id) continue;
                        const size = sizeMap[line.size_id];
                        if (!size) continue;
                        const key = line.size_id;
                        if (!agg[key]) agg[key] = { size_name: size.size_name, total_kg: 0, total_pkt: 0, total_value: 0 };
                        if (line.unit_type === 'KG') agg[key].total_kg += line.qty;
                        else if (line.unit_type === 'PKT') agg[key].total_pkt += line.qty;
                        agg[key].total_value += line.line_grand_total;
                    }
                }

                const tbody = document.querySelector('#sizewiseTable tbody');
                tbody.innerHTML = '';
                for (const key in agg) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${agg[key].size_name}</td><td>${agg[key].total_kg.toFixed(2)}</td><td>${agg[key].total_pkt.toFixed(2)}</td><td class="currency">${agg[key].total_value.toFixed(2)}</td>`;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error("Error generating size-wise report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        async function generateSizewisePurchaseReport() {
            try {
                const fromDate = document.getElementById('reportSizePurchaseFromDate').value;
                const toDate = document.getElementById('reportSizePurchaseToDate').value;
                const purchases = await fbGetAll('purchaseInvoices');
                const sizes = await fbGetAll('sizes');

                const sizeMap = {};
                sizes.forEach(s => { sizeMap[s.id] = s; });

                const agg = {};
                for (const inv of purchases) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    for (const line of inv.lines) {
                        if (!line.size_id) continue;
                        const size = sizeMap[line.size_id];
                        if (!size) continue;
                        const key = line.size_id;
                        if (!agg[key]) agg[key] = { size_name: size.size_name, total_kg: 0, total_pkt: 0, total_value: 0 };
                        if (line.unit_type === 'KG') agg[key].total_kg += line.qty;
                        else if (line.unit_type === 'PKT') agg[key].total_pkt += line.qty;
                        agg[key].total_value += line.line_grand_total;
                    }
                }

                const tbody = document.querySelector('#sizewisePurchaseTable tbody');
                tbody.innerHTML = '';
                for (const key in agg) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${agg[key].size_name}</td><td>${agg[key].total_kg.toFixed(2)}</td><td>${agg[key].total_pkt.toFixed(2)}</td><td class="currency">${agg[key].total_value.toFixed(2)}</td>`;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error("Error generating size-wise purchase report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        async function generateCustomerwiseReport() {
            try {
                const fromDate = document.getElementById('reportCustFromDate').value;
                const toDate = document.getElementById('reportCustToDate').value;
                const filter = document.getElementById('reportCustFilter').value.toLowerCase();
                const sales = await fbGetAll('salesInvoices');
                const customers = await fbGetAll('customers');
                const sizes = await fbGetAll('sizes');

                const custMap = {};
                customers.forEach(c => { custMap[c.id] = c; });
                const sizeMap = {};
                sizes.forEach(s => { sizeMap[s.id] = s; });

                const agg = {};
                for (const inv of sales) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const cust = custMap[inv.customer_id];
                    if (!cust) continue;
                    if (filter && !cust.display_name.toLowerCase().includes(filter)) continue;
                    const key = inv.customer_id;
                    if (!agg[key]) agg[key] = { customer_name: cust.display_name, total_value: 0, total_kg: 0, total_pkt: 0, sizes: {} };
                    for (const line of inv.lines) {
                        if (!line.size_id) continue;
                        const size = sizeMap[line.size_id];
                        if (!size) continue;
                        agg[key].total_value += line.line_grand_total;
                        if (line.unit_type === 'KG') agg[key].total_kg += line.qty;
                        else if (line.unit_type === 'PKT') agg[key].total_pkt += line.qty;
                        if (!agg[key].sizes[size.size_name]) agg[key].sizes[size.size_name] = 0;
                        agg[key].sizes[size.size_name] += line.qty;
                    }
                }

                const tbody = document.querySelector('#customerwiseTable tbody');
                tbody.innerHTML = '';
                for (const key in agg) {
                    const topSizes = Object.entries(agg[key].sizes).sort((a, b) => b[1] - a[1]).slice(0, 3).map(s => s[0]).join(', ');
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${agg[key].customer_name}</td><td class="currency">${agg[key].total_value.toFixed(2)}</td><td>${agg[key].total_kg.toFixed(2)}</td><td>${agg[key].total_pkt.toFixed(2)}</td><td>${topSizes}</td>`;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error("Error generating customer-wise report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        async function generateElaborateReport() {
            try {
                const fromDate = document.getElementById('reportElaborateFromDate').value;
                const toDate = document.getElementById('reportElaborateToDate').value;

                const [purchases, sizes, stockLevels, suppliers] = await Promise.all([
                    fbGetAll('purchaseInvoices'),
                    fbGetAll('sizes'),
                    fbGetAll('stockLevels'),
                    fbGetAll('suppliers').catch(() => [])
                ]);

                let productionHistory = Array.isArray(appState.productionHistory) ? [...appState.productionHistory] : [];
                if (!productionHistory.length && isConnected) {
                    try {
                        const persisted = await fbGet('appState', 'appState');
                        if (persisted?.productionHistory?.length) {
                            productionHistory = persisted.productionHistory;
                        }
                    } catch (err) {
                        console.warn('Unable to fetch production history from Firebase', err);
                    }
                }

                const sizeMap = {};
                sizes.forEach(size => {
                    if (size?.id) {
                        sizeMap[getInventorySizeKey(size.id)] = size;
                    }
                });
                const supplierMap = {};
                suppliers.forEach(s => { if (s?.id) supplierMap[s.id] = s; });

                // Factory production aggregation
                const factoryAgg = {};
                productionHistory.forEach(entry => {
                    const ts = entry?.timestamp || entry?.time || null;
                    if (!isDateWithinRange(ts, fromDate, toDate)) return;
                    const sizeKey = getInventorySizeKey(entry.size || entry.size_id || entry.sizeId || entry.size_name);
                    if (!sizeKey) return;
                    if (!factoryAgg[sizeKey]) {
                        factoryAgg[sizeKey] = {
                            sizeName: getSizeLabel(sizeKey) || sizeMap[sizeKey]?.size_name || sizeKey,
                            totalBags: 0,
                            machines: new Set(),
                            stages: new Set(),
                            lastTimestamp: null
                        };
                    }
                    factoryAgg[sizeKey].totalBags += Number(entry.bags) || 0;
                    if (entry.machineName) factoryAgg[sizeKey].machines.add(entry.machineName);
                    if (entry.stage) factoryAgg[sizeKey].stages.add(entry.stage);
                    const parsedTs = parseAnyTimestamp(ts);
                    if (parsedTs && (!factoryAgg[sizeKey].lastTimestamp || parsedTs > factoryAgg[sizeKey].lastTimestamp)) {
                        factoryAgg[sizeKey].lastTimestamp = parsedTs;
                    }
                });

                const factoryBody = document.querySelector('#elaborateFactoryTable tbody');
                factoryBody.innerHTML = '';
                const factoryEntries = Object.values(factoryAgg);
                if (!factoryEntries.length) {
                    factoryBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#6b7280;">No production entries for this range</td></tr>';
                } else {
                    factoryEntries
                        .sort((a, b) => b.totalBags - a.totalBags)
                        .forEach(entry => {
                            const machines = Array.from(entry.machines).join(', ') || '-';
                            const stages = Array.from(entry.stages).join(', ') || '-';
                            const last = entry.lastTimestamp ? entry.lastTimestamp.toLocaleString() : '-';
                            const row = document.createElement('tr');
                            row.innerHTML = `<td>${entry.sizeName}</td><td>${entry.totalBags.toFixed(2)}</td><td>${stages}</td><td>${machines}</td><td>${last}</td>`;
                            factoryBody.appendChild(row);
                        });
                }

                // Purchase aggregation
                const purchaseAgg = {};
                purchases.forEach(inv => {
                    if (!isDateWithinRange(inv.date, fromDate, toDate)) return;
                    (inv.lines || []).forEach(line => {
                        if (!line.size_id) return;
                        const sizeKey = getInventorySizeKey(line.size_id);
                        if (!purchaseAgg[sizeKey]) {
                            purchaseAgg[sizeKey] = {
                                sizeName: getSizeLabel(sizeKey) || sizeMap[sizeKey]?.size_name || sizeKey,
                                total_kg: 0,
                                total_pkt: 0,
                                total_value: 0,
                                suppliers: new Set()
                            };
                        }
                        if ((line.unit_type || '').toUpperCase() === 'KG') purchaseAgg[sizeKey].total_kg += line.qty || 0;
                        else purchaseAgg[sizeKey].total_pkt += line.qty || 0;
                        purchaseAgg[sizeKey].total_value += line.line_grand_total || 0;
                        if (inv.supplier_id) {
                            const suppName = supplierMap[inv.supplier_id]?.supplier_name || 'Supplier';
                            purchaseAgg[sizeKey].suppliers.add(suppName);
                        }
                    });
                });

                const purchaseBody = document.querySelector('#elaboratePurchaseTable tbody');
                purchaseBody.innerHTML = '';
                const purchaseEntries = Object.values(purchaseAgg);
                if (!purchaseEntries.length) {
                    purchaseBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#6b7280;">No purchase entries for this range</td></tr>';
                } else {
                    purchaseEntries
                        .sort((a, b) => b.total_value - a.total_value)
                        .forEach(entry => {
                            const supplierNames = Array.from(entry.suppliers).join(', ') || '-';
                            const row = document.createElement('tr');
                            row.innerHTML = `<td>${entry.sizeName}</td><td>${entry.total_kg.toFixed(2)}</td><td>${entry.total_pkt.toFixed(2)}</td><td class="currency">${entry.total_value.toFixed(2)}</td><td>${supplierNames}</td>`;
                            purchaseBody.appendChild(row);
                        });
                }

                // Stock snapshot
                const stockBody = document.querySelector('#elaborateStockTable tbody');
                stockBody.innerHTML = '';
                if (!stockLevels.length) {
                    stockBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#6b7280;">No stock data available</td></tr>';
                } else {
                    stockLevels.forEach(stock => {
                        const sizeKey = getInventorySizeKey(stock.size_id || stock.id || '');
                        const sizeName = getSizeLabel(sizeKey) || sizeMap[sizeKey]?.size_name || stock.size_id || 'Unknown Size';
                        const lastUpdated = stock.updated_at ? (parseAnyTimestamp(stock.updated_at)?.toLocaleString() || '-') : '-';
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${sizeName}</td><td>${(stock.raw_wire_qty || 0).toFixed(2)}</td><td>${(stock.finished_goods_qty || 0).toFixed(2)}</td><td>${lastUpdated}</td>`;
                        stockBody.appendChild(row);
                    });
                }

                recordActionLog('Elaborate Report', `Generated elaborate stock flow report`, { fromDate, toDate, productionSizes: factoryEntries.length, purchaseSizes: purchaseEntries.length });
            } catch (error) {
                console.error('Error generating elaborate report:', error);
                alert('Error building elaborate report: ' + error.message);
            }
        }

        async function fetchActivityLogs(limit = 300) {
            if (!isConnected || typeof database === 'undefined') {
                return (appState.activityLogs || []).slice(0, limit);
            }
            const snapshot = await database.ref('activityLogs').orderByChild('timestamp').limitToLast(limit).once('value');
            const logs = [];
            snapshot.forEach(child => {
                logs.push({
                    id: child.key,
                    ...(child.val() || {})
                });
            });
            return logs.sort((a, b) => {
                const aTime = parseAnyTimestamp(a.timestamp)?.getTime() || 0;
                const bTime = parseAnyTimestamp(b.timestamp)?.getTime() || 0;
                return bTime - aTime;
            });
        }

        async function generateActivityLogs(forceReload = false) {
            try {
                if (!activityLogsCache.length || forceReload) {
                    let fetchedLogs = [];
                    try {
                        fetchedLogs = await fetchActivityLogs(400);
                    } catch (err) {
                        console.warn('Unable to fetch logs from server', err);
                    }
                    const localLogs = Array.isArray(appState.activityLogs) ? appState.activityLogs.slice(0, 500) : [];
                    const combined = [...fetchedLogs, ...localLogs];
                    const seen = new Set();
                    activityLogsCache = combined.filter(log => {
                        if (!log || !log.id) return false;
                        if (seen.has(log.id)) return false;
                        seen.add(log.id);
                        return true;
                    }).sort((a, b) => {
                        const aTime = parseAnyTimestamp(a.timestamp)?.getTime() || 0;
                        const bTime = parseAnyTimestamp(b.timestamp)?.getTime() || 0;
                        return bTime - aTime;
                    }).slice(0, 500);
                    appState.activityLogs = activityLogsCache.slice(0, 500);
                }
                const fromDate = document.getElementById('logsFromDate')?.value;
                const toDate = document.getElementById('logsToDate')?.value;
                const searchValue = (document.getElementById('logsSearch')?.value || '').toLowerCase();

                const hideNav = document.getElementById('logsHideNavigation')?.checked;
                const navActions = new Set(['Main Tab Switch', 'Report Tab Switch']);
                const filtered = activityLogsCache.filter((log) => {
                    const inRange = isDateWithinRange(log.timestamp, fromDate, toDate);
                    if (!inRange) return false;
                    if (hideNav && navActions.has(log.action)) return false;
                    if (!searchValue) return true;
                    const haystack = [
                        log.user,
                        log.role,
                        log.action,
                        log.description,
                        JSON.stringify(log.details || {})
                    ].join(' ').toLowerCase();
                    return haystack.includes(searchValue);
                });

                const tbody = document.querySelector('#activityLogsTable tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                if (!filtered.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#6b7280;">No log entries for this selection</td></tr>';
                    return;
                }
                filtered.slice(0, 400).forEach((log, index) => {
                    const ts = parseAnyTimestamp(log.timestamp);
                    const details = log.details ? JSON.stringify(log.details) : '';
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${index + 1}</td><td>${ts ? ts.toLocaleString() : '-'}</td><td>${log.user || '-'}</td><td>${log.role || '-'}</td><td>${log.action || '-'}</td><td>${log.description || ''}${details ? `<br><small style="color:#6b7280;">${details}</small>` : ''}</td>`;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading logs:', error);
                alert('Unable to load logs: ' + error.message);
            }
        }

        // ========== P&L REPORTS WITH UPDATED CALCULATIONS ==========
        async function generatePLReport() {
            try {
                const fromDate = document.getElementById('reportPLFromDate').value;
                const toDate = document.getElementById('reportPLToDate').value;
                const sales = await getReportInvoices('sales');
                const purchases = await getReportInvoices('purchase');

                let totalSales = 0;
                let totalPurchases = 0;

                sales.forEach(inv => {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) return;
                    const totals = computeInvoiceTotalsForReport(inv, 'sales');
                    totalSales += totals.grand;
                });

                purchases.forEach(inv => {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) return;
                    const lines = inv.lines || inv.line_items || [];
                    lines.forEach(line => {
                        if ((line.category || '').trim() === 'P E') return;
                        const lineTotal = typeof line.line_grand_total === 'number'
                            ? line.line_grand_total
                            : (parseFloat(line.qty) || 0) * (parseFloat(line.rate_per_unit || line.rate) || 0) + (parseFloat(line.line_tax_total || line.tax_per_unit || line.tax) || 0);
                        totalPurchases += Number(lineTotal || 0);
                    });
                });

                const net = totalSales - totalPurchases;

                const tbody = document.querySelector('#plTable tbody');
                tbody.innerHTML = `
                    <tr><td>Total Sales (Including All Taxes)</td><td style="text-align: right;" class="currency">${totalSales.toFixed(2)}</td></tr>
                    <tr><td>Total Purchases (Excluding P E Category)</td><td style="text-align: right;" class="currency">${totalPurchases.toFixed(2)}</td></tr>
                `;
                document.getElementById('plNetResult').textContent = `${net.toFixed(2)}`;
            } catch (error) {
                console.error("Error generating P&L report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        async function generatePLTaxReport() {
            try {
                const fromDate = document.getElementById('reportPLTaxFromDate').value;
                const toDate = document.getElementById('reportPLTaxToDate').value;
                const sales = await getReportInvoices('sales');
                const purchases = await getReportInvoices('purchase');

                let totalSales = 0;
                let totalPurchases = 0;

                // Total Sales (excluding all taxes)
                for (const inv of sales) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const totals = computeInvoiceTotalsForReport(inv, 'sales');
                    totalSales += totals.subtotal;
                }

                // Total Purchases (excluding all taxes) excluding P E category
                for (const inv of purchases) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    let invTotal = 0;
                    for (const line of inv.lines) {
                        // Exclude P E category
                        if (line.category !== 'P E') {
                            invTotal += (typeof line.line_total_before_tax === 'number')
                                ? line.line_total_before_tax
                                : ((parseFloat(line.qty) || 0) * (parseFloat(line.rate_per_unit || line.rate) || 0));
                        }
                    }
                    totalPurchases += invTotal;
                }

                const net = totalSales - totalPurchases;

                const tbody = document.querySelector('#plTaxTable tbody');
                tbody.innerHTML = `
                    <tr><td>Total Sales (Excluding All Taxes)</td><td style="text-align: right;" class="currency">${totalSales.toFixed(2)}</td></tr>
                    <tr><td>Total Purchases (Excluding P E Category & Taxes)</td><td style="text-align: right;" class="currency">${totalPurchases.toFixed(2)}</td></tr>
                `;
                document.getElementById('plTaxNetResult').textContent = `${net.toFixed(2)}`;
            } catch (error) {
                console.error("Error generating P&L tax report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        // ========== GST CALCULATION ==========
        async function generateGSTReport() {
            try {
                const fromDate = document.getElementById('reportGSTFromDate').value || document.getElementById('reportPLFromDate').value;
                const toDate = document.getElementById('reportGSTToDate').value || document.getElementById('reportPLToDate').value;
                const sales = await getReportInvoices('sales');
                const purchases = await getReportInvoices('purchase');

                let totalSalesLineTax = 0;
                let totalPurchaseLineTax = 0;

                // Total Sales (only line tax)
                for (const inv of sales) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const totals = computeInvoiceTotalsForReport(inv, 'sales');
                    totalSalesLineTax += Number(totals.lineTax || 0);
                }

                // Total Purchases (only line tax) excluding P E category
                for (const inv of purchases) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const lines = inv.lines || [];
                    lines.forEach(line => {
                        if ((line.category || '').trim() === 'P E') return;
                        const qty = parseFloat(line.qty) || 0;
                        const lineTaxTotal = (typeof line.line_tax_total === 'number')
                            ? line.line_tax_total
                            : qty * (parseFloat(line.tax_per_unit || line.tax) || 0);
                        totalPurchaseLineTax += Number(lineTaxTotal || 0);
                    });
                }

                const netGST = totalSalesLineTax - totalPurchaseLineTax;

                const tbody = document.querySelector('#gstTable tbody');
                tbody.innerHTML = `
                    <tr><td>Total Sales Line Tax</td><td style="text-align: right;" class="currency">${totalSalesLineTax.toFixed(2)}</td></tr>
                    <tr><td>Total Purchase Line Tax (Excluding P E)</td><td style="text-align: right;" class="currency">${totalPurchaseLineTax.toFixed(2)}</td></tr>
                `;
                document.getElementById('gstNetResult').textContent = `${netGST.toFixed(2)}`;
            } catch (error) {
                console.error("Error generating GST report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        // ========== CATEGORY-WISE PURCHASE FILTER ==========
        async function filterPurchaseByCategory() {
            App.invoiceEngine.renderInvoiceTable('purchase');
        }

        /**
         * Override Actual Cost vs Tax P&L to EXCLUDE "P E" purchase lines
         * - Sums sales as before (actual + tax)
         * - For purchases, sums only non-PE lines split into actual (before tax) and tax
         */
        async function generatePLTaxReport() {
            try {
                const fromDate = document.getElementById('reportPLTaxFromDate').value;
                const toDate = document.getElementById('reportPLTaxToDate').value;
                const sales = await fbGetAll('salesInvoices');
                const purchases = await fbGetAll('purchaseInvoices');

                let totalSales = 0, totalSalesTax = 0;
                let totalPurchase = 0, totalPurchaseTax = 0;

                for (const inv of sales) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const lineTax = Number(inv.invoice_line_tax_total || 0);
                    const invTax = Number(inv.invoice_tax || 0);
                    const grand = Number(inv.invoice_grand_total || 0);
                    totalSalesTax += (lineTax + invTax);
                    totalSales += (grand - (lineTax + invTax));
                }

                for (const inv of purchases) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const lines = inv.lines || inv.line_items || [];
                    for (const line of lines) {
                        const cat = (line.category || '').trim();
                        if (cat === 'P E') continue;
                        const before = (typeof line.line_total_before_tax === 'number')
                            ? line.line_total_before_tax
                            : ((parseFloat(line.qty) || 0) * (parseFloat(line.rate) || 0));
                        const ltax = (typeof line.line_tax_total === 'number')
                            ? line.line_tax_total
                            : (parseFloat(line.line_tax || line.tax) || 0);
                        totalPurchase += Number(before || 0);
                        totalPurchaseTax += Number(ltax || 0);
                    }
                }

                const net = (totalSales - totalPurchase);

                const tbody = document.querySelector('#plTaxTable tbody');
                tbody.innerHTML = `
                    <tr><td>Total Sales (Actual Cost)</td><td style="text-align: right;" class="currency">${totalSales.toFixed(2)}</td></tr>
                    <tr><td>Total Sales Taxes</td><td style="text-align: right;" class="currency">${totalSalesTax.toFixed(2)}</td></tr>
                    <tr><td>Total Purchases (Actual Cost, Excl. P E)</td><td style="text-align: right;" class="currency">${totalPurchase.toFixed(2)}</td></tr>
                    <tr><td>Total Purchase Taxes (Excl. P E)</td><td style="text-align: right;" class="currency">${totalPurchaseTax.toFixed(2)}</td></tr>
                `;
                document.getElementById('plTaxNetResult').textContent = `${net.toFixed(2)}`;
            } catch (error) {
                console.error("Error generating P&L tax report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        // ========== MASTERS REPORT ==========
        async function generateMastersReport() {
            try {
                const fromDate = document.getElementById('reportMastersFromDate').value;
                const toDate = document.getElementById('reportMastersToDate').value;

                const sales = await getReportInvoices('sales');
                const purchases = await getReportInvoices('purchase');

                let totalSaleAmount = 0;      // qty * rate - disc (excluding line tax) for sales
                let totalPurchaseAmount = 0;  // qty * rate - disc (excluding line tax) for purchases
                let totalSalesInvoiceTax = 0;
                let totalPurchaseInvoiceTax = 0;
                let totalSalesLineTax = 0;
                let totalPurchaseLineTax = 0;

                // Process sales invoices
                for (const inv of sales) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const totals = computeInvoiceTotalsForReport(inv, 'sales');
                    totalSaleAmount += totals.subtotal;
                    totalSalesLineTax += totals.lineTax;
                    totalSalesInvoiceTax += totals.invoiceTax;
                }

                // Process purchase invoices
                for (const inv of purchases) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const totals = computeInvoiceTotalsForReport(inv, 'purchase');
                    totalPurchaseAmount += totals.subtotal;
                    totalPurchaseLineTax += totals.lineTax;
                    totalPurchaseInvoiceTax += totals.invoiceTax;
                }

                const tbody = document.querySelector('#mastersTable tbody');
                tbody.innerHTML = `
                    <tr><td>Total Sales Amount (Excl. Line Tax)</td><td style="text-align: right;" class="currency">${totalSaleAmount.toFixed(2)}</td></tr>
                    <tr><td>Total Purchase Amount (Excl. Line Tax)</td><td style="text-align: right;" class="currency">${totalPurchaseAmount.toFixed(2)}</td></tr>
                    <tr><td>Total Sales Invoice Tax</td><td style="text-align: right;" class="currency">${totalSalesInvoiceTax.toFixed(2)}</td></tr>
                    <tr><td>Total Purchase Invoice Tax</td><td style="text-align: right;" class="currency">${totalPurchaseInvoiceTax.toFixed(2)}</td></tr>
                    <tr><td>Total Sales Line Tax</td><td style="text-align: right;" class="currency">${totalSalesLineTax.toFixed(2)}</td></tr>
                    <tr><td>Total Purchase Line Tax</td><td style="text-align: right;" class="currency">${totalPurchaseLineTax.toFixed(2)}</td></tr>
                `;
            } catch (error) {
                console.error("Error generating masters report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        // ========== INVENTORY SEARCH ==========
        document.getElementById('inventorySearchInput').addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const table = document.getElementById('inventoryTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                let match = false;

                // Check each cell in the row for the search term
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        match = true;
                        break;
                    }
                }

                // Show or hide the row based on match
                row.style.display = match ? '' : 'none';
            }
        });

        function clearInventorySearch() {
            document.getElementById('inventorySearchInput').value = '';
            const table = document.getElementById('inventoryTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let row of rows) {
                row.style.display = '';
            }
        }

        // Auto-associate labels that are not wired to any form control
        function autoAssociateLabels() {
            const controlsSelector = 'input, select, textarea';
            document.querySelectorAll('label').forEach((label, idx) => {
                if (label.htmlFor) return;
                if (label.querySelector(controlsSelector)) return; // nested control already associates
                const siblingControl = label.parentElement?.querySelector(controlsSelector) || label.nextElementSibling?.matches?.(controlsSelector) && label.nextElementSibling;
                if (siblingControl) {
                    if (!siblingControl.id) siblingControl.id = `auto-field-${idx}`;
                    label.htmlFor = siblingControl.id;
                }
            });
        }

        // ========== SALES & PURCHASE INVOICE SEARCH ==========
        // Apply search filter and highlighting to sales invoices table
        function applySalesSearch() {
            App.invoiceEngine.renderInvoiceTable('sales');
        }

        // Apply search filter and highlighting to purchase invoices table
        function applyPurchaseSearch() {
            App.invoiceEngine.renderInvoiceTable('purchase');
        }


        // Initialize the app when the page loads
        window.addEventListener('load', async function () {
            try {
                App.state.role = typeof getCurrentUserRole === 'function' ? getCurrentUserRole() : 'Admin';
                App.ui.updatePendingBadge();
                const perfStored = localStorage.getItem('factory_perf_mode');
                const perfPref = perfStored === null ? true : perfStored === '1';
                applyPerformanceMode(perfPref);
                if (typeof initApp === 'function') {
                    await initApp();
                }
            } catch (err) {
                console.error('Error initializing core app:', err);
            }

            try {
                await initializeMachines();
            } catch (err) {
                console.error('Error initializing machines module:', err);
            }

            updateQuoteSizeOptions();
            refreshQuotesList();
            renderPendingOrders();

            const quoteDateEl = document.getElementById('quoteDate');
            if (quoteDateEl && !quoteDateEl.value) {
                quoteDateEl.value = getToday();
            }

            autoAssociateLabels();
            bindInvoiceSearchListeners();
            bindDedupePurchaseButton();
        });

        let machineFilter = localStorage.getItem('machineFilter') || 'All';
        let productionFilter = localStorage.getItem('productionFilter') || 'All';
        let activityLogsCache = [];
        let dashboardStageFilter = localStorage.getItem('dashboardStageFilter') || 'All';
        let quoteLines = [];
        let editingQuoteId = null;
        let cachedQuotes = [];
        let cachedCustomers = [];

        function updateSizeOptionsDatalist() {
            const datalist = document.getElementById('sizeOptionsList');
            if (!datalist || !Array.isArray(appState.sizes)) return;
            const options = appState.sizes.map(size => {
                const label = getSizeOptionLabel(size);
                return `<option value="${label}"></option>`;
            }).join('');
            datalist.innerHTML = options;

            const quoteDatalist = document.getElementById('quoteSizeOptions');
            if (quoteDatalist) quoteDatalist.innerHTML = options;
        }

        // ==========================================
        // MACHINE MANAGEMENT LOGIC
        // ==========================================

        function ensureDefaultInventoryStages() {
            if (!window.appState.inventory) window.appState.inventory = {};
            INVENTORY_STAGES.forEach(stage => {
                if (!window.appState.inventory[stage]) {
                    window.appState.inventory[stage] = {};
                }
            });
        }

        function normalizeSizes(sizeList) {
            if (!Array.isArray(sizeList)) return [];
            return sizeList.map((size, idx) => {
                if (!size.id) {
                    const fallback = size.size_name || size.name || size.code || `size-${idx}`;
                    size.id = sanitizeKey(fallback) || `size-${Date.now()}-${idx}`;
                }
                return size;
            });
        }

        function normalizeInventoryKeys() {
            if (!appState || !appState.inventory) return;
            const lookup = {};
            (appState.sizes || []).forEach(size => {
                if (size.id) lookup[size.id] = size;
                if (size.size_name) lookup[size.size_name] = size;
                if (size.name) lookup[size.name] = size;
                if (size.code) lookup[size.code] = size;
            });

            Object.keys(appState.inventory).forEach(stage => {
                const stageInventory = appState.inventory[stage];
                if (!stageInventory) return;
                Object.keys(stageInventory).forEach(key => {
                    const sizeObj = lookup[key];
                    if (sizeObj && sizeObj.id && sizeObj.id !== key) {
                        stageInventory[sizeObj.id] = (stageInventory[sizeObj.id] || 0) + stageInventory[key];
                        delete stageInventory[key];
                    }
                });
            });

            if (appState.packingRemarks && appState.packingRemarks['Finished Goods']) {
                const fgRemarks = appState.packingRemarks['Finished Goods'];
                Object.keys(fgRemarks).forEach(key => {
                    const sizeObj = lookup[key];
                    if (sizeObj && sizeObj.id && sizeObj.id !== key) {
                        if (!fgRemarks[sizeObj.id]) fgRemarks[sizeObj.id] = [];
                        fgRemarks[sizeObj.id] = fgRemarks[sizeObj.id].concat(fgRemarks[key]);
                        delete fgRemarks[key];
                    }
                });
            }
        }

        function getCurrentUserName() {
            if (window.currentEmployee && window.currentEmployee.name) return window.currentEmployee.name;
            if (window.currentUser && (window.currentUser.displayName || window.currentUser.name)) {
                return window.currentUser.displayName || window.currentUser.name;
            }
            if (window.loggedInEmployee && window.loggedInEmployee.name) return window.loggedInEmployee.name;
            try {
                const stored = localStorage.getItem('factoryUserName');
                if (stored) return stored;
            } catch (err) { }
            return 'Admin';
        }

        function getCurrentUserRole() {
            if (window.currentEmployee && window.currentEmployee.role) return window.currentEmployee.role;
            if (window.currentUser && window.currentUser.role) return window.currentUser.role;
            if (window.loggedInEmployee && window.loggedInEmployee.role) return window.loggedInEmployee.role;
            try {
                const stored = localStorage.getItem('factoryUserRole');
                if (stored) return stored;
            } catch (err) { }
            return 'Admin';
        }

        function recordActionLog(actionType, description, details = {}) {
            const entityId = details.entityId || details.invoiceId || details.purchaseId || '';
            return App.db.log({
                action: actionType,
                entityType: details.entityType || '',
                entityId,
                description,
                extra: details,
                userId: details.userId,
                role: details.role
            });
        }

        function parseAnyTimestamp(value) {
            if (!value) return null;
            if (value instanceof Date) return value;
            if (typeof value === 'object') {
                if (typeof value.toDate === 'function') return value.toDate();
                if (typeof value.seconds === 'number') return new Date(value.seconds * 1000);
                if (value.timestamp) return parseAnyTimestamp(value.timestamp);
            }
            const parsed = new Date(value);
            return isNaN(parsed.getTime()) ? null : parsed;
        }

        function isDateWithinRange(value, fromDate, toDate) {
            if (!fromDate && !toDate) return true;
            const date = parseAnyTimestamp(value);
            if (!date) return true;
            if (fromDate) {
                const start = new Date(fromDate + 'T00:00:00');
                if (date < start) return false;
            }
            if (toDate) {
                const end = new Date(toDate + 'T23:59:59');
                if (date > end) return false;
            }
            return true;
        }

        function hasMeaningfulAppState() {
            if (!appState) return false;
            const inventory = appState.inventory || {};
            const hasInventory = Object.values(inventory).some(stage => {
                if (!stage) return false;
                return Object.values(stage).some(val => typeof val === 'number' ? val !== 0 : true);
            });
            const hasTotals = appState.machineDailyTotals && Object.values(appState.machineDailyTotals).some(val => parseFloat(val) > 0);
            const hasHistory = Array.isArray(appState.productionHistory) && appState.productionHistory.length > 0;
            const hasFinishedGoods = appState.finishedGoods && Object.keys(appState.finishedGoods).length > 0;
            return hasInventory || hasTotals || hasHistory || hasFinishedGoods;
        }

        function getCurrentShiftAnchorTimestamp() {
            const now = new Date();
            const anchor = new Date(now);
            anchor.setHours(8, 30, 0, 0);
            if (now < anchor) {
                anchor.setDate(anchor.getDate() - 1);
            }
            return anchor.getTime();
        }

        function ensureDailyTotalsReset() {
            if (!appState.machineDailyTotals) appState.machineDailyTotals = {};
            const currentAnchor = getCurrentShiftAnchorTimestamp();
            const lastReset = parseInt(appState.machineDailyResetAt || 0, 10);
            if (!lastReset) {
                appState.machineDailyResetAt = currentAnchor;
                if (isConnected && hasMeaningfulAppState()) {
                    try { fbPut('appState', 'appState', appState); } catch (e) {
                        console.warn('Unable to persist initial daily reset marker', e);
                    }
                }
                return;
            }
            if (lastReset < currentAnchor) {
                Object.keys(appState.machineDailyTotals).forEach(key => {
                    appState.machineDailyTotals[key] = 0;
                });
                appState.machineDailyResetAt = currentAnchor;
                if (isConnected && hasMeaningfulAppState()) {
                    try { fbPut('appState', 'appState', appState); } catch (e) {
                        console.warn('Unable to persist daily total reset', e);
                    }
                }
            }
        }

        // Ensure appState exists
        if (typeof window.appState === 'undefined') {
            window.appState = {
                machines: [],
                sizes: [],
                customers: [],
                suppliers: [],
                inventory: {},
                productionHistory: [],
                machineDailyTotals: {},
                machineDailyResetAt: null,
                finishedGoods: {},
                packingRemarks: {},
                sizeChangeRequests: [],
                activityLogs: []
            };
        } else {
            if (!window.appState.machines) window.appState.machines = [];
            if (!window.appState.inventory) window.appState.inventory = {};
            if (!window.appState.productionHistory) window.appState.productionHistory = [];
            if (!window.appState.machineDailyTotals) window.appState.machineDailyTotals = {};
            if (typeof window.appState.machineDailyResetAt === 'undefined') window.appState.machineDailyResetAt = null;
            if (!window.appState.finishedGoods) window.appState.finishedGoods = {};
            if (!window.appState.packingRemarks) window.appState.packingRemarks = {};
            if (!window.appState.sizeChangeRequests) window.appState.sizeChangeRequests = [];
            if (!window.appState.activityLogs) window.appState.activityLogs = [];
        }

        async function loadPersistedAppState(cachedState) {
            let remoteLoaded = false;
            if (isConnected) {
                try {
                    const remoteState = await fbGet('appState', 'appState');
                    if (remoteState) {
                        window.appState = {
                            ...window.appState,
                            ...remoteState,
                            inventory: remoteState.inventory || window.appState.inventory || {}
                        };
                        remoteLoaded = true;
                    }
                } catch (err) {
                    console.warn('Failed to load persisted appState:', err);
                }
            }

            if ((!appState.inventory || !Object.keys(appState.inventory).length) && cachedState?.inventory) {
                appState.inventory = cachedState.inventory;
            }

            if ((!appState.machineDailyTotals || !Object.keys(appState.machineDailyTotals).length) && cachedState?.machineDailyTotals) {
                appState.machineDailyTotals = cachedState.machineDailyTotals;
            }

            if ((!appState.productionHistory || !appState.productionHistory.length) && cachedState?.productionHistory) {
                appState.productionHistory = cachedState.productionHistory;
            }

            if (!Array.isArray(appState.sizeChangeRequests)) {
                appState.sizeChangeRequests = [];
            }
            if (typeof appState.machineDailyResetAt === 'undefined') {
                appState.machineDailyResetAt = null;
            }
            ensureDailyTotalsReset();

            normalizeInventoryKeys();
            // migrate legacy finishedGoods bucket into inventory Finished Goods
            if (appState.finishedGoods && Object.keys(appState.finishedGoods).length) {
                if (!appState.inventory['Finished Goods']) appState.inventory['Finished Goods'] = {};
                Object.entries(appState.finishedGoods).forEach(([sizeKey, qty]) => {
                    const safeKey = getInventorySizeKey(sizeKey);
                    appState.inventory['Finished Goods'][safeKey] = (appState.inventory['Finished Goods'][safeKey] || 0) + (parseFloat(qty) || 0);
                });
                try { fbPut('appState', 'appState', appState); } catch (e) {}
            }
            ensureDefaultInventoryStages();
            if (typeof renderInventoryTab === 'function') {
                renderInventoryTab();
            }

            try {
                localStorage.setItem('factoryAppState', JSON.stringify(appState));
            } catch (err) {
                console.warn('Unable to cache app state locally', err);
            }
        }

        // Initialize Machines from Firebase
        async function initializeMachines() {
            let cachedState = null;
            try {
                const saved = localStorage.getItem('factoryAppState');
                if (saved) {
                    cachedState = JSON.parse(saved);
                }
            } catch (err) {
                console.warn('Unable to parse cached factory state:', err);
            }

            await loadPersistedAppState(cachedState);

            try {
                if (!isConnected) {
                    await waitForOnline(4000);
                }
            } catch (err) {
                console.warn('Firebase connection not ready, will attempt to use cached machines if available.', err);
            }

            if (isConnected) {
                try {
                    const sizes = await fbGetAll('sizes');
                    if (Array.isArray(sizes) && sizes.length) {
                        appState.sizes = normalizeSizes(sizes);
                        updateSizeOptionsDatalist();
                        console.log(` Loaded ${sizes.length} sizes into appState`);
                    }
                } catch (err) {
                    console.error('Error loading sizes for machine module:', err);
                    if (!appState.sizes.length && cachedState?.sizes) {
                        appState.sizes = normalizeSizes(cachedState.sizes);
                        updateSizeOptionsDatalist();
                    }
                }
            } else if (cachedState?.sizes) {
                appState.sizes = normalizeSizes(cachedState.sizes);
                updateSizeOptionsDatalist();
            }

            if (isConnected) {
                try {
                    const machines = await fbGetAll('machines');
                    if (machines && machines.length > 0) {
                        appState.machines = machines;
                    } else {
                        const defaults = [
                            { name: 'Header Machines', type: 'Header', count: 20 },
                            { name: 'Rolling Machines', type: 'Rolling', count: 10 },
                            { name: 'Furnace', type: 'Furnace', count: 1 },
                            { name: 'Tampering', type: 'Tampering', count: 1 },
                            { name: 'Plating Machines', type: 'Plating', count: 4 }
                        ];

                        appState.machines = [];
                        for (const group of defaults) {
                            for (let i = 1; i <= group.count; i++) {
                                const machine = {
                                    id: `machine-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                                    machine_type: group.type,
                                    display_name: `${group.type} ${i}`,
                                    status: 'Idle',
                                    current_size: ''
                                };
                                appState.machines.push(machine);
                                await fbPut('machines', machine.id, machine);
                            }
                        }
                    }
                } catch (err) {
                    console.error('Error loading machines:', err);
                    if (cachedState?.machines) {
                        appState.machines = cachedState.machines;
                    }
                }
            } else if (cachedState?.machines) {
                appState.machines = cachedState.machines;
            } else {
                console.warn('Offline: Cannot load machines from Firebase and no cached machine data was found.');
            }

            setMachineFilter(machineFilter);
            setProductionFilter(productionFilter);
            renderMachinesTable();
            updateQuoteSizeOptions();
        }

        const MACHINE_STAGE_MAP = {
            'Header': 'Header',
            'Rolling': 'Rolling',
            'Furnace': 'Furnace',
            'Tampering': 'Tampering',
            'Plating': 'Plating',
            'Other': 'Production'
        };

        // Production flow relationships, used for auto inventory deduction
        const STAGE_ORDER = {
            'Wire Input': { prev: null, next: 'Header' },
            'Header': { prev: 'Wire Input', next: 'Rolling' },
            'Rolling': { prev: 'Header', next: 'Furnace' },
            'Furnace': { prev: 'Rolling', next: 'Tampering' },
            'Tampering': { prev: 'Furnace', next: 'Plating' },
            'Plating': { prev: 'Tampering', next: 'Finished Goods' },
            'Packing': { prev: 'Plating', next: 'Finished Goods' },
            'Production': { prev: 'Rolling', next: 'Finished Goods' },
            'Finished Goods': { prev: 'Plating', next: null }
        };

        const INVENTORY_STAGE_LABELS = {
            'Wire Input': 'Wire Input',
            'Header': 'Header Output',
            'Rolling': 'Rolling Output',
            'Furnace': 'Hardening Output',
            'Tampering': 'Tampering Output',
            'Plating': 'Plating Output',
            'Packing': 'Packing Output',
            'Production': 'Production',
            'Finished Goods': 'Finished Goods',
            'Other': 'Other'
        };

        // Inventory cards should always show these stages, even at zero stock
        const INVENTORY_STAGES = [
            'Wire Input',
            'Header',
            'Rolling',
            'Furnace',
            'Tampering',
            'Plating',
            'Packing',
            'Production',
            'Finished Goods'
        ];

        function normalizeStageKey(stageValue) {
            if (!stageValue) return 'Rolling';
            const stageText = stageValue.toString().trim();
            if (appState && appState.inventory && appState.inventory[stageText]) {
                return stageText;
            }
            const match = Object.entries(INVENTORY_STAGE_LABELS).find(([, label]) => label === stageText);
            if (match) return match[0];
            return stageText;
        }

        function getSizeLabel(sizeId) {
            if (!sizeId) return 'Not set';
            const sizes = Array.isArray(appState.sizes) ? appState.sizes : [];
            const unsanitized = unsanitizeKey(sizeId);
            const match = sizes.find(s => s.id === unsanitized || s.id === sizeId || s.size_name === unsanitized || s.size_name === sizeId || s.name === unsanitized || s.name === sizeId || s.code === unsanitized || s.code === sizeId);
            if (!match) return unsanitized || sizeId;
            return match.size_name || match.name || match.code || unsanitized || sizeId;
        }

        function getSizeOptionLabel(size) {
            if (!size) return 'Size';
            return size.size_name || size.name || size.code || 'Size';
        }

        function findSizeByLabel(label) {
            const sizes = Array.isArray(appState.sizes) ? appState.sizes : [];
            return sizes.find(size => size.size_name === label || size.name === label || size.code === label);
        }

        function getMachineDisplayName(machine) {
            if (!machine) return 'Machine';
            return machine.display_name || machine.name || 'Machine';
        }

        function getMachineSizeId(machine) {
            if (!machine) return '';
            return machine.current_size || machine.currentSize || '';
        }

        function getMachineStage(machine) {
            if (!machine) return 'Production';
            return machine.stage || MACHINE_STAGE_MAP[machine.machine_type] || machine.machine_type || 'Production';
        }

        function renderMachinesTable() {
            // Render Grid in Size Control Tab
            const grid = document.getElementById('size-control-grid');
            if (grid) {
                grid.innerHTML = '';
                const types = ['Header', 'Rolling', 'Furnace', 'Tampering', 'Plating', 'Other'];
                const visibleTypes = machineFilter === 'All' ? types : [machineFilter];

                visibleTypes.forEach(type => {
                    const machines = appState.machines.filter(m => (m.machine_type || 'Other') === type);
                    if (machines.length > 0) {
                        const groupHeader = document.createElement('div');
                        groupHeader.style.gridColumn = '1 / -1';
                        groupHeader.innerHTML = `<h3 style="margin-top:20px;color:#f5f8ff;">${type} Machines (${machines.length})</h3>`;
                        grid.appendChild(groupHeader);

                        machines.forEach(machine => {
                            const sizeLabel = getSizeLabel(machine.current_size);
                            const displayValue = sizeLabel === 'Not set' ? '' : sizeLabel;
                            const card = document.createElement('div');
                            card.className = 'machine-card';
                            card.innerHTML = `
                                <div class="machine-header">
                                    <div class="machine-name">${machine.display_name}</div>
                                    <div class="machine-status-badge ${machine.status ? machine.status.toLowerCase() : 'idle'}">${machine.status || 'Idle'}</div>
                                </div>
                                <div class="size-selector">
                                    <label>Current Size</label>
                                    <input type="text" class="form-control machine-size-input" list="sizeOptionsList"
                                        placeholder="Start typing size..." value="${displayValue}"
                                        onchange="handleMachineSizeInput(this.value, '${machine.id}')">
                                </div>
                                <div class="machine-status">
                                    <label class="status-radio running">
                                        <input type="radio" name="status-${machine.id}" value="Running" ${machine.status === 'Running' ? 'checked' : ''} onchange="updateMachineStatus('${machine.id}', 'Running')"> Running
                                    </label>
                                    <label class="status-radio idle">
                                        <input type="radio" name="status-${machine.id}" value="Idle" ${machine.status === 'Idle' ? 'checked' : ''} onchange="updateMachineStatus('${machine.id}', 'Idle')"> Idle
                                    </label>
                                    <label class="status-radio maintenance">
                                        <input type="radio" name="status-${machine.id}" value="Maintenance" ${machine.status === 'Maintenance' ? 'checked' : ''} onchange="updateMachineStatus('${machine.id}', 'Maintenance')"> Maint.
                                    </label>
                                </div>
                            `;
                            grid.appendChild(card);
                        });
                    }
                });
            }

            // Render Table in Masters Tab
            const tbody = document.querySelector('#machinesTable tbody');
            if (tbody) {
                tbody.innerHTML = '';
                appState.machines.forEach(machine => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="checkbox-column"><input type="checkbox" class="rowCheckbox" data-id="${machine.id}" onchange="toggleMachineSelected('${machine.id}')"></td>
                        <td>${machine.machine_type}</td>
                        <td>${machine.display_name}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn--sm" onclick="editMachine('${machine.id}')">Edit</button>
                                <button class="btn btn--sm btn--outline" onclick="deleteMachine('${machine.id}')" style="background: var(--color-error); color: var(--color-white); border: none;">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            renderProductionEntryTab();
            renderDashboardTab();
        }

        async function updateMachineStatus(id, status) {
            const machine = appState.machines.find(m => m.id === id);
            if (machine) {
                const previousStatus = machine.status || 'Idle';
                machine.status = status;
                await fbPut('machines', id, machine);
                renderMachinesTable(); // Re-render to update UI
                recordActionLog('Machine Status Changed', `${getMachineDisplayName(machine)} status changed from ${previousStatus} to ${status}`, { machineId: id, previousStatus, status });
            }
        }

        function getMachinesByStage(stage) {
            if (!Array.isArray(appState.machines)) return [];
            if (!stage || stage === 'All') return appState.machines.slice();
            return appState.machines.filter(m => (m.machine_type || 'Other') === stage);
        }

        function updateDashboardMachineOptions() {
            const select = document.getElementById('dashboardMachineSelect');
            if (!select) return;
            const machines = getMachinesByStage(dashboardStageFilter);
            const options = ['<option value="">Select Machine</option>'].concat(
                machines.map(machine => `<option value="${machine.id}">${getMachineDisplayName(machine)}</option>`)
            );
            select.innerHTML = options.join('');
        }

        function updateDashboardSizeOptions() {
            const select = document.getElementById('dashboardSizeSelect');
            if (!select) return;
            const sizes = Array.isArray(appState.sizes) ? appState.sizes : [];
            const options = ['<option value="">Select Size</option>'].concat(
                sizes.map(size => `<option value="${size.id}">${getSizeOptionLabel(size)}</option>`)
            );
            select.innerHTML = options.join('');
        }

        function setDashboardStageFilter(value) {
            dashboardStageFilter = value || 'All';
            try { localStorage.setItem('dashboardStageFilter', dashboardStageFilter); } catch (e) {}
            updateDashboardMachineOptions();
            renderDashboardTab();
        }

        function getMachineDailyTotal(machineId) {
            if (!appState.machineDailyTotals) return 0;
            return parseInt(appState.machineDailyTotals[machineId] || 0, 10);
        }

        function renderDashboardTab() {
            const grid = document.getElementById('dashboard-grid');
            if (!grid) return;

            ensureDailyTotalsReset();
            const stageSelect = document.getElementById('dashboardStageFilter');
            if (stageSelect) stageSelect.value = dashboardStageFilter;
            updateDashboardMachineOptions();
            updateDashboardSizeOptions();

            const machines = getMachinesByStage(dashboardStageFilter);
            if (!machines.length) {
                grid.innerHTML = '<div style="grid-column:1/-1; padding:20px; text-align:center; color:var(--text-secondary);">No machines found for this selection.</div>';
                renderSizeChangeRequests();
                return;
            }

            grid.innerHTML = machines.map(machine => {
                const sizeLabel = getSizeLabel(getMachineSizeId(machine));
                const status = (machine.status || 'Idle');
                const stage = getMachineStage(machine);
                const total = getMachineDailyTotal(machine.id);
                return `
                <div class="machine-card">
                    <div class="machine-header">
                        <div class="machine-name">${getMachineDisplayName(machine)}</div>
                        <div class="machine-status-badge ${status.toLowerCase()}">${status}</div>
                    </div>
                    <div style="margin-top:12px;">
                        <div style="font-size:0.85em; color:var(--text-secondary);">Stage</div>
                        <div style="font-weight:600;">${stage}</div>
                    </div>
                    <div style="margin-top:10px;">
                        <div style="font-size:0.85em; color:var(--text-secondary);">Current Size</div>
                        <div style="font-weight:600;">${sizeLabel || 'Not set'}</div>
                    </div>
                    <div style="margin-top:10px;">
                        <div style="font-size:0.85em; color:var(--text-secondary);">Bags since 8:30 AM</div>
                        <div style="font-size:1.4em; font-weight:700; color:var(--color-primary);">${total}</div>
                    </div>
                </div>`;
            }).join('');
            renderSizeChangeRequests();
        }

        function renderSizeChangeRequests() {
            const containers = [
                document.getElementById('dashboard-change-requests'),
                document.getElementById('size-control-change-requests')
            ];
            const requests = Array.isArray(appState.sizeChangeRequests) ? appState.sizeChangeRequests : [];
            containers.forEach(container => {
                if (!container) return;
                if (!requests.length) {
                    container.innerHTML = '<div style="padding:12px; color:var(--text-secondary);">No pending size change requests.</div>';
                    return;
                }
                container.innerHTML = requests.map(req => {
                    const stageLabel = INVENTORY_STAGE_LABELS[req.stage] || req.stage || '';
                    const note = req.note ? `<div style="font-size:0.85em; color:var(--text-secondary); margin-top:4px;">Note: ${req.note}</div>` : '';
                    const time = req.requestedAt ? new Date(req.requestedAt).toLocaleString() : '';
                    return `
                        <div class="inventory-item" style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,0.1);">
                            <div>
                                <div style="font-weight:600;">${req.machineName || 'Machine'}  ${getSizeLabel(req.sizeId)}</div>
                                <div style="font-size:0.85em; color:var(--text-secondary);">${stageLabel}${time ? '  ' + time : ''}</div>
                                ${note}
                            </div>
                            <button class="success" style="padding:6px 12px;" onclick="completeSizeChangeRequest('${req.id}')">Done</button>
                        </div>`;
                }).join('');
            });
        }

        async function submitSizeChangeRequest() {
            const machineSelect = document.getElementById('dashboardMachineSelect');
            const sizeSelect = document.getElementById('dashboardSizeSelect');
            if (!machineSelect || !sizeSelect) return;
            const machineId = machineSelect.value;
            const sizeId = sizeSelect.value;
            if (!machineId) {
                alert('Select a machine first.');
                return;
            }
            if (!sizeId) {
                alert('Select the target size.');
                return;
            }
            const machine = (appState.machines || []).find(m => m.id === machineId);
            if (!machine) {
                alert('Machine not found.');
                return;
            }
            const noteInput = document.getElementById('dashboardChangeNote');
            const note = noteInput ? noteInput.value.trim() : '';
            const request = {
                id: `SCR_${Date.now()}`,
                machineId,
                machineName: getMachineDisplayName(machine),
                stage: getMachineStage(machine) || 'Other',
                sizeId,
                note,
                requestedAt: new Date().toISOString()
            };
            if (!Array.isArray(appState.sizeChangeRequests)) appState.sizeChangeRequests = [];
            appState.sizeChangeRequests.push(request);
            try {
                await fbPut('appState', 'appState', appState);
            } catch (err) {
                console.error('Unable to save size change request', err);
            }
            if (noteInput) noteInput.value = '';
            renderSizeChangeRequests();
            const machineStage = getMachineStage(machine) || 'Production';
            recordActionLog('Size Change Request', `Requested ${getSizeLabel(sizeId)} on ${getMachineDisplayName(machine)} (${INVENTORY_STAGE_LABELS[machineStage] || machineStage})`, {
                machineId,
                sizeId,
                note,
                stage: INVENTORY_STAGE_LABELS[machineStage] || machineStage
            });
            alert('Size change request submitted.');
        }

        async function completeSizeChangeRequest(id) {
            if (!Array.isArray(appState.sizeChangeRequests)) return;
            const request = appState.sizeChangeRequests.find(req => req.id === id);
            appState.sizeChangeRequests = appState.sizeChangeRequests.filter(req => req.id !== id);
            try {
                await fbPut('appState', 'appState', appState);
            } catch (err) {
                console.error('Unable to update requests', err);
            }
            renderSizeChangeRequests();
            renderDashboardTab();
            if (request) {
                const stageLabel = request.stage ? (INVENTORY_STAGE_LABELS[request.stage] || request.stage) : '';
                recordActionLog('Size Change Request Completed', `Completed size change for ${request.machineName} in ${stageLabel}`, {
                    machineId: request.machineId,
                    sizeId: request.sizeId,
                    stage: stageLabel
                });
            }
        }

        async function updateMachineSize(id, sizeId) {
            const machine = appState.machines.find(m => m.id === id);
            if (machine) {
                const previousSizeLabel = getSizeLabel(machine.current_size);
                machine.current_size = sizeId;
                await fbPut('machines', id, machine);
                const newSizeLabel = getSizeLabel(sizeId);
                recordActionLog('Machine Size Changed', `${getMachineDisplayName(machine)} size changed from ${previousSizeLabel || 'Unset'} to ${newSizeLabel || 'Unset'}`, { machineId: id, previousSize: previousSizeLabel, newSize: newSizeLabel });
            }
        }

        function handleMachineSizeInput(value, machineId) {
            const cleaned = (value || '').trim();
            if (!cleaned) {
                updateMachineSize(machineId, '');
                renderMachinesTable();
                return;
            }
            const size = findSizeByLabel(cleaned);
            if (!size) {
                alert(' Please select a valid size from the list.');
                renderMachinesTable();
                return;
            }
            updateMachineSize(machineId, size.id);
            renderMachinesTable();
        }

        function openAddMachineModal() {
            // Create modal if not exists
            let modal = document.getElementById('addMachineModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'addMachineModal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="modal-close" onclick="closeModal('addMachineModal')">&times;</span>
                        <h3>Add New Machine</h3>
                        <form onsubmit="saveMachine(event)">
                            <div class="form-group">
                                <label class="form-label">Machine Type *</label>
                                <select class="form-control" id="machineType" required>
                                    <option value="">Select Type</option>
                                    <option value="Header">Header</option>
                                    <option value="Rolling">Rolling</option>
                                    <option value="Furnace">Furnace</option>
                                    <option value="Tampering">Tampering</option>
                                    <option value="Plating">Plating</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Display Name *</label>
                                <input type="text" class="form-control" id="machineDisplayName" required>
                            </div>
                            <button type="submit" class="btn btn--primary">Save Machine</button>
                        </form>
                    </div>
                    `;
                document.body.appendChild(modal);
            }
            // Use standard display property or class
            modal.style.display = 'flex';
            // Also add active class just in case
            modal.classList.add('active');
        }

        async function saveMachine(event) {
            event.preventDefault();
            const type = document.getElementById('machineType').value;
            const name = document.getElementById('machineDisplayName').value.trim();
            if (!type || !name) return;

            const machine = {
                id: 'machine-' + Date.now(),
                machine_type: type,
                display_name: name,
                status: 'Idle',
                current_size: ''
            };

            appState.machines.push(machine);
            await fbPut('machines', machine.id, machine);

            closeModal('addMachineModal');
            renderMachinesTable();
            recordActionLog('Machine Added', `Added machine ${name} (${type})`, { machineId: machine.id, type });
            alert(` Machine "${name}" added successfully!`);
        }

        function editMachine(machineId) {
            const machine = appState.machines.find(m => m.id === machineId);
            if (!machine) return;

            let modal = document.getElementById('editMachineModal');
            // Remove existing to refresh
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'editMachineModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="modal-close" onclick="closeModal('editMachineModal')">&times;</span>
                    <h3>Edit Machine</h3>
                    <form onsubmit="updateMachine(event, '${machineId}')">
                        <div class="form-group">
                            <label class="form-label">Machine Type *</label>
                            <select class="form-control" id="editMachineType" required>
                                <option value="Header" ${machine.machine_type === 'Header' ? 'selected' : ''}>Header</option>
                                <option value="Rolling" ${machine.machine_type === 'Rolling' ? 'selected' : ''}>Rolling</option>
                                <option value="Furnace" ${machine.machine_type === 'Furnace' ? 'selected' : ''}>Furnace</option>
                                <option value="Tampering" ${machine.machine_type === 'Tampering' ? 'selected' : ''}>Tampering</option>
                                <option value="Plating" ${machine.machine_type === 'Plating' ? 'selected' : ''}>Plating</option>
                                <option value="Other" ${machine.machine_type === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Display Name *</label>
                            <input type="text" class="form-control" id="editMachineDisplayName" value="${machine.display_name}" required>
                        </div>
                        <button type="submit" class="btn btn--primary">Update Machine</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            modal.classList.add('active');
        }

        async function updateMachine(event, machineId) {
            event.preventDefault();
            const type = document.getElementById('editMachineType').value;
            const name = document.getElementById('editMachineDisplayName').value.trim();
            if (!type || !name) return;

            const machine = appState.machines.find(m => m.id === machineId);
            if (machine) {
                const previousName = machine.display_name;
                const previousType = machine.machine_type;
                machine.machine_type = type;
                machine.display_name = name;
                await fbPut('machines', machineId, machine);

                closeModal('editMachineModal');
                renderMachinesTable();
                recordActionLog('Machine Updated', `Updated machine ${previousName} (${previousType})  ${name} (${type})`, { machineId, previousName, previousType, newName: name, newType: type });
                alert(` Machine updated successfully!`);
            }
        }

        async function deleteMachine(machineId) {
            if (!confirm('Are you sure you want to delete this machine? This may affect production tracking.')) return;

            const machine = appState.machines.find(m => m.id === machineId);
            appState.machines = appState.machines.filter(m => m.id !== machineId);
            await fbDelete('machines', machineId);
            renderMachinesTable();
            recordActionLog('Machine Deleted', `Deleted machine ${machine ? getMachineDisplayName(machine) : machineId}`, { machineId, machineName: machine ? getMachineDisplayName(machine) : machineId });
            alert(' Machine deleted successfully!');
        }

        async function forceReinitializeMachines() {
            if (confirm('Are you sure you want to reset all machines to default? This cannot be undone.')) {
                appState.machines = [];
                // Delete all from firebase first
                const machines = await fbGetAll('machines');
                for (const m of machines) {
                    await fbDelete('machines', m.id);
                }
                initializeMachines();
                alert(' Machines reset to default!');
            }
        }

        function toggleMachineSelected(machineId) {
            // Placeholder for bulk selection logic
        }

        function setMachineFilter(type) {
            machineFilter = type;
            try { localStorage.setItem('machineFilter', type); } catch (e) { }
            const select = document.getElementById('machineFilterSelect');
            if (select) select.value = type;
            renderMachinesTable();
            updatePackingSizeOptions();
        }

        // Override switchMastersSubtab to handle machines
        window.switchMastersSubtab = function (id, btn) {
            document.querySelectorAll('#masters .subtab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('#masters .subtab-btn').forEach(el => el.classList.remove('active'));

            const el = document.getElementById(id);
            if (el) el.classList.add('active');
            if (btn) btn.classList.add('active');

            if (id === 'masters-machines') {
                renderMachinesTable();
            }
        };

        // Render Production Entry Tab with Grouped Machines
        function renderProductionEntryTab() {
            const container = document.getElementById('production-entry-grid');
            if (!container) return;
            container.innerHTML = '';
            container.className = ''; // Remove grid class

            const machineGroups = [
                { name: 'Header Machines', type: 'Header' },
                { name: 'Rolling Machines', type: 'Rolling' },
                { name: 'Hardening Furnace', type: 'Furnace' },
                { name: 'Tampering Machine', type: 'Tampering' },
                { name: 'Plating Machines', type: 'Plating' }
            ];

            machineGroups.forEach(group => {
                if (productionFilter !== 'All' && group.type !== productionFilter) return;
                const groupMachines = appState.machines.filter(m => {
                    return (m.machine_type || m.type) === group.type;
                });
                if (groupMachines.length === 0) return;

                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'machine-group-section';
                sectionDiv.style = 'margin-bottom: var(--space-24);';

                sectionDiv.innerHTML = `
                    <div class="machine-group-header" style="display: flex; align-items: center; gap: var(--space-12); margin-bottom: var(--space-16); cursor: pointer;" onclick="toggleProductionGroup('${group.type}')">
                        <span class="group-toggle-icon" id="prod-toggle-${group.type}" style="font-size: var(--font-size-lg); transition: transform var(--duration-normal);"></span>
                        <h3 style="margin: 0; color: var(--color-primary);">${group.name} (${groupMachines.length})</h3>
                    </div>
                    <div class="machine-group-content" id="prod-content-${group.type}" style="display: block;">
                        <div class="machine-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-16);">
                            ${groupMachines.map(machine => `
                                <div class="machine-card">
                                    <div class="machine-header">
                                        <span class="machine-name">${getMachineDisplayName(machine)}</span>
                                        <span class="status ${(machine.status || 'Idle').toLowerCase()}">${machine.status || 'Idle'}</span>
                                    </div>
                                    
                                    <div style="margin-bottom: var(--space-12); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                        Current Size: <strong id="current-size-${machine.id}">${getSizeLabel(getMachineSizeId(machine))}</strong><br>
                                        Today's Total: <strong id="total-${machine.id}" style="color: var(--color-primary); font-size: var(--font-size-lg);">${appState.machineDailyTotals[machine.id] || 0} bags</strong>
                                    </div>
                                    
                                    <div class="production-input">
                                        <div style="flex: 1;">
                                            <label class="form-label">Bags Since Last Reading:</label>
                                            <input type="number" class="form-control" id="${machine.id}-bags" 
                                                   placeholder="Enter bag count" min="0">
                                        </div>
                                        <button class="prod-action-btn" onclick="recordProduction('${machine.id}')">Record</button>
                                        <button class="prod-action-btn secondary" onclick="resetClicker('${machine.id}')">Reset</button>
                                        <button class="prod-action-btn ghost" onclick="addOneBag('${machine.id}')">+1</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                container.appendChild(sectionDiv);
            });
        }

        // Toggle production group visibility
        function toggleProductionGroup(groupType) {
            const content = document.getElementById(`prod-content-${groupType}`);
            const icon = document.getElementById(`prod-toggle-${groupType}`);
            if (!content || !icon) {
                console.warn('toggleProductionGroup: missing DOM nodes for', groupType);
                return;
            }

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '';
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                icon.textContent = '';
                icon.style.transform = 'rotate(-90deg)';
            }
        }

        function setProductionFilter(type) {
            productionFilter = type;
            try { localStorage.setItem('productionFilter', type); } catch (e) { }
            const select = document.getElementById('productionFilterSelect');
            if (select) select.value = type;
            renderProductionEntryTab();
        }

        function recordProduction(machineId) {
            console.log(`Recording production for machine: ${machineId} `);

            const machine = appState.machines.find(m => m.id === machineId);
            if (!machine) {
                alert(` Machine ${machineId} not found`);
                return;
            }

            const bagsInput = document.getElementById(`${machineId}-bags`);
            if (!bagsInput) {
                alert(' Unable to find the bag input for this machine. Please reload the page.');
                return;
            }
            const bags = parseInt(bagsInput.value);

            // Validation
            if (!bags || isNaN(bags) || bags <= 0) {
                alert(' Please enter a valid positive number of bags');
                return;
            }

            const machineName = getMachineDisplayName(machine);
            const sizeId = getMachineSizeId(machine);
            if (!sizeId) {
                alert(` Please set a size for ${machineName} in the Size Control tab first`);
                return;
            }
            const sizeLabel = getSizeLabel(sizeId);

            try {
                console.log(`Before: Machine ${machineId} daily total = ${appState.machineDailyTotals[machineId] || 0} `);

                const stage = getMachineStage(machine);
                const size = sizeId;
                const sizeKey = getInventorySizeKey(size);

                // **NEW FEATURE 1**: Auto-deduct from previous stage
                const prevStage = STAGE_ORDER[stage]?.prev;
                // Only check and deduct from previous stage if it's NOT Wire Input
                // Wire Input is for recording raw material intake only, not for production tracking
                if (prevStage && prevStage !== 'Wire Input') {
                    // Check if previous stage has enough inventory
                    if (!appState.inventory[prevStage]) appState.inventory[prevStage] = {};
                    if (!appState.inventory[prevStage][sizeKey] || appState.inventory[prevStage][sizeKey] < bags) {
                        const available = appState.inventory[prevStage][sizeKey] || 0;
                        alert(` Insufficient inventory in ${prevStage} \nRequired: ${bags} bags of ${sizeLabel} \nAvailable: ${available} bags\n\nPlease ensure previous stage has enough inventory before recording production.`);
                        return;
                    }

                    // Deduct from previous stage
                    appState.inventory[prevStage][sizeKey] -= bags;
                    console.log(`Deducted ${bags} bags of ${sizeLabel} from ${prevStage} `);
                }

                // CRITICAL: Update THIS machine's specific daily total
                if (!appState.machineDailyTotals[machineId]) {
                    appState.machineDailyTotals[machineId] = 0;
                }
                appState.machineDailyTotals[machineId] += bags;

                // Update machine object totals
                machine.dailyProduction = (machine.dailyProduction || 0) + bags;
                machine.clickerCount = (machine.clickerCount || 0) + bags;

                // Add to inventory at appropriate stage
                if (!appState.inventory[stage]) {
                    appState.inventory[stage] = {};
                }
                if (!appState.inventory[stage][sizeKey]) {
                    appState.inventory[stage][sizeKey] = 0;
                }
                appState.inventory[stage][sizeKey] += bags;

                // Record in production history
                appState.productionHistory.push({
                    machineId: machineId,
                    machineName: machineName,
                    size: size,
                    bags: bags,
                    timestamp: new Date(),
                    stage: stage
                });

                // **REAL-TIME DB UPDATE**: Persist production and inventory changes to Firebase
                fbPut('appState', 'appState', appState);

                console.log(`After: Machine ${machineId} daily total = ${appState.machineDailyTotals[machineId]} `);

                // CRITICAL: Update the display immediately for this specific machine
                const totalElement = document.getElementById(`total-${machineId}`);
                if (totalElement) {
                    totalElement.textContent = `${appState.machineDailyTotals[machineId]} bags`;
                    console.log(`Updated display for ${machineId}: ${appState.machineDailyTotals[machineId]} bags`);
                }

                // Clear input
                bagsInput.value = '';

                // Show success message
                const prevStageMsg = prevStage ? `\nDeducted ${bags} bags from ${prevStage} ` : '';
                const stageLabel = INVENTORY_STAGE_LABELS[stage] || stage;
                const prevStageLabel = prevStage ? (INVENTORY_STAGE_LABELS[prevStage] || prevStage) : null;
                recordActionLog('Production Entry', `${machineName} recorded ${bags} bags of ${sizeLabel} into ${stageLabel}${prevStageLabel ? ` (deducted from ${prevStageLabel})` : ''}`, { machineId, size: sizeLabel, bags, stage: stageLabel, prevStage: prevStageLabel });
                alert(` Recorded ${bags} bags of ${sizeLabel} from ${machineName}${prevStageMsg} \nNew total: ${appState.machineDailyTotals[machineId]} bags`);

                // Refresh inventory display if on that tab
                if (document.getElementById('inventory').classList.contains('active')) {
                    renderInventoryTab();
                }
                if (typeof renderDashboardTab === 'function') {
                    renderDashboardTab();
                }

            } catch (error) {
                console.error('Error recording production:', error);
                alert(` Error recording production: ${error.message} `);
            }
        }

        // Add one bag to machine production (quick +1 button)
        function addOneBag(machineId) {
            console.log(`Adding one bag for machine: ${machineId} `);

            const machine = appState.machines.find(m => m.id === machineId);

            if (!machine) {
                alert(` Machine ${machineId} not found`);
                return;
            }

            const machineName = getMachineDisplayName(machine);
            const sizeId = getMachineSizeId(machine);
            if (!sizeId) {
                alert(` Please set a size for ${machineName} in the Size Control tab first`);
                return;
            }
            const sizeLabel = getSizeLabel(sizeId);

            try {
                const bags = 1; // Always exactly 1 bag
                console.log(`Before: Machine ${machineId} daily total = ${appState.machineDailyTotals[machineId] || 0} `);

                const stage = getMachineStage(machine);
                const size = sizeId;
                const sizeKey = getInventorySizeKey(size);

                // **NEW FEATURE 1**: Auto-deduct from previous stage
                const prevStage = STAGE_ORDER[stage]?.prev;
                // Only check and deduct from previous stage if it's NOT Wire Input
                // Wire Input is for recording raw material intake only, not for production tracking
                if (prevStage && prevStage !== 'Wire Input') {
                    // Check if previous stage has enough inventory
                    if (!appState.inventory[prevStage]) appState.inventory[prevStage] = {};
                    if (!appState.inventory[prevStage][sizeKey] || appState.inventory[prevStage][sizeKey] < bags) {
                        const available = appState.inventory[prevStage][sizeKey] || 0;
                        alert(` Insufficient inventory in ${prevStage} \nRequired: ${bags} bags of ${sizeLabel} \nAvailable: ${available} bags\n\nPlease ensure previous stage has enough inventory before recording production.`);
                        return;
                    }

                    // Deduct from previous stage
                    appState.inventory[prevStage][sizeKey] -= bags;
                    console.log(`Deducted ${bags} bags of ${sizeLabel} from ${prevStage} `);
                }

                // CRITICAL: Update THIS machine's specific daily total
                if (!appState.machineDailyTotals[machineId]) {
                    appState.machineDailyTotals[machineId] = 0;
                }
                appState.machineDailyTotals[machineId] += bags;

                // Update machine object totals
                machine.dailyProduction = (machine.dailyProduction || 0) + bags;
                machine.clickerCount = (machine.clickerCount || 0) + bags;

                // Add to inventory at appropriate stage
                if (!appState.inventory[stage]) {
                    appState.inventory[stage] = {};
                }
                if (!appState.inventory[stage][sizeKey]) {
                    appState.inventory[stage][sizeKey] = 0;
                }
                appState.inventory[stage][sizeKey] += bags;

                // Record in production history
                appState.productionHistory.push({
                    machineId: machineId,
                    machineName: machineName,
                    size: size,
                    bags: bags,
                    timestamp: new Date(),
                    stage: stage
                });

                // **REAL-TIME DB UPDATE**: Persist production and inventory changes to Firebase
                fbPut('appState', 'appState', appState);

                console.log(`After: Machine ${machineId} daily total = ${appState.machineDailyTotals[machineId]} `);

                // CRITICAL: Update the display immediately for this specific machine
                const totalElement = document.getElementById(`total-${machineId}`);
                if (totalElement) {
                    totalElement.textContent = `${appState.machineDailyTotals[machineId]} bags`;
                    console.log(`Updated display for ${machineId}: ${appState.machineDailyTotals[machineId]} bags`);
                }

                // Show success message
                const prevStageMsg = prevStage ? `\nDeducted ${bags} bags from ${prevStage} ` : '';
                const stageLabel = INVENTORY_STAGE_LABELS[stage] || stage;
                const prevStageLabel = prevStage ? (INVENTORY_STAGE_LABELS[prevStage] || prevStage) : null;
                recordActionLog('Production Entry', `${machineName} recorded ${bags} bag of ${sizeLabel} into ${stageLabel}${prevStageLabel ? ` (deducted from ${prevStageLabel})` : ''}`, { machineId, size: sizeLabel, bags, stage: stageLabel, prevStage: prevStageLabel });
                alert(` Recorded ${bags} bags of ${sizeLabel} from ${machineName}${prevStageMsg} \nNew total: ${appState.machineDailyTotals[machineId]} bags`);

                // Refresh inventory display if on that tab
                if (document.getElementById('inventory').classList.contains('active')) {
                    renderInventoryTab();
                }
                if (typeof renderDashboardTab === 'function') {
                    renderDashboardTab();
                }

            } catch (error) {
                console.error('Error adding one bag:', error);
                alert(` Error adding bag: ${error.message} `);
            }
        }

        function resetClicker(machineId) {
            if (!confirm('Are you sure you want to reset the daily total? This cannot be undone.')) {
                return;
            }

            const machine = appState.machines.find(m => m.id === machineId);
            if (machine) {
                console.log(`Resetting clicker for ${machineId}`);

                // Reset both the machine's daily production and the separate tracking
                machine.dailyProduction = 0;
                machine.clickerCount = 0;
                appState.machineDailyTotals[machineId] = 0;
                appState.machineDailyResetAt = getCurrentShiftAnchorTimestamp();
                ensureDailyTotalsReset();

                // Persist reset changes to Firebase
                fbPut('appState', 'appState', appState);

                console.log(`Reset complete: ${machineId} daily total = ${appState.machineDailyTotals[machineId]} `);

                // Update the display immediately
                const totalElement = document.getElementById(`total-${machineId}`);
                if (totalElement) {
                    totalElement.textContent = '0 bags';
                    console.log(`Updated display for ${machineId}: 0 bags`);
                }
                if (typeof renderDashboardTab === 'function') {
                    renderDashboardTab();
                }

                recordActionLog('Production Reset', `Reset daily total for ${getMachineDisplayName(machine)}`, { machineId });
                alert(` Daily total reset to 0 for ${getMachineDisplayName(machine)}`);
            } else {
                alert(` Machine ${machineId} not found`);
            }
        }

        // Render Packing Tab
        function renderPackingTab() {
            const container = document.getElementById('packing-grid');
            if (!container) return;

            // Initialize packing remarks if not exists
            if (!appState.packingRemarks) {
                appState.packingRemarks = {};
            }

            // Render Finished Goods List
            renderFinishedGoodsList();

            // Render pending orders from quotes
            renderPendingOrders();

            // Setup size dropdown for packing
            updatePackingSizeOptions();
        }

        function selectPackingSize() { }

        function updatePackingSizeOptions() {
            const stage = document.getElementById('packing-source-stage')?.value || 'Rolling';
            const sizeInput = document.getElementById('packing-size-search');
            const bagsInput = document.getElementById('packing-bags');
            if (!sizeInput) return;
            sizeInput.value = '';
            sizeInput.dataset.selectedSize = '';
            if (bagsInput) bagsInput.value = '';

            const stageInv = (appState.inventory && appState.inventory[stage]) || {};
            const options = Object.keys(stageInv).filter(key => (parseFloat(stageInv[key]) || 0) > 0)
                .map(key => {
                    const label = getSizeLabel(key);
                    return `<option value="${label}"></option>`;
                }).join('');
            const datalist = document.getElementById('packingSizeStageOptions');
            if (datalist) datalist.innerHTML = options;
        }

        function handlePackingSizeInput(value) {
            const stage = document.getElementById('packing-source-stage')?.value || 'Rolling';
            const sizeInput = document.getElementById('packing-size-search');
            const bagsInput = document.getElementById('packing-bags');
            const stageInv = (appState.inventory && appState.inventory[stage]) || {};
            const foundKey = Object.keys(stageInv).find(k => getSizeLabel(k).toLowerCase() === value.toLowerCase());
            if (foundKey) {
                sizeInput.dataset.selectedSize = foundKey;
                if (bagsInput) {
                    const available = parseFloat(stageInv[foundKey]) || 0;
                    bagsInput.max = available || '';
                    if (available > 0) {
                        bagsInput.placeholder = `Max ${available}`;
                    }
                }
            } else {
                sizeInput.dataset.selectedSize = '';
                if (bagsInput) {
                    bagsInput.max = '';
                    bagsInput.placeholder = 'Qty';
                }
            }
        }

        function extractSizeFromInput(inputValue) {
            // Extract size name from "SizeName - Description" format
            if (inputValue && inputValue.includes(' - ')) {
                return inputValue.split(' - ')[0].trim();
            }
            return inputValue ? inputValue.trim() : '';
        }

        function clearPackingForm() {
            const searchInput = document.getElementById('packing-size-search');
            searchInput.value = '';
            searchInput.dataset.selectedSize = '';
            document.getElementById('packing-bags').value = '';
            document.getElementById('packing-remarks').value = '';
            document.getElementById('packing-source-stage').selectedIndex = 0;
        }

        function moveInventoryToFinished(sourceStage, sizeKey, bags, remarks) {
            if (!appState.inventory) appState.inventory = {};
            if (!appState.inventory[sourceStage]) appState.inventory[sourceStage] = {};
            const available = parseFloat(appState.inventory[sourceStage][sizeKey]) || 0;
            if (available < bags) {
                throw new Error(`Not enough ${getSizeLabel(sizeKey)} in ${INVENTORY_STAGE_LABELS[sourceStage] || sourceStage}. Available ${available}, needed ${bags}`);
            }

            appState.inventory[sourceStage][sizeKey] = available - bags;
            if (appState.inventory[sourceStage][sizeKey] <= 0) {
                delete appState.inventory[sourceStage][sizeKey];
            }

            if (!appState.inventory['Finished Goods']) {
                appState.inventory['Finished Goods'] = {};
            }
            if (!appState.inventory['Finished Goods'][sizeKey]) {
                appState.inventory['Finished Goods'][sizeKey] = 0;
            }
            appState.inventory['Finished Goods'][sizeKey] += bags;

            if (!appState.packingRemarks) appState.packingRemarks = {};
            if (!appState.packingRemarks['Finished Goods']) appState.packingRemarks['Finished Goods'] = {};
            if (!appState.packingRemarks['Finished Goods'][sizeKey]) appState.packingRemarks['Finished Goods'][sizeKey] = [];
            appState.packingRemarks['Finished Goods'][sizeKey].push({
                bags,
                remarks: remarks || 'N/A',
                timestamp: new Date().toLocaleString()
            });
        }

        function appendPurchasedInventory(stageKey, sizeKey, bags) {
            if (!appState.inventory) appState.inventory = {};
            if (!appState.inventory[stageKey]) appState.inventory[stageKey] = {};
            const current = parseFloat(appState.inventory[stageKey][sizeKey]) || 0;
            appState.inventory[stageKey][sizeKey] = current + bags;
        }

        function packItems() {
            console.log('Packing items...');

            const searchInput = document.getElementById('packing-size-search');
            const datasetSizeId = searchInput.dataset.selectedSize || '';
            const fallbackLabel = extractSizeFromInput(searchInput.value);
            let sizeRecord = null;

            if (datasetSizeId) {
                sizeRecord = (appState.sizes || []).find(s => s.id === datasetSizeId) || findSizeByLabel(datasetSizeId);
            }
            if (!sizeRecord && fallbackLabel) {
                sizeRecord = findSizeByLabel(fallbackLabel);
            }

            const sourceStage = document.getElementById('packing-source-stage').value;
            const bags = parseInt(document.getElementById('packing-bags').value);
            const remarks = document.getElementById('packing-remarks').value.trim();

            if (!sizeRecord) {
                alert(' Please select a valid size from the list.');
                return;
            }

            const selectedSizeId = sizeRecord.id || fallbackLabel;
            const selectedSizeLabel = getSizeOptionLabel(sizeRecord) || fallbackLabel || selectedSizeId;
            const selectedSizeKey = getInventorySizeKey(selectedSizeId);
            searchInput.dataset.selectedSize = selectedSizeId;

            console.log('Packing data:', { selectedSizeId, sourceStage, bags });

            // Validate inputs
            if (!sourceStage) {
                alert(' Please select a source stage.');
                return;
            }

            if (!bags || isNaN(bags) || bags <= 0) {
                alert(' Please enter a valid number of bags (positive integer).');
                return;
            }

            // Check if source stage has sufficient inventory
            if (!appState.inventory[sourceStage]) {
                appState.inventory[sourceStage] = {};
            }
            const availableBags = (appState.inventory[sourceStage][selectedSizeKey]) || 0;
            console.log(`Available in ${sourceStage}: ${availableBags} bags of ${selectedSizeLabel} `);

            if (availableBags < bags) {
                alert(` Not enough ${selectedSizeLabel} in ${sourceStage}.Available: ${availableBags} bags, Requested: ${bags} bags`);
                return;
            }

            try {
                moveInventoryToFinished(sourceStage, selectedSizeKey, bags, remarks);

                // Persist inventory transfer to Firebase
                fbPut('appState', 'appState', appState);

                console.log('Inventory updated successfully');

                // Clear form
                clearPackingForm();

                // Refresh displays immediately
                renderFinishedGoodsList();
                if (document.getElementById('inventory').classList.contains('active')) {
                    renderInventoryTab();
                }

                // Show success message
                const stageLabel = INVENTORY_STAGE_LABELS[sourceStage] || sourceStage;
                recordActionLog('Packing Transfer', `Packed ${bags} bags of ${selectedSizeLabel} from ${stageLabel} to Finished Goods`, {
                    sourceStage,
                    sourceStageLabel: stageLabel,
                    size: selectedSizeLabel,
                    bags,
                    remarks
                });
                alert(` Successfully packed ${bags} bags of ${selectedSizeLabel} to Finished Goods`);

            } catch (error) {
                console.error('Packing error:', error);
                alert(` Error during packing: ${error.message} `);
            }
        }

        function renderFinishedGoodsList() {
            const container = document.getElementById('finished-goods-list');
            if (!container) return;

            if (!appState.inventory) appState.inventory = {};
            if (!appState.inventory['Finished Goods']) appState.inventory['Finished Goods'] = {};

            // Fallback migration from legacy finishedGoods bucket if inventory FG looks empty
            if (appState.finishedGoods && Object.keys(appState.finishedGoods).length && Object.keys(appState.inventory['Finished Goods']).length === 0) {
                Object.entries(appState.finishedGoods).forEach(([sizeKey, qty]) => {
                    const safeKey = getInventorySizeKey(sizeKey);
                    appState.inventory['Finished Goods'][safeKey] = (appState.inventory['Finished Goods'][safeKey] || 0) + (parseFloat(qty) || 0);
                });
                // save silently
                try { fbPut('appState', 'appState', appState); } catch (e) { console.warn('FG migrate save failed', e); }
            }

            const finishedGoods = appState.inventory['Finished Goods'] || {};
            const totalSpan = document.getElementById('total-finished-goods');

            const items = Object.entries(finishedGoods)
                .filter(([_, bags]) => (parseFloat(bags) || 0) > 0)
                .sort(([a], [b]) => a.localeCompare(b));

            if (items.length === 0) {
                container.innerHTML = '<div style="color: var(--color-text-secondary); font-style: italic; text-align: center; padding: var(--space-16);">No finished goods inventory</div>';
            } else {
                container.innerHTML = items.map(([size, bags]) => {
                    const label = getSizeLabel(size);
                    const remarks = (appState.packingRemarks && appState.packingRemarks['Finished Goods'] && appState.packingRemarks['Finished Goods'][size]) || [];
                    const latestRemark = remarks.length > 0 ? remarks[remarks.length - 1].remarks : 'No remarks recorded'; // Default if no remarks
                    return `
                    <div class="inventory-item" style="display: flex; justify-content: space-between; align-items: flex-start; gap: var(--space-12); padding: 8px 0; border-bottom: 1px dashed var(--color-border-light);">
                        <div style="flex: 1;">
                            <span class="inventory-size" style="font-weight: 600; color: var(--text-primary);">${label}</span><br>
                            <span style="font-size: 0.85em; color: var(--text-secondary);">Remarks: ${latestRemark}</span>
                        </div>
                        <span class="inventory-bags" style="font-weight: 700; color: var(--color-primary);">${bags} bags</span>
                    </div>
                    `;
                }).join('');
            }

            if (totalSpan) {
                const totalBags = Object.values(finishedGoods).reduce((sum, bags) => sum + (parseFloat(bags) || 0), 0);
                totalSpan.textContent = totalBags;
            }
        }

        function renderPendingOrders() {
            const container = document.getElementById('pending-orders-list');
            if (!container) return;
            container.innerHTML = '<div style="color: #999;">Loading pending orders...</div>';

            const buildTable = (quotes, customers) => {
                const customerMap = {};
                (customers || []).forEach(c => customerMap[c.id] = c.display_name || c.name || c.id);
                const rows = [];

                quotes.forEach(q => {
                    const pendingLines = (q.lines || []).map((line, idx) => ({ line, idx })).filter(item => item.line && item.line.status !== 'done');
                    if (!pendingLines.length) return;
                    const span = pendingLines.length;
                    pendingLines.forEach(({ line, idx: originalIdx }, idx) => {
                        const { qtyDisplay, bagsDisplay } = getQuoteLineDisplays(line);
                        const stageLabel = INVENTORY_STAGE_LABELS[line.stage] || line.stage || '';
                        const priorityVal = line.priority || '';
                        const remarkVal = line.remarks || '';
                        const priorityDisplay = priorityVal
                            ? `<span style="display:inline-flex; min-width:32px; justify-content:center; padding:2px 6px; border-radius:999px; background:rgba(212,175,55,0.15); color:var(--text-primary); font-weight:600;">${priorityVal}</span>`
                            : `<span style="color:#888; font-size:0.85em;">-</span>`;
                        const actionCell = idx === 0 ? `<td rowspan="${span}" style="vertical-align: middle;"><button class="success" style="padding:6px 12px;" onclick="markQuoteDone('${q.id}')">Done</button></td>` : '';
                        rows.push(`
                            <tr>
                                <td>${customerMap[q.customer_id] || q.customer_id || 'Customer'}</td>
                                <td>${stageLabel}</td>
                                <td>${getSizeLabel(line.sizeId)}</td>
                                <td>${qtyDisplay || ''}</td>
                                <td>${bagsDisplay || ''}</td>
                                <td>
                                    <input type="text" id="pending-remark-${q.id}-${originalIdx}" value="${remarkVal}" placeholder="Remarks" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;">
                                </td>
                                <td style="width:60px; text-align:center;">${priorityDisplay}</td>
                                ${actionCell}
                            </tr>
                        `);
                    });
                });

                if (!rows.length) {
                    container.innerHTML = '<div style="color: #555; font-style: italic;">No pending orders</div>';
                    return;
                }

                container.innerHTML = `
                    <table class="line-items-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Stage</th>
                                <th>Item</th>
                                <th>Total Qty</th>
                                <th>Bags Used</th>
                                <th>Remarks</th>
                                <th style="width:60px;">Priority</th>
                                <th>Done</th>
                            </tr>
                        </thead>
                        <tbody>${rows.join('')}</tbody>
                    </table>
                `;
            };

            // render immediately from cache if present
            if (cachedQuotes.length) {
                buildTable(cachedQuotes, cachedCustomers);
            }

            Promise.all([fbGetAll('quotes'), fbGetAll('customers')]).then(([quotes, customers]) => {
                cachedQuotes = quotes;
                cachedCustomers = customers;
                buildTable(quotes, customers);
            }).catch(() => {
                if (cachedQuotes.length) {
                    buildTable(cachedQuotes, cachedCustomers);
                } else {
                    container.innerHTML = '<div style="color: #f99;">Error loading pending orders</div>';
                }
            });
        }

        // ===== QUOTES =====
        function getQuoteLineDisplays(line) {
            const unit = line.unit || '';
            const qty = parseFloat(line.qty) || 0;
            const factor = parseFloat(line.factor) || 0;
            let bagsUsed = line.totalUsedBags;
            if (!bagsUsed && unit === 'Bags' && qty) {
                bagsUsed = qty;
            } else if (!bagsUsed && unit && qty && factor && unit !== 'Bags') {
                bagsUsed = Math.ceil(qty / factor);
            }
            let qtyDisplay = line.totalQtyDisplay;
            if (!qtyDisplay) {
                if (unit === 'Bags') {
                    qtyDisplay = `${qty} bag${qty === 1 ? '' : 's'}`;
                } else {
                    qtyDisplay = `${qty} ${unit}`.trim();
                    if (factor) {
                        qtyDisplay += ` (${factor} per bag)`;
                    }
                }
            }
            let bagsDisplay = '';
            if (bagsUsed) {
                if (unit === 'KG' && factor) {
                    bagsDisplay = `${bagsUsed} bag(s)  ${factor} kg each`;
                } else if (unit === 'PKT' && factor) {
                    bagsDisplay = `${bagsUsed} bag(s)  ${factor} pkt each`;
                } else {
                    bagsDisplay = `${bagsUsed} bag(s)`;
                }
            }
            return { qtyDisplay, bagsDisplay };
        }

        function getStageInventory(stage) {
            return (appState.inventory && appState.inventory[stage]) || {};
        }

        function updateQuoteSizeOptions() {
            const stage = document.getElementById('quoteStage')?.value || 'Rolling';
            const stageInv = getStageInventory(stage);
            const datalist = document.getElementById('quoteSizeOptions');
            if (!datalist) return;
            const options = Object.keys(stageInv)
                .filter(key => (parseFloat(stageInv[key]) || 0) > 0)
                .map(key => `<option value="${getSizeLabel(key)}"></option>`)
                .join('');
            datalist.innerHTML = options;

            // reset selected size/qty hints
            const sizeInput = document.getElementById('quoteSize');
            const qtyInput = document.getElementById('quoteQty');
            if (sizeInput) {
                sizeInput.value = '';
                sizeInput.dataset.selectedSize = '';
            }
            if (qtyInput) {
                qtyInput.value = '';
                qtyInput.max = '';
                qtyInput.placeholder = 'Qty';
            }
        }

        function handleQuoteSizeInput(val) {
            const stage = document.getElementById('quoteStage')?.value || 'Rolling';
            const sizeInput = document.getElementById('quoteSize');
            const qtyInput = document.getElementById('quoteQty');
            const factorInput = document.getElementById('quoteBagFactor');
            const stageInv = getStageInventory(stage);
            const foundKey = Object.keys(stageInv).find(k => getSizeLabel(k).toLowerCase() === (val || '').toLowerCase());
            if (foundKey) {
                sizeInput.dataset.selectedSize = foundKey;
                const available = parseFloat(stageInv[foundKey]) || 0;
                if (qtyInput) {
                    qtyInput.max = available || '';
                    qtyInput.placeholder = available ? `Max ${available}` : 'Qty';
                }
                if (factorInput) {
                    factorInput.value = '';
                }
            } else {
                sizeInput.dataset.selectedSize = '';
                if (qtyInput) {
                    qtyInput.max = '';
                    qtyInput.placeholder = 'Qty';
                }
                if (factorInput) factorInput.value = '';
            }
        }

        function renderQuoteLines() {
            const tbody = document.getElementById('quoteLineItems');
            if (!tbody) return;
            tbody.innerHTML = '';
            quoteLines.forEach((line, idx) => {
                const { qtyDisplay, bagsDisplay } = getQuoteLineDisplays(line);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${getSizeLabel(line.sizeId)}</td>
                    <td>${line.unit}${line.factor ? ` (${line.factor} per bag)` : ''}</td>
                    <td>${line.qty}</td>
                    <td>${INVENTORY_STAGE_LABELS[line.stage] || line.stage}</td>
                    <td>${bagsDisplay || ''}</td>
                    <td>${qtyDisplay || ''}</td>
                    <td><button type="button" class="danger" onclick="removeQuoteLine(${idx})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function removeQuoteLine(idx) {
            quoteLines.splice(idx, 1);
            renderQuoteLines();
        }

        function addQuoteLine() {
            const stage = document.getElementById('quoteStage')?.value || '';
            const sizeInput = document.getElementById('quoteSize');
            const unit = document.getElementById('quoteUnit')?.value || 'Bags';
            const qty = parseFloat(document.getElementById('quoteQty')?.value || '0');
            const factor = parseFloat(document.getElementById('quoteBagFactor')?.value || '0');

            if (!stage) {
                alert('Select a stage.');
                return;
            }
            const sizeLabel = (sizeInput?.value || '').trim();
            if (!sizeLabel) {
                alert('Select a size from the list.');
                return;
            }
            const stageInv = getStageInventory(stage);
            const sizeKey = sizeInput.dataset.selectedSize || Object.keys(stageInv).find(k => getSizeLabel(k).toLowerCase() === sizeLabel.toLowerCase());
            if (!sizeKey) {
                alert('Please choose a size that exists in this stage inventory.');
                return;
            }
            const availableBags = parseFloat(stageInv[sizeKey]) || 0;

            // compute allowed qty based on unit/factor
            let maxQty = availableBags;
            if ((unit === 'PKT' || unit === 'KG')) {
                if (!factor || factor <= 0) {
                    alert('Enter packets per bag or kg per bag.');
                    return;
                }
                maxQty = availableBags * factor;
            }

            if (!qty || qty <= 0) {
                alert('Enter a valid quantity.');
                return;
            }
            if (qty > maxQty) {
                alert(`Only ${maxQty} ${unit} available in ${INVENTORY_STAGE_LABELS[stage] || stage}.`);
                return;
            }

            const totalUsedBags = unit === 'Bags' ? qty : Math.ceil(qty / (factor || 1));
            const totalQtyDisplay = `${qty} ${unit}${unit !== 'Bags' && factor ? ` (${factor} per bag)` : ''}`;

            quoteLines.push({
                stage,
                sizeId: sizeKey,
                unit,
                qty,
                factor: factor || null,
                availableBags,
                totalUsedBags,
                totalQtyDisplay
            });
            renderQuoteLines();
            renderPendingOrders();
        }

        async function saveQuote() {
            const date = document.getElementById('quoteDate')?.value || getToday();
            const custId = document.getElementById('quoteCustomerId')?.value;
            if (!custId) { alert('Select a customer.'); return; }
            if (!quoteLines.length) { alert('Add at least one line.'); return; }
            const id = editingQuoteId || ('Q_' + Date.now());
            const record = {
                id,
                date,
                customer_id: custId,
                lines: quoteLines.map(l => ({ ...l }))
            };
            await fbPut('quotes', id, record);
            alert(editingQuoteId ? ' Quote updated' : ' Quote saved');
            // update local cache instantly
            cachedQuotes = cachedQuotes.filter(q => q.id !== id).concat([record]);
            localStorage.setItem('quotesCache', JSON.stringify(cachedQuotes));
            renderQuotesTable(cachedQuotes, cachedCustomers.length ? cachedCustomers : (appState.customers || []));
            renderPendingOrders();
            recordActionLog('Quote Saved', `${editingQuoteId ? 'Updated' : 'Created'} quote ${id}`, {
                quoteId: id,
                customerId: custId,
                lines: quoteLines.length
            });
            clearQuoteForm();
            refreshQuotesList(); // async refresh to pull latest
        }

        function clearQuoteForm() {
            const dateEl = document.getElementById('quoteDate');
            if (dateEl) dateEl.value = getToday();
            const custEl = document.getElementById('quoteCustomer');
            if (custEl) custEl.value = '';
            const custIdEl = document.getElementById('quoteCustomerId');
            if (custIdEl) custIdEl.value = '';
            const sizeEl = document.getElementById('quoteSize');
            if (sizeEl) { sizeEl.value = ''; sizeEl.dataset.selectedSize = ''; }
            const qtyEl = document.getElementById('quoteQty');
            if (qtyEl) { qtyEl.value = ''; qtyEl.max = ''; qtyEl.placeholder = 'Qty'; }
            quoteLines = [];
            editingQuoteId = null;
            renderQuoteLines();
        }

        function renderQuotesTable(quotes = [], customers = []) {
            const tbody = document.querySelector('#quotesTable tbody');
            if (!tbody) return;
            const customerMap = {};
            customers.forEach(c => customerMap[c.id] = c.display_name || c.name || c.id);
            tbody.innerHTML = '';

            quotes.forEach(q => {
                const lines = (q.lines && q.lines.length) ? q.lines : [{}];
                const rowSpan = lines.length || 1;

                lines.forEach((line, idx) => {
                    const { qtyDisplay, bagsDisplay } = getQuoteLineDisplays(line);
                    const stageLabel = INVENTORY_STAGE_LABELS[line.stage] || line.stage || '';
                    const priorityVal = line.priority || '';
                    const actionCell = idx === 0 ? `
                        <td rowspan="${rowSpan}" style="vertical-align: middle;">
                            <button type="button" onclick="viewQuote('${q.id}')">View</button>
                            <button type="button" onclick="editQuote('${q.id}')">Edit</button>
                            <button type="button" class="danger" onclick="deleteQuote('${q.id}')">Delete</button>
                        </td>` : '';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${q.date || ''}</td>
                        <td>${customerMap[q.customer_id] || q.customer_id || ''}</td>
                        <td>${stageLabel}</td>
                        <td>${getSizeLabel(line.sizeId)}</td>
                        <td>${line.qty || ''}</td>
                        <td>${qtyDisplay || ''}</td>
                        <td>${bagsDisplay || ''}</td>
                        <td><input type="number" min="1" style="width:60px;" value="${priorityVal}" onchange="updateQuotePriority('${q.id}', ${idx}, this.value)"></td>
                        <td>${line.status === 'done' ? ' Done' : 'Pending'}</td>
                        <td>${line.remarks || ''}</td>
                        ${actionCell}
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        async function refreshQuotesList() {
            // First render quickly from cache if present
            if (cachedQuotes.length) {
                renderQuotesTable(cachedQuotes, cachedCustomers.length ? cachedCustomers : (appState.customers || []));
            }

            let quotes = [];
            let customers = [];
            if (!isConnected) {
                try {
                    const qCache = localStorage.getItem('quotesCache');
                    const cCache = localStorage.getItem('customersCache');
                    if (qCache) quotes = JSON.parse(qCache);
                    if (cCache) customers = JSON.parse(cCache);
                } catch (err) {
                    console.warn('Offline and no cached quotes/customers available', err);
                }
            } else {
                try {
                    quotes = await fbGetAll('quotes');
                    customers = await fbGetAll('customers');
                    cachedQuotes = quotes;
                    cachedCustomers = customers;
                    localStorage.setItem('quotesCache', JSON.stringify(quotes));
                    localStorage.setItem('customersCache', JSON.stringify(customers));
                } catch (e) {
                    console.error('Error loading quotes', e);
                    try {
                        const qCache = localStorage.getItem('quotesCache');
                        const cCache = localStorage.getItem('customersCache');
                        if (qCache) quotes = JSON.parse(qCache);
                        if (cCache) customers = JSON.parse(cCache);
                    } catch (err) {
                        console.warn('No cached quotes/customers available', err);
                    }
                }
            }

            renderQuotesTable(quotes, customers);
            renderPendingOrders();
        }

        async function viewQuote(id) {
            const modal = document.getElementById('viewQuoteModal');
            const content = document.getElementById('quoteContent');
            if (!modal || !content) return;
            const record = await fbGet('quotes', id);
            if (!record) return;
            let customers = cachedCustomers;
            try { customers = await fbGetAll('customers'); } catch (e) { /* fallback to cached */ }
            const cust = (customers || []).find(c => c.id === record.customer_id);
            const linesHtml = (record.lines || []).map((line, idx) => {
                const { qtyDisplay, bagsDisplay } = getQuoteLineDisplays(line);
                return `<li>#${idx + 1} ${getSizeLabel(line.sizeId)}  ${qtyDisplay || ''}  ${INVENTORY_STAGE_LABELS[line.stage] || line.stage}  ${bagsDisplay || ''} ${line.status === 'done' ? '' : ''} ${line.remarks ? '  ' + line.remarks : ''}</li>`;
            }).join('');
            content.innerHTML = `
                <p><strong>Date:</strong> ${record.date || ''}</p>
                <p><strong>Customer:</strong> ${cust ? cust.display_name : record.customer_id}</p>
                <ul>${linesHtml}</ul>
            `;
            openModal('viewQuoteModal');
        }

        async function editQuote(id) {
            try {
                const record = await fbGet('quotes', id);
                if (!record) return;
                editingQuoteId = id;
                quoteLines = (record.lines || []).map(l => ({ ...l }));
                const dateEl = document.getElementById('quoteDate');
                if (dateEl) dateEl.value = record.date || getToday();

                // populate customer
                const customers = cachedCustomers.length ? cachedCustomers : appState.customers || [];
                const cust = customers.find(c => c.id === record.customer_id);
                const custInput = document.getElementById('quoteCustomer');
                const custIdInput = document.getElementById('quoteCustomerId');
                if (custInput) custInput.value = cust ? (cust.display_name || cust.name || '') : record.customer_id;
                if (custIdInput) custIdInput.value = record.customer_id || '';

                // set stage dropdown to first line for convenience
                const stageSelect = document.getElementById('quoteStage');
                if (stageSelect && record.lines && record.lines[0] && record.lines[0].stage) {
                    stageSelect.value = record.lines[0].stage;
                }

                renderQuoteLines();

                const createTabBtn = document.querySelector('button.subtab-btn[onclick*=\"sales-quote-create\"]');
                if (createTabBtn && typeof switchSalesSubtab === 'function') {
                    switchSalesSubtab('sales-quote-create', createTabBtn);
                }
            } catch (err) {
                console.error('Error editing quote', err);
            }
        }

        async function deleteQuote(id) {
            if (!confirm('Delete this quote?')) return;
            try {
                await fbDelete('quotes', id);
                cachedQuotes = cachedQuotes.filter(q => q.id !== id);
                localStorage.setItem('quotesCache', JSON.stringify(cachedQuotes));
                renderQuotesTable(cachedQuotes, cachedCustomers);
                renderPendingOrders();
                refreshQuotesList();
                recordActionLog('Quote Deleted', `Deleted quote ${id}`, { quoteId: id });
            } catch (err) {
                console.error('Error deleting quote', err);
                alert('Unable to delete quote right now.');
            }
        }

        async function updateQuotePriority(id, idx, value) {
            const record = await fbGet('quotes', id);
            if (!record || !record.lines || !record.lines[idx]) return;
            const cleanVal = value === '' ? '' : (parseInt(value, 10) || value);
            record.lines[idx].priority = cleanVal;
            await fbPut('quotes', id, record);
            refreshQuotesList();
            renderPendingOrders();
        }

        async function markQuoteDone(id) {
            const record = await fbGet('quotes', id);
            if (!record || !Array.isArray(record.lines)) return;

            try {
                const pendingLineRefs = record.lines
                    .map((line, idx) => ({ line, idx }))
                    .filter(item => item.line && item.line.status !== 'done');

                if (!pendingLineRefs.length) {
                    alert('This quote is already completed.');
                    renderPendingOrders();
                    return;
                }

                // Validate availability first (aggregate each stage/size)
                const requirements = {};
                pendingLineRefs.forEach(({ line }) => {
                    const stageKey = normalizeStageKey(line.stage || 'Rolling');
                    const sizeKey = getInventorySizeKey(line.sizeId || '');
                    const qty = parseFloat(line.qty) || 0;
                    const factor = parseFloat(line.factor) || 0;
                    let bagsNeeded = 0;
                    if (line.unit === 'Bags' || !line.unit) {
                        bagsNeeded = qty;
                    } else {
                        bagsNeeded = Math.ceil(qty / (factor || 1));
                    }
                    if (!bagsNeeded || bagsNeeded <= 0) {
                        throw new Error(`Invalid quantity for ${getSizeLabel(sizeKey)}`);
                    }
                    if (!requirements[stageKey]) requirements[stageKey] = {};
                    requirements[stageKey][sizeKey] = (requirements[stageKey][sizeKey] || 0) + bagsNeeded;
                });

                Object.entries(requirements).forEach(([stageKey, sizes]) => {
                    const stageInventory = (appState.inventory && appState.inventory[stageKey]) || {};
                    Object.entries(sizes).forEach(([sizeKey, needed]) => {
                        const available = parseFloat(stageInventory[sizeKey]) || 0;
                        if (available < needed) {
                            const stageLabel = INVENTORY_STAGE_LABELS[stageKey] || stageKey;
                            throw new Error(`Not enough ${getSizeLabel(sizeKey)} in ${stageLabel}. Available ${available}, needed ${needed}`);
                        }
                    });
                });

                pendingLineRefs.forEach(({ line, idx }) => {
                    const remarkInput = document.getElementById(`pending-remark-${id}-${idx}`);
                    const remarkVal = remarkInput ? remarkInput.value.trim() : line.remarks || '';
                    const stageKey = normalizeStageKey(line.stage || 'Rolling');
                    const sizeKey = getInventorySizeKey(line.sizeId || '');
                    const qty = parseFloat(line.qty) || 0;
                    const factor = parseFloat(line.factor) || 0;
                    const bagsNeeded = (line.unit === 'Bags' || !line.unit)
                        ? qty
                        : Math.ceil(qty / (factor || 1));

                    moveInventoryToFinished(stageKey, sizeKey, bagsNeeded, remarkVal);

                    record.lines[idx] = {
                        ...line,
                        totalUsedBags: bagsNeeded,
                        status: 'done',
                        remarks: remarkVal
                    };
                });

                // Persist both quotes and appState inventory updates
                await fbPut('quotes', id, record);
                await fbPut('appState', 'appState', appState);
                // update caches instantly
                cachedQuotes = cachedQuotes.map(q => q.id === id ? record : q);
                localStorage.setItem('quotesCache', JSON.stringify(cachedQuotes));
                renderQuotesTable(cachedQuotes, cachedCustomers);
                renderPendingOrders();
                renderFinishedGoodsList();
                if (document.getElementById('inventory').classList.contains('active')) {
                    renderInventoryTab();
                }
                refreshQuotesList(); // async refresh from server
                recordActionLog('Quote Fulfilled', `Completed quote ${id} (${pendingLineRefs.length} lines)`, {
                    quoteId: id,
                    linesCompleted: pendingLineRefs.length,
                    lineDetails: pendingLineRefs.map(({ line }) => ({
                        size: getSizeLabel(line.sizeId),
                        stage: INVENTORY_STAGE_LABELS[line.stage] || line.stage,
                        qty: line.qty,
                        unit: line.unit
                    }))
                });
                alert(' Quote packed and moved to Finished Goods.');
            } catch (err) {
                console.error('Error completing quote', err);
                alert(` ${err.message}`);
            }
        }

        function filterQuotes(term) {
            const searchValue = (term || '').toLowerCase().trim();
            const rows = document.querySelectorAll('#quotesTable tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = searchValue && !text.includes(searchValue) ? 'none' : '';
            });
        }

        function filterQuotes(term) {
            const searchValue = (term || '').toLowerCase().trim();
            const rows = document.querySelectorAll('#quotesTable tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = searchValue && !text.includes(searchValue) ? 'none' : '';
            });
        }

        // Render Inventory Tab
        function renderInventoryTab() {
            const container = document.getElementById('inventory-grid');
            if (!container) return;
            container.innerHTML = '';

            if (!appState.inventory) appState.inventory = {};
            ensureDefaultInventoryStages();

            INVENTORY_STAGES.forEach(stage => {
                if (!appState.inventory[stage]) {
                    appState.inventory[stage] = {};
                }

                const stageInventory = appState.inventory[stage];
                const totalBags = Object.values(stageInventory).reduce((sum, bags) => {
                    const qty = parseFloat(bags) || 0;
                    return sum + qty;
                }, 0);

                const safeStage = stage.replace(/'/g, "\\'");
                const entriesHtml = Object.entries(stageInventory)
                    .filter(([size, bags]) => (parseFloat(bags) || 0) > 0)
                    .map(([size, bags]) => {
                        const label = getSizeLabel(size);
                        const safeSize = size.replace(/'/g, "\\'");
                        return `
                            <div class="inventory-size-row">
                                <div>
                                    <p class="inventory-size-name">${label}</p>
                                    <span class="inventory-size-count">${bags} bags</span>
                                </div>
                                <div class="inventory-qty-actions">
                                    <button class="inventory-qty-btn inventory-qty-btn--add" onclick="editInventory('${safeStage}', '${safeSize}', 'add')">+</button>
                                    <button class="inventory-qty-btn inventory-qty-btn--remove" onclick="editInventory('${safeStage}', '${safeSize}', 'remove')"></button>
                                </div>
                            </div>
                        `;
                    }).join('') || '<div class="inventory-size-row inventory-size-row--empty">No inventory</div>';

                const stageId = stage.replace(/\s+/g, '-');

                const stageCard = document.createElement('div');
                stageCard.className = 'inventory-stage-card';
                const safeStageName = safeStage;
                const stageLabel = INVENTORY_STAGE_LABELS[stage] || stage;
                stageCard.innerHTML = `
                    <div class="inventory-stage-header">
                        <div>
                            <p class="inventory-stage-title">${stageLabel}</p>
                            <span class="inventory-stage-meta">${totalBags} bags</span>
                        </div>
                    </div>
                    <div class="inventory-size-list">
                        ${entriesHtml}
                    </div>
                    <div class="inventory-stage-add">
                        <h4>Add New Inventory to ${stageLabel}</h4>
                        <div class="inventory-stage-add-form">
                            <input type="text" list="sizeOptionsList" id="add-size-${stageId}" placeholder="Start typing size">
                            <input type="number" id="add-bags-${stageId}" placeholder="Bags" min="1">
                            <button onclick="addToInventory('${safeStageName}')">Add</button>
                        </div>
                    </div>
                `;
                container.appendChild(stageCard);
            });
        }

        // Filter inventory by size search
        function filterInventoryBySize(searchTerm) {
            const searchValue = searchTerm.toLowerCase().trim();
            const container = document.getElementById('inventory-grid');
            const searchInfo = document.getElementById('inventory-search-info');

            if (!searchValue) {
                // Clear search - show all
                renderInventoryTab();
                if (searchInfo) searchInfo.style.display = 'none';
                return;
            }

            container.innerHTML = '';
            let totalFoundBags = 0;

            // Search across all stages
            Object.keys(appState.inventory).forEach(stage => {
                let inventoryHTML = '';
                let stageTotalBags = 0;
                let stageHasItems = false;

                // For each size in this stage
                Object.entries(appState.inventory[stage]).forEach(([size, totalBags]) => {
                    const label = getSizeLabel(size);
                    // Check if size matches search term
                    if (label.toLowerCase().includes(searchValue) && totalBags > 0) {
                        stageHasItems = true;

                        // Special handling for Finished Goods - show individual bags
                        if (stage === 'Finished Goods') {
                            const remarks = appState.packingRemarks && appState.packingRemarks['Finished Goods'] || {};
                            const sizeRemarks = remarks[size] || [];

                            // Show bags with remarks
                            sizeRemarks.forEach((bagData, index) => {
                                const remark = bagData.remarks || 'No remarks';
                                const timestamp = bagData.timestamp || 'N/A';
                                inventoryHTML += `
                    <div class="inventory-item" style = "display: flex; justify-content: space-between; align-items: flex-start; padding: 12px; border-bottom: 1px solid #eee; background: #f0f9ff; border-radius: 4px; margin-bottom: 8px; border-left: 4px solid #2da3b8;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; color: var(--color-primary); margin-bottom: 4px;">Bag #${totalFoundBags + 1} - ${label}</div>
                                            <div style="font-size: 13px; color: #666; margin-bottom: 3px;">Packets: ${remark}</div>
                                            <div style="font-size: 11px; color: #999;">${timestamp}</div>
                                        </div>
                                        <span class="inventory-bags" style="padding: 6px 12px; background: #e3f2fd; border-radius: 4px; font-weight: bold; white-space: nowrap; margin-left: 10px;">1 bag</span>
                                    </div>
                    `;
                                totalFoundBags++;
                                stageTotalBags++;
                            });

                            // Show bags without remarks
                            const bagsWithoutRemarks = totalBags - sizeRemarks.length;
                            if (bagsWithoutRemarks > 0) {
                                for (let i = 0; i < bagsWithoutRemarks; i++) {
                                    inventoryHTML += `
                    <div class="inventory-item" style = "display: flex; justify-content: space-between; align-items: flex-start; padding: 12px; border-bottom: 1px solid #eee; background: #fff3e0; border-radius: 4px; margin-bottom: 8px; border-left: 4px solid #ff9800;">
                                            <div style="flex: 1;">
                                            <div style="font-weight: bold; color: #ff9800; margin-bottom: 4px;">Bag #${totalFoundBags + 1} - ${label}</div>
                                                <div style="font-size: 13px; color: #999; font-style: italic;">No remarks added</div>
                                                <div style="font-size: 11px; color: #bbb;">Pending remarks entry</div>
                                            </div>
                                            <span class="inventory-bags" style="padding: 6px 12px; background: #ffe0b2; border-radius: 4px; font-weight: bold; white-space: nowrap; margin-left: 10px;">1 bag</span>
                                        </div>
                    `;
                                    totalFoundBags++;
                                    stageTotalBags++;
                                }
                            }
                        } else {
                            // For other stages - show summary by size
                            inventoryHTML += `
                                <div class="inventory-size-row">
                                    <div>
                                        <p class="inventory-size-name">${label}</p>
                                        <span class="inventory-size-count">${totalBags} bags</span>
                                    </div>
                                </div>
                            `;
                            totalFoundBags += totalBags;
                            stageTotalBags += totalBags;
                        }
                    }
                });

                // Only add stage card if it has matching items
                if (stageHasItems) {
                    const stageCard = document.createElement('div');
                    stageCard.className = 'inventory-stage-card';
                    const stageLabel = INVENTORY_STAGE_LABELS[stage] || stage;
                    stageCard.innerHTML = `
                        <div class="inventory-stage-header">
                            <div>
                                <p class="inventory-stage-title">${stageLabel}</p>
                                <span class="inventory-stage-meta">${stageTotalBags} bags</span>
                            </div>
                        </div>
                        <div class="inventory-size-list">${inventoryHTML}</div>
                    `;
                    container.appendChild(stageCard);
                }
            });

            // Show search info
            if (searchInfo) {
                if (totalFoundBags > 0) {
                    searchInfo.innerHTML = `<strong> Found ${totalFoundBags} bags of "${searchTerm}" across all stages</strong> `;
                    searchInfo.style.display = 'block';
                } else {
                    searchInfo.innerHTML = `<strong style = "color: #f44336;"> No bags found for "${searchTerm}"</strong> `;
                    searchInfo.style.display = 'block';
                    container.innerHTML = '<div style="color: var(--color-text-secondary); font-style: italic; padding: var(--space-24); text-align: center;">No results found for this size</div>';
                }
            }
        }

        // Clear inventory search
        function clearInventorySearch() {
            const searchInput = document.getElementById('inventory-search');
            if (searchInput) {
                searchInput.value = '';
                filterInventoryBySize('');
            }
            const tableInput = document.getElementById('inventorySearchInput');
            if (tableInput) {
                tableInput.value = '';
            }
        }

        function editInventory(stage, size, action) {
            const sizeKey = getInventorySizeKey(size);
            if (!appState.inventory[stage] || typeof appState.inventory[stage][sizeKey] === 'undefined') {
                alert(' Selected inventory entry was not found. Please refresh and try again.');
                return;
            }
            const currentAmount = appState.inventory[stage][sizeKey] || 0;
            const sizeLabel = getSizeLabel(size);

            let bags;
            if (action === 'add') {
                bags = parseInt(prompt(`How many bags of ${sizeLabel} to ADD to ${stage}?\nCurrent: ${currentAmount} bags`, '1'));
                if (!bags || isNaN(bags) || bags <= 0) {
                    alert(' Please enter a valid positive number');
                    return;
                }
                appState.inventory[stage][sizeKey] = currentAmount + bags;
                alert(` Added ${bags} bags of ${sizeLabel} to ${stage} \nNew total: ${appState.inventory[stage][sizeKey]} bags`);
            } else if (action === 'remove') {
                bags = parseInt(prompt(`How many bags of ${sizeLabel} to REMOVE from ${stage}?\nCurrent: ${currentAmount} bags`, '1'));
                if (!bags || isNaN(bags) || bags <= 0) {
                    alert(' Please enter a valid positive number');
                    return;
                }
                if (bags > currentAmount) {
                    alert(` Cannot remove ${bags} bags.Only ${currentAmount} bags available.`);
                    return;
                }
                appState.inventory[stage][sizeKey] = currentAmount - bags;
                alert(` Removed ${bags} bags of ${sizeLabel} from ${stage} \nRemaining: ${appState.inventory[stage][sizeKey]} bags`);
            }

            // **REAL-TIME DB UPDATE**: Save changes to Firebase
            fbPut('appState', 'appState', appState);
            const actionLabel = action === 'add' ? 'Added' : 'Removed';
            recordActionLog('Inventory Update', `${actionLabel} ${bags} bags of ${sizeLabel} in ${stage}`, { stage, size: sizeLabel, bags, action });

            // Refresh display
            renderInventoryTab();
        }

        function addToInventory(stage) {
            const stageId = stage.replace(/\s+/g, '-');
            const sizeSelect = document.getElementById(`add-size-${stageId}`);
            const bagsInput = document.getElementById(`add-bags-${stageId}`);

            if (!sizeSelect || !bagsInput) {
                console.error('Add inventory inputs missing for stage', stage, stageId);
                alert('Unable to find the inputs for this stage. Please reload and try again.');
                return;
            }

            const sizeEntry = sizeSelect.value.trim();
            if (!sizeEntry) {
                alert(' Please select a size.');
                return;
            }
            const sizeMatch = findSizeByLabel(sizeEntry);
            const sizeKey = sizeMatch ? getInventorySizeKey(sizeMatch.id) : getInventorySizeKey(sizeEntry);
            const sizeLabel = sizeMatch ? getSizeOptionLabel(sizeMatch) : sizeEntry;
            const bags = parseInt(bagsInput.value);

            if (!bags || isNaN(bags) || bags <= 0) {
                alert(' Please enter a valid positive number of bags');
                return;
            }

            if (!appState.inventory[stage]) {
                appState.inventory[stage] = {};
            }
            if (!appState.inventory[stage][sizeKey]) {
                appState.inventory[stage][sizeKey] = 0;
            }

            appState.inventory[stage][sizeKey] += bags;

            // **REAL-TIME DB UPDATE**: Save changes to Firebase
            fbPut('appState', 'appState', appState);

            alert(` Added ${bags} bags of ${sizeLabel} to ${stage} \nNew total: ${appState.inventory[stage][sizeKey]} bags`);
            recordActionLog('Inventory Update', `Added ${bags} bags of ${sizeLabel} to ${stage}`, { stage, size: sizeLabel, bags });

            // Clear input
            bagsInput.value = '';

            // Refresh display
            renderInventoryTab();
        }

    </script>
</body>

</html>
